import {expect, jest, test, describe, beforeEach, afterEach} from '@jest/globals';

import {
  Typewriter,
  TypewriterBlinkAfterError,
  TypewriterDelayError,
  TypewriterEvent,
  TypewriterEventType,
  TypewriterRepeatError,
  TypewriterRepeatDelayError,
  TypewriterCursorOutOfBoundsError,
  TypewriterCursorConfig,
  TypewriterAction,
  TypewriterCursorNotAtSelectionEdgeError,
  TypewriterCursorSelectionOutOfBoundsError,
  TypewriterCursorSelectionInvalidRangeError,
  typewriterFromSentences,
  TypewriterCursor,
  TypewriterActionUnknownCursorError,
} from '../src/Typewriter';
import {
  typewriterActionTypeBackspace,
  typewriterActionTypeClearAll,
  typewriterActionTypeLeft,
  typewriterActionTypeRight,
  typewriterActionTypeSelectLeft,
  typewriterActionTypeSelectRight,
} from '../src/Typewriter/keys';

import { licenseChecker } from '../src/license';

import { UnsubscribeFunction } from '../src/generic/types';

describe('Typewriter', () => {
  let unsubscribe: UnsubscribeFunction | null = null;

  beforeEach(() => {
    jest.useFakeTimers();

    licenseChecker.activateLicense('fake-100', { logLicenseActivated: false });

    if (unsubscribe) {
      unsubscribe();
    }
  });

  afterEach(() => {
    if (unsubscribe) {
      unsubscribe();
    }
  });

  function autoSubscribe(typewriter: Typewriter<any>) {
    const subscriber = jest.fn();
    unsubscribe = typewriter.subscribe(subscriber);

    return subscriber;
  }

  test('imports', () => {
    expect(TypewriterCursor).toBeDefined();
  });

  describe('constructor', () => {
    describe('errors', () => {
      describe('blinkAfter errors', () => {
        test('cannot be less than zero', () => {
          expect(() => {
            new Typewriter<string>({ blinkAfter: -1 });
          }).toThrowError(
            'uiloos > Typewriter > blinkAfter cannot be negative or zero'
          );

          expect(() => {
            new Typewriter<string>({ blinkAfter: -1 });
          }).toThrowError(TypewriterBlinkAfterError);
        });

        test('cannot be zero', () => {
          expect(() => {
            new Typewriter<string>({ blinkAfter: 0 });
          }).toThrowError(
            'uiloos > Typewriter > blinkAfter cannot be negative or zero'
          );

          expect(() => {
            new Typewriter<string>({ blinkAfter: 0 });
          }).toThrowError(TypewriterBlinkAfterError);
        });
      });

      describe('delay errors', () => {
        test('cannot be less than zero', () => {
          expect(() => {
            new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: -1,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > delay cannot be negative or zero'
          );

          expect(() => {
            new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: -1,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          // Middle of array
          expect(() => {
            new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: -1,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 100,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          // End of array
          expect(() => {
            new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: -1,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);
        });

        test('cannot be zero', () => {
          expect(() => {
            new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 0,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > delay cannot be negative or zero'
          );

          expect(() => {
            new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 0,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          // Middle of array
          expect(() => {
            new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 0,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 100,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          // End of array
          expect(() => {
            new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 0,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);
        });
      });

      describe('repeat errors', () => {
        test('cannot be less than zero', () => {
          expect(() => {
            new Typewriter<string>({
              repeat: -1,
            });
          }).toThrowError(
            'uiloos > Typewriter > repeat cannot be negative or zero'
          );

          expect(() => {
            new Typewriter<string>({
              repeat: -1,
            });
          }).toThrowError(TypewriterRepeatError);
        });

        test('cannot be zero', () => {
          expect(() => {
            new Typewriter<string>({
              repeat: 0,
            });
          }).toThrowError(
            'uiloos > Typewriter > repeat cannot be negative or zero'
          );

          expect(() => {
            new Typewriter<string>({
              repeat: 0,
            });
          }).toThrowError(TypewriterRepeatError);
        });
      });

      describe('repeatDelay errors', () => {
        test('cannot be less than zero', () => {
          expect(() => {
            new Typewriter<string>({
              repeatDelay: -1,
            });
          }).toThrowError(
            'uiloos > Typewriter > repeatDelay cannot be a negative number'
          );

          expect(() => {
            new Typewriter<string>({
              repeatDelay: -1,
            });
          }).toThrowError(TypewriterRepeatDelayError);
        });
      });

      describe('action cursor unknown errors', () => {
        test('must use known cursor', () => {
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [],
              actions: [
                {
                  type: 'keyboard',
                  cursor: 1,
                  text: 'a',
                  delay: 50,
                },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > action uses an unknown cursor'
          );

          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [],
              actions: [
                {
                  type: 'keyboard',
                  cursor: 1,
                  text: 'a',
                  delay: 50,
                },
              ],
            });
          }).toThrowError(TypewriterActionUnknownCursorError);

          // Now with -1

          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [],
              actions: [
                {
                  type: 'keyboard',
                  cursor: -1,
                  text: 'a',
                  delay: 50,
                },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > action uses an unknown cursor'
          );

          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [],
              actions: [
                {
                  type: 'keyboard',
                  cursor: -1,
                  text: 'a',
                  delay: 50,
                },
              ],
            });
          }).toThrowError(TypewriterActionUnknownCursorError);
        });
      });

      describe('cursor position errors', () => {
        test('cannot be less than zero', () => {
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: -1, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError('uiloos > Typewriter > cursor is out of bounds');

          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: -1, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          // Middle of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                { position: -1, data: undefined },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          // End of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                { position: -1, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);
        });

        test('cannot be more than length of text', () => {
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 4, data: undefined },
                { position: 0, data: undefined },
                { position: 1, data: undefined },
              ],
            });
          }).toThrowError('uiloos > Typewriter > cursor is out of bounds');

          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 4, data: undefined },
                { position: 0, data: undefined },
                { position: 1, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          // Middle of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                { position: 4, data: undefined },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          // End of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                { position: 4, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);
        });
      });

      describe('selection errors', () => {
        test('cursor must be placed on edges of selection', () => {
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 2, end: 3 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > cursor is not placed on edges of selection'
          );

          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 2, end: 3 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorNotAtSelectionEdgeError);

          // Middle of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                {
                  position: 3,
                  data: undefined,
                  selection: { start: 1, end: 2 },
                },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorNotAtSelectionEdgeError);

          // End of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 1, end: 2 },
                },
              ],
            });
          }).toThrowError(TypewriterCursorNotAtSelectionEdgeError);
        });

        test('selection start cannot be less than zero', () => {
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                {
                  position: 3,
                  data: undefined,
                  selection: { start: -1, end: 3 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > cursor selection start is out of bounds'
          );

          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                {
                  position: 3,
                  data: undefined,
                  selection: { start: -1, end: 3 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          // Middle of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                {
                  position: 3,
                  data: undefined,
                  selection: { start: -1, end: 3 },
                },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          // End of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                {
                  position: 1,
                  data: undefined,
                  selection: { start: -1, end: 1 },
                },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);
        });

        test('selection end cannot be more than length of text', () => {
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 0, end: 4 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > cursor selection end is out of bounds'
          );

          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 0, end: 4 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          // Middle of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                {
                  position: 3,
                  data: undefined,
                  selection: { start: 3, end: 4 },
                },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          // End of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 0, end: 4 },
                },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);
        });

        test('selection start must be before end', () => {
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                {
                  position: 1,
                  data: undefined,
                  selection: { start: 2, end: 1 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > cursors selection has an invalid range: start is equal or larger than the end'
          );

          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                {
                  position: 1,
                  data: undefined,
                  selection: { start: 2, end: 1 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionInvalidRangeError);

          // Middle of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                {
                  position: 1,
                  data: undefined,
                  selection: { start: 3, end: 1 },
                },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionInvalidRangeError);

          // End of array
          expect(() => {
            new Typewriter<string>({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                {
                  position: 2,
                  data: undefined,
                  selection: { start: 3, end: 2 },
                },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionInvalidRangeError);
        });
      });
    });

    test('with a config it should initialize with configured values', () => {
      const typewriter: Typewriter<string> = new Typewriter<string>({
        text: 'aap',
        blinkAfter: 1337,
        actions: [
          { type: 'keyboard', text: 'a', delay: 999, cursor: 0 },

          { type: 'keyboard', text: 'a', delay: 999, cursor: 2 },

          { type: 'keyboard', text: 'a', delay: 999, cursor: 1 },

          { type: 'keyboard', text: 'b', delay: 999, cursor: 0 },

          { type: 'keyboard', text: 'b', delay: 999, cursor: 2 },

          { type: 'keyboard', text: 'b', delay: 999, cursor: 1 },

          { type: 'keyboard', text: 'c', delay: 999, cursor: 0 },

          { type: 'keyboard', text: 'c', delay: 999, cursor: 2 },

          { type: 'keyboard', text: 'c', delay: 999, cursor: 1 },
        ],
        keepHistoryFor: 1,
        repeat: 1337,
        repeatDelay: 666,
        cursors: [
          { position: 0, data: 'Tosca' },
          { position: 1, data: 'Owen' },
          { position: 0, data: 'Jane' },
        ],
      });

      const subscriber = jest.fn();
      unsubscribe = typewriter.subscribe(subscriber);

      assertState(typewriter, {
        history: [
          // @ts-expect-error objectContaining works
          expect.objectContaining({
            type: 'INITIALIZED',
          }),
        ],
        actions: [
          { type: 'keyboard', text: 'a', delay: 999, cursor: 0 },

          { type: 'keyboard', text: 'a', delay: 999, cursor: 2 },

          { type: 'keyboard', text: 'a', delay: 999, cursor: 1 },

          { type: 'keyboard', text: 'b', delay: 999, cursor: 0 },

          { type: 'keyboard', text: 'b', delay: 999, cursor: 2 },

          { type: 'keyboard', text: 'b', delay: 999, cursor: 1 },

          { type: 'keyboard', text: 'c', delay: 999, cursor: 0 },

          { type: 'keyboard', text: 'c', delay: 999, cursor: 2 },

          { type: 'keyboard', text: 'c', delay: 999, cursor: 1 },
        ],
        cursors: [
          { position: 0, data: 'Tosca', isBlinking: true },
          { position: 1, data: 'Owen', isBlinking: true },
          { position: 0, data: 'Jane', isBlinking: true },
        ],
        text: 'aap',
        blinkAfter: 1337,
        isPlaying: true,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: 1337,
        repeatDelay: 666,
        lastPerformedAction: null,
      });

      expect(subscriber).toHaveBeenCalledTimes(0);
    });

    test('cursor should start at end of text by default', () => {
      const typewriter: Typewriter<string> = new Typewriter<string>({
        text: 'aap',
      });

      const subscriber = jest.fn();
      unsubscribe = typewriter.subscribe(subscriber);

      expect(typewriter.cursors.length).toBe(1);
      assertCursor(typewriter.cursors[0], {
        position: 3,
        data: undefined,
        isBlinking: true,
      });

      expect(subscriber).toHaveBeenCalledTimes(0);
    });

    test('cursors can have any data type but can also still be undefined', () => {
      const typewriter = new Typewriter<{ name: string; color: string }>({
        text: 'aap',
        cursors: [
          {
            position: 3,
          },
          {
            position: 3,
            data: {
              name: 'Owen',
              color: 'red',
            },
          },
        ],
      });

      expect(typewriter.cursors.length).toBe(2);
      expect(typewriter.cursors[0].data).toBe(undefined);
      expect(typewriter.cursors[1].data).toEqual({
        name: 'Owen',
        color: 'red',
      });
    });

    test('without a config it should be empty', () => {
      const typewriter: Typewriter<string> = new Typewriter<string>();

      const subscriber = jest.fn();
      unsubscribe = typewriter.subscribe(subscriber);

      assertState(typewriter, {
        history: [],
        actions: [],
        cursors: [{ position: 0, data: undefined, isBlinking: true }],
        text: '',
        blinkAfter: 250,
        isPlaying: false,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: false,
        repeatDelay: 0,
        lastPerformedAction: null,
      });

      expect(subscriber).toHaveBeenCalledTimes(0);
    });

    test('with initial subscriber', () => {
      const subscriber = jest.fn();
      const typewriter = new Typewriter<string>({}, subscriber);

      unsubscribe = () => {
        typewriter.unsubscribe(subscriber);
      };

      assertState(typewriter, {
        history: [],
        actions: [],
        cursors: [{ position: 0, data: undefined, isBlinking: true }],
        text: '',
        blinkAfter: 250,
        isPlaying: false,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: false,
        repeatDelay: 0,
        lastPerformedAction: null,
      });

      expect(subscriber).toHaveBeenCalledTimes(1);
      expect(subscriber).toHaveBeenCalledWith(
        typewriter,
        expect.objectContaining({
          type: 'INITIALIZED',
        })
      );
    });

    test('without config but with initial subscriber', () => {
      const subscriber = jest.fn();
      const typewriter = new Typewriter<string>(undefined, subscriber);

      unsubscribe = () => {
        typewriter.unsubscribe(subscriber);
      };

      assertState(typewriter, {
        history: [],
        actions: [],
        cursors: [{ position: 0, data: undefined, isBlinking: true }],
        text: '',
        blinkAfter: 250,
        isPlaying: false,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: false,
        repeatDelay: 0,
        lastPerformedAction: null,
      });

      expect(subscriber).toHaveBeenCalledTimes(1);
      expect(subscriber).toHaveBeenCalledWith(
        typewriter,
        expect.objectContaining({
          type: 'INITIALIZED',
        })
      );
    });
  });

  describe('initialize', () => {
    describe('errors', () => {
      describe('blinkAfter errors', () => {
        test('cannot be less than zero', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({ blinkAfter: -1 });
          }).toThrowError(
            'uiloos > Typewriter > blinkAfter cannot be negative or zero'
          );

          expect(() => {
            typewriter.initialize({ blinkAfter: -1 });
          }).toThrowError(TypewriterBlinkAfterError);

          expect(subscriber).toBeCalledTimes(0);
        });

        test('cannot be zero', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({ blinkAfter: 0 });
          }).toThrowError(
            'uiloos > Typewriter > blinkAfter cannot be negative or zero'
          );

          expect(() => {
            typewriter.initialize({ blinkAfter: 0 });
          }).toThrowError(TypewriterBlinkAfterError);

          expect(subscriber).toBeCalledTimes(0);
        });
      });

      describe('delay errors', () => {
        test('cannot be less than zero', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: -1,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > delay cannot be negative or zero'
          );

          expect(() => {
            typewriter.initialize({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: -1,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          // Middle of array
          expect(() => {
            typewriter.initialize({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: -1,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 100,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          // End of array
          expect(() => {
            typewriter.initialize({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: -1,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          expect(subscriber).toBeCalledTimes(0);
        });

        test('cannot be zero', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 0,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > delay cannot be negative or zero'
          );

          expect(() => {
            typewriter.initialize({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 0,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          // Middle of array
          expect(() => {
            typewriter.initialize({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 0,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 100,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          // End of array
          expect(() => {
            typewriter.initialize({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 0,
                  cursor: 0,
                },
              ],
            });
          }).toThrowError(TypewriterDelayError);

          expect(subscriber).toBeCalledTimes(0);
        });
      });

      describe('repeat errors', () => {
        test('cannot be less than zero', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              repeat: -1,
            });
          }).toThrowError(
            'uiloos > Typewriter > repeat cannot be negative or zero'
          );

          expect(() => {
            typewriter.initialize({
              repeat: -1,
            });
          }).toThrowError(TypewriterRepeatError);

          expect(subscriber).toBeCalledTimes(0);
        });

        test('cannot be zero', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              repeat: 0,
            });
          }).toThrowError(
            'uiloos > Typewriter > repeat cannot be negative or zero'
          );

          expect(() => {
            typewriter.initialize({
              repeat: 0,
            });
          }).toThrowError(TypewriterRepeatError);

          expect(subscriber).toBeCalledTimes(0);
        });
      });

      describe('repeatDelay errors', () => {
        test('cannot be less than zero', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              repeatDelay: -1,
            });
          }).toThrowError(
            'uiloos > Typewriter > repeatDelay cannot be a negative number'
          );

          expect(() => {
            typewriter.initialize({
              repeatDelay: -1,
            });
          }).toThrowError(TypewriterRepeatDelayError);

          expect(subscriber).toBeCalledTimes(0);
        });
      });

      describe('action cursor unknown errors', () => {
        test('must use known cursor', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [],
              actions: [
                {
                  type: 'keyboard',
                  cursor: 1,
                  text: 'a',
                  delay: 50,
                },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > action uses an unknown cursor'
          );

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [],
              actions: [
                {
                  type: 'keyboard',
                  cursor: 1,
                  text: 'a',
                  delay: 50,
                },
              ],
            });
          }).toThrowError(TypewriterActionUnknownCursorError);

          // Now with -1

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [],
              actions: [
                {
                  type: 'keyboard',
                  cursor: -1,
                  text: 'a',
                  delay: 50,
                },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > action uses an unknown cursor'
          );

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [],
              actions: [
                {
                  type: 'keyboard',
                  cursor: -1,
                  text: 'a',
                  delay: 50,
                },
              ],
            });
          }).toThrowError(TypewriterActionUnknownCursorError);

          expect(subscriber).toBeCalledTimes(0);
        });
      });

      describe('cursor position errors', () => {
        test('cannot be less than zero', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: -1, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError('uiloos > Typewriter > cursor is out of bounds');

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: -1, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          // Middle of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                { position: -1, data: undefined },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          // End of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                { position: -1, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          expect(subscriber).toBeCalledTimes(0);
        });

        test('cannot be more than length of text', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 4, data: undefined },
                { position: 0, data: undefined },
                { position: 1, data: undefined },
              ],
            });
          }).toThrowError('uiloos > Typewriter > cursor is out of bounds');

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 4, data: undefined },
                { position: 0, data: undefined },
                { position: 1, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          // Middle of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                { position: 4, data: undefined },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          // End of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                { position: 4, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorOutOfBoundsError);

          expect(subscriber).toBeCalledTimes(0);
        });
      });

      describe('selection errors', () => {
        test('cursor must be placed on edges of selection', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 2, end: 3 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > cursor is not placed on edges of selection'
          );

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 2, end: 3 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorNotAtSelectionEdgeError);

          // Middle of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                {
                  position: 3,
                  data: undefined,
                  selection: { start: 1, end: 2 },
                },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorNotAtSelectionEdgeError);

          // End of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 1, end: 2 },
                },
              ],
            });
          }).toThrowError(TypewriterCursorNotAtSelectionEdgeError);

          expect(subscriber).toBeCalledTimes(0);
        });

        test('selection start cannot be less than zero', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                {
                  position: 3,
                  data: undefined,
                  selection: { start: -1, end: 3 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > cursor selection start is out of bounds'
          );

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                {
                  position: 3,
                  data: undefined,
                  selection: { start: -1, end: 3 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          // Middle of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                {
                  position: 3,
                  data: undefined,
                  selection: { start: -1, end: 3 },
                },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          // End of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                {
                  position: 1,
                  data: undefined,
                  selection: { start: -1, end: 1 },
                },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          expect(subscriber).toBeCalledTimes(0);
        });

        test('selection end cannot be more than length of text', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 0, end: 4 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > cursor selection end is out of bounds'
          );

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 0, end: 4 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          // Middle of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                {
                  position: 3,
                  data: undefined,
                  selection: { start: 3, end: 4 },
                },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          // End of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                {
                  position: 0,
                  data: undefined,
                  selection: { start: 0, end: 4 },
                },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionOutOfBoundsError);

          expect(subscriber).toBeCalledTimes(0);
        });

        test('selection start must be before end', () => {
          const typewriter = new Typewriter<string>();
          const subscriber = autoSubscribe(typewriter);

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                {
                  position: 1,
                  data: undefined,
                  selection: { start: 2, end: 1 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(
            'uiloos > Typewriter > cursors selection has an invalid range: start is equal or larger than the end'
          );

          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                {
                  position: 1,
                  data: undefined,
                  selection: { start: 2, end: 1 },
                },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionInvalidRangeError);

          // Middle of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 1, data: undefined },
                {
                  position: 1,
                  data: undefined,
                  selection: { start: 3, end: 1 },
                },
                { position: 2, data: undefined },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionInvalidRangeError);

          // End of array
          expect(() => {
            typewriter.initialize({
              text: 'abc',
              cursors: [
                { position: 2, data: undefined },
                { position: 0, data: undefined },
                {
                  position: 2,
                  data: undefined,
                  selection: { start: 3, end: 2 },
                },
              ],
            });
          }).toThrowError(TypewriterCursorSelectionInvalidRangeError);

          expect(subscriber).toBeCalledTimes(0);
        });
      });
    });

    describe('reset behavior', () => {
      test('that initialize can reset the Typewriter', () => {
        const typewriter: Typewriter<string> = new Typewriter<string>({
          text: 'aap',
          blinkAfter: 1337,
          actions: [{ type: 'keyboard', text: '', delay: 999, cursor: 0 }],
          keepHistoryFor: 1,
        });

        const subscriber = autoSubscribe(typewriter);

        typewriter.initialize({
          keepHistoryFor: 0,
        });

        assertLastSubscriber(
          subscriber,
          {
            history: [],
            actions: [],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 250,
            isPlaying: false,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          },
          {
            type: 'INITIALIZED',
            time: new Date(),
          }
        );
      });

      it('should reset the animation timeout', () => {
        const typewriter: Typewriter<string> = new Typewriter<string>({
          actions: [
            { type: 'keyboard', text: 'a', delay: 100, cursor: 0 },

            { type: 'keyboard', text: 'b', delay: 100, cursor: 0 },
          ],
        });

        jest.advanceTimersByTime(100);

        expect(typewriter.text).toBe('a');

        // Just before the timer hits do an initialize
        typewriter.initialize({});

        // It should not trigger
        jest.advanceTimersByTime(1);
        expect(typewriter.text).toBe('');

        // Not even after a very long time
        jest.advanceTimersByTime(5000);
        expect(typewriter.text).toBe('');
      });

      it('should reset the blinking timeout', () => {
        const typewriter: Typewriter<string> = new Typewriter<string>({
          blinkAfter: 50,
          actions: [
            { type: 'keyboard', text: 'a', delay: 100, cursor: 0 },
            { type: 'keyboard', text: 'b', delay: 100, cursor: 0 },
          ],
        });

        const subscriber = autoSubscribe(typewriter);

        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, []);

        jest.advanceTimersByTime(100);

        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('a');
        assertEvents(subscriber, ['CHANGED']);

        // Move it to just before the blink.
        jest.advanceTimersByTime(49);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('a');
        assertEvents(subscriber, ['CHANGED']);

        // But then hits it with an initialize
        typewriter.initialize({
          actions: [
            { type: 'keyboard', text: 'c', delay: 100, cursor: 0 },
            { type: 'keyboard', text: 'd', delay: 100, cursor: 0 },
          ],
        });
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, ['CHANGED', 'INITIALIZED']);

        // Push it to over the blink if it where still active, nothing
        // should happen.
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, ['CHANGED', 'INITIALIZED']);

        // Check that the next event is 'CHANGED'.
        jest.advanceTimersByTime(99);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('c');
        assertEvents(subscriber, ['CHANGED', 'INITIALIZED', 'CHANGED']);
      });

      it('should reset finished to false', () => {
        const typewriter: Typewriter<string> = new Typewriter<string>({
          blinkAfter: 50,
          actions: [{ type: 'keyboard', text: 'a', delay: 100, cursor: 0 }],
        });

        const subscriber = autoSubscribe(typewriter);

        expect(typewriter.isFinished).toBe(false);
        assertEvents(subscriber, []);

        jest.advanceTimersByTime(100);

        expect(typewriter.isFinished).toBe(true);
        assertEvents(subscriber, ['FINISHED']);

        // Now re-initialize, should set it to false, even with no
        // actions.
        typewriter.initialize({
          actions: [],
        });

        expect(typewriter.isFinished).toBe(false);
        assertEvents(subscriber, ['FINISHED', 'INITIALIZED']);
      });
    });

    describe('autoPlay', () => {
      it('should start playing automatically when there are actions configured and autoPlay is undefined', () => {
        const typewriter = new Typewriter<string>();

        typewriter.initialize({
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 100,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 100,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 100,
              cursor: 0,
            },
          ],
        });

        // After 100 milliseconds it should now be 'a'
        jest.advanceTimersByTime(100);

        expect(typewriter.isPlaying).toBe(true);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('a');
      });

      it('should start playing automatically when there are actions configured and autoPlay is true', () => {
        const typewriter = new Typewriter<string>();

        typewriter.initialize({
          autoPlay: true,
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 100,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 100,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 100,
              cursor: 0,
            },
          ],
        });

        // After 100 milliseconds it should now be 'a'
        jest.advanceTimersByTime(100);

        expect(typewriter.isPlaying).toBe(true);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('a');
      });

      it('should not start playing automatically when there are actions configured and autoPlay is false', () => {
        const typewriter = new Typewriter<string>();

        typewriter.initialize({
          autoPlay: false,
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 100,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 100,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 100,
              cursor: 0,
            },
          ],
        });

        // Should not play even after a long time.
        expect(typewriter.isPlaying).toBe(false);
        jest.advanceTimersByTime(10000);
        expect(typewriter.isPlaying).toBe(false);

        // Now activate it.
        typewriter.play();

        // After 100 milliseconds it should now be 'a'
        jest.advanceTimersByTime(100);

        expect(typewriter.isPlaying).toBe(true);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('a');
      });

      it('should not start playing automatically when there are no actions configured even when autoPlay is true', () => {
        const typewriter = new Typewriter<string>();

        typewriter.initialize({
          autoPlay: true,
          actions: [],
        });

        // Should not play even after a long time.
        expect(typewriter.isPlaying).toBe(false);
        jest.advanceTimersByTime(10000);
        expect(typewriter.isPlaying).toBe(false);

        // Now activate it, should have no effect
        typewriter.play();

        expect(typewriter.isPlaying).toBe(false);
        jest.advanceTimersByTime(10000);
        expect(typewriter.isPlaying).toBe(false);
      });

      it('should not start playing automatically when there are no actions configured and when autoPlay is false', () => {
        const typewriter = new Typewriter<string>();

        typewriter.initialize({
          autoPlay: false,
          actions: [],
        });

        // Should not play even after a long time.
        expect(typewriter.isPlaying).toBe(false);
        jest.advanceTimersByTime(10000);
        expect(typewriter.isPlaying).toBe(false);

        // Now activate it, should have no effect
        typewriter.play();

        expect(typewriter.isPlaying).toBe(false);
        jest.advanceTimersByTime(10000);
        expect(typewriter.isPlaying).toBe(false);
      });
    });
  });

  describe('actions', () => {
    describe('without selection', () => {
      describe('inserting', () => {
        describe('single letter', () => {
          it('should know how to add a letter at the end', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 200,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 300,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 200,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 300,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'a',
                    delay: 100,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'b',
                    delay: 200,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'c',
                    delay: 300,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 1, data: undefined, isBlinking: false }],
                text: 'a',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'CHANGED',
                action: {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );

            jest.advanceTimersByTime(200);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'a',
                    delay: 100,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'b',
                    delay: 200,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'c',
                    delay: 300,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 2, data: undefined, isBlinking: false }],
                text: 'ab',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'b',
                  delay: 200,
                  cursor: 0,
                },
              },
              {
                type: 'CHANGED',
                action: {
                  type: 'keyboard',
                  text: 'b',
                  delay: 200,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );

            jest.advanceTimersByTime(300);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'a',
                    delay: 100,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'b',
                    delay: 200,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'c',
                    delay: 300,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 3, data: undefined, isBlinking: false }],
                text: 'abc',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'c',
                  delay: 300,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'c',
                  delay: 300,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should know how to add a letter in the middle', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'ac',
              cursors: [{ position: 1, data: undefined }],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: true }],
              text: 'ac',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'b',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 2, data: undefined, isBlinking: false }],
                text: 'abc',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'b',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'b',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should know how to add a letter at the start', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'bc',
              cursors: [{ position: 0, data: undefined }],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: 'bc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'a',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 1, data: undefined, isBlinking: false }],
                text: 'abc',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });
        });

        describe('word', () => {
          it('should know how to add a word at the middle', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'aap',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'noot',
                  delay: 200,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'mies',
                  delay: 300,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'aap',
                  delay: 100,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'noot',
                  delay: 200,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'mies',
                  delay: 300,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'aap',
                    delay: 100,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'noot',
                    delay: 200,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'mies',
                    delay: 300,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 3, data: undefined, isBlinking: false }],
                text: 'aap',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'aap',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'CHANGED',
                action: {
                  type: 'keyboard',
                  text: 'aap',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );

            jest.advanceTimersByTime(200);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'aap',
                    delay: 100,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'noot',
                    delay: 200,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'mies',
                    delay: 300,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 7, data: undefined, isBlinking: false }],
                text: 'aapnoot',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'noot',
                  delay: 200,
                  cursor: 0,
                },
              },
              {
                type: 'CHANGED',
                action: {
                  type: 'keyboard',
                  text: 'noot',
                  delay: 200,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );

            jest.advanceTimersByTime(300);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'aap',
                    delay: 100,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'noot',
                    delay: 200,
                    cursor: 0,
                  },
                  {
                    type: 'keyboard',
                    text: 'mies',
                    delay: 300,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 11, data: undefined, isBlinking: false }],
                text: 'aapnootmies',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'mies',
                  delay: 300,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'mies',
                  delay: 300,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should know how to add a word in the middle', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'boot',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'ac',
              cursors: [{ position: 1, data: undefined }],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'boot',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: true }],
              text: 'ac',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'boot',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 5, data: undefined, isBlinking: false }],
                text: 'abootc',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'boot',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'boot',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should know how to add a word at the start', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'aap',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'bc',
              cursors: [{ position: 0, data: undefined }],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'aap',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: 'bc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'aap',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [{ position: 3, data: undefined, isBlinking: false }],
                text: 'aapbc',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'aap',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'aap',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });
        });
      });

      describe('backspace', () => {
        it('should know how to to apply a backspace from the end', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: 'a',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'c',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: 'a',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'c',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'a',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'a',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: 'a',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'b',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'c',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'c',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'c',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'c',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to to apply a backspace from the middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 2, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 2, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'ac',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to to apply a backspace from index 1', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 1, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 1, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'bc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore a backspace from the start and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'zabc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a backspace from the start which is ignored', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to to apply a backspace when using unicode chars such as emoji', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😀',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: '😃',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😀',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: '😃',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😀',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😃',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😀',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😀',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😀',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😀',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😃',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😀',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😃',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😃',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😃',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😃',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😀',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😃',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😀',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😃',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when backspace is the last action start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when backspace is ignored still start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          // The last typewriterActionTypeBackspace should have no effect
          expect(subscriber).toBeCalledTimes(2);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('clear all', () => {
        it('should know how to to apply a clear all and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'Hello world!',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 12, data: undefined, isBlinking: true }],
            text: 'Hello world!',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to to finish on a clear all', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'Hello world!',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 12, data: undefined, isBlinking: true }],
            text: 'Hello world!',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore a clear all when text is already empty', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 1000,
            text: 'a',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 1, data: undefined, isBlinking: true }],
            text: 'a',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          // Clear all should be ignored
          expect(subscriber).toBeCalledTimes(1);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'b',
              blinkAfter: 1000,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should still finish on a clear all when text is already empty and ignored', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when clear all is the last action start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when clear all is ignored still start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          // The last typewriterActionTypeClearAll should have no effect
          expect(subscriber).toBeCalledTimes(2);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('move left', () => {
        it('should know how to move left from the middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 1, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 1, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to move left from the end', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 2, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 2, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore a move left from the start and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'zabc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a move left from the start which is ignored', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when move left is the last action start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when move left is ignored still start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          // The last typewriterActionTypeLeft should have no effect
          expect(subscriber).toBeCalledTimes(2);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('move right', () => {
        it('should know how to move right from the start', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to move right from the middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 1, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 1, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 2, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore a move right from the end and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 3, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 4, data: undefined, isBlinking: false }],
              text: 'abcz',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a move right from the end which is ignored', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 3, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when move right is the last action start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                // Add artificial move left so move right is not an
                // ignored final action.
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when move right is ignored still start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          // The first typewriterActionTypeRight should have no effect
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(1);

          jest.advanceTimersByTime(50);

          // The last typewriterActionTypeRight should also have no effect
          expect(subscriber).toBeCalledTimes(1);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('mouse click', () => {
        it('should know to move the cursor to the position clicked', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 1,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 1,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 1,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 1,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'mouse',
                position: 1,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know to select text on mouse clicked', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 0,
                delay: 100,
                cursor: 0,
                selection: {
                  start: 0,
                  end: 3,
                },
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 0,
                delay: 100,
                cursor: 0,
                selection: {
                  start: 0,
                  end: 3,
                },
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 0,
                  delay: 100,
                  cursor: 0,
                  selection: {
                    start: 0,
                    end: 3,
                  },
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 3 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 0,
                delay: 100,
                cursor: 0,
                selection: {
                  start: 0,
                  end: 3,
                },
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'mouse',
                position: 0,
                delay: 100,
                cursor: 0,
                selection: {
                  start: 0,
                  end: 3,
                },
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore a mouse click on the current position and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 3, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 3,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 4, data: undefined, isBlinking: false }],
              text: 'abcz',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click has a position less than 0 move to 0 instead', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 3, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: -1,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: -1,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'zabc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click has a position less than 0 and the current position is zero ignore the click', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: -1,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'zabc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click has a position larger than the text move to text length instead', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 4,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 4,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 4, data: undefined, isBlinking: false }],
              text: 'abcz',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click has a position larger than the text and the current position is the text length ignore the click', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 3, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 4,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 4, data: undefined, isBlinking: false }],
              text: 'abcz',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a mouse click at the end which is ignored', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 3, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 3,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click is the last action start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 0,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 0,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 0,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click is ignored still start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'mouse',
                position: 1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'mouse',
                position: 1,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'mouse',
                position: 1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'mouse',
                position: 1,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 1,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 1,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          // The first typewriterActionTypeRight should have no effect
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(1);

          jest.advanceTimersByTime(50);

          // The last typewriterActionTypeRight should also have no effect
          expect(subscriber).toBeCalledTimes(1);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 1,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 1,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('select left', () => {
        it('should know how to create a selection to the left from middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 1, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 1, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 1 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to create a selection to the left from the end', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 3, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 2,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 2, end: 3 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore create selection when on the start and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'zabc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a select left from the start which is ignored', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when select left is the last action start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 1 },
                },
              ],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when select left is ignored still start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 1 },
                },
              ],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          // The last typewriterActionTypeSelectLeft should have no effect
          expect(subscriber).toBeCalledTimes(2);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('select right', () => {
        it('should know how to create a selection to the right from middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 1, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 1, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 2,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 1, end: 2 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to create a selection to the right from the start', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 0, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 1,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 1 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore create selection when on the end and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 3, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 4, data: undefined, isBlinking: false }],
              text: 'abcz',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a select right from the end which is ignored', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [{ position: 3, data: undefined }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: undefined, isBlinking: true }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when select right is the last action start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 1,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 1 },
                },
              ],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when select right is ignored still start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: '',
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: undefined, isBlinking: true }],
            text: '',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          // The last typewriterActionTypeSelectRight should have no effect
          expect(subscriber).toBeCalledTimes(1);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: true }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });
    });

    describe('with selection', () => {
      describe('inserting', () => {
        describe('single letter', () => {
          describe('forward selection', () => {
            it('should remove selection and insert the letter in place of the selection, when inserting at the middle', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'this is a nice line',
                cursors: [{ position: 10, selection: { start: 10, end: 14 } }],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    data: undefined,
                    position: 10,
                    selection: { start: 10, end: 14 },
                    isBlinking: true,
                  },
                ],
                text: 'this is a nice line',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(50);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 11,
                      selection: undefined,
                      isBlinking: false,
                    },
                  ],
                  text: 'this is a x line',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });

            it('should remove selection and insert the letter in place of the selection, when inserting at the start', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'this is a nice line',
                cursors: [{ position: 0, selection: { start: 0, end: 4 } }],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    data: undefined,
                    position: 0,
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                ],
                text: 'this is a nice line',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(50);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 1,
                      selection: undefined,
                      isBlinking: false,
                    },
                  ],
                  text: 'x is a nice line',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });

            it('should remove selection and insert the letter in place of the selection, when inserting at the end', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'this is a nice line',
                cursors: [{ position: 15, selection: { start: 15, end: 19 } }],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    data: undefined,
                    position: 15,
                    selection: { start: 15, end: 19 },
                    isBlinking: true,
                  },
                ],
                text: 'this is a nice line',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(50);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 16,
                      selection: undefined,
                      isBlinking: false,
                    },
                  ],
                  text: 'this is a nice x',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });
          });

          describe('backwards selection', () => {
            it('should remove selection and insert the letter in place of the selection, when inserting at the middle', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'this is a nice line',
                cursors: [{ position: 14, selection: { start: 10, end: 14 } }],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    data: undefined,
                    position: 14,
                    selection: { start: 10, end: 14 },
                    isBlinking: true,
                  },
                ],
                text: 'this is a nice line',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(50);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 11,
                      selection: undefined,
                      isBlinking: false,
                    },
                  ],
                  text: 'this is a x line',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });

            it('should remove selection and insert the letter in place of the selection, when inserting at the start', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'this is a nice line',
                cursors: [{ position: 4, selection: { start: 0, end: 4 } }],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    data: undefined,
                    position: 4,
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                ],
                text: 'this is a nice line',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(50);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 1,
                      selection: undefined,
                      isBlinking: false,
                    },
                  ],
                  text: 'x is a nice line',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });

            it('should remove selection and insert the letter in place of the selection, when inserting at the end', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'this is a nice line',
                cursors: [{ position: 19, selection: { start: 15, end: 19 } }],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    data: undefined,
                    position: 19,
                    selection: { start: 15, end: 19 },
                    isBlinking: true,
                  },
                ],
                text: 'this is a nice line',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(50);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 16,
                      selection: undefined,
                      isBlinking: false,
                    },
                  ],
                  text: 'this is a nice x',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 50,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });
          });
        });

        describe('word', () => {
          describe('forward selection', () => {
            describe('inserting more chars than are removed', () => {
              it('should remove selection and insert the word in place of the selection, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 14, selection: { start: 10, end: 14 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 14,
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badguy',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 16,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a badguy line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 4, selection: { start: 0, end: 4 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 4,
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badguy',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 6,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'badguy is a nice line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 19, selection: { start: 15, end: 19 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 19,
                      selection: { start: 15, end: 19 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badguy',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 21,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a nice badguy',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });

            describe("inserting less chars than are removed", ()  => {
              it('should remove selection and insert the word in place of the selection, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 14, selection: { start: 10, end: 14 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 14,
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'bad',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 13,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a bad line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 4, selection: { start: 0, end: 4 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 4,
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'bad',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 3,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'bad is a nice line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 19, selection: { start: 15, end: 19 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 19,
                      selection: { start: 15, end: 19 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'bad',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 18,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a nice bad',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            }); 
            
            describe('inserting the same number of chars that are removed', () => {
              it('should remove selection and insert the word in place of the selection, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 14, selection: { start: 10, end: 14 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 14,
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badd',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 14,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a badd line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 4, selection: { start: 0, end: 4 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 4,
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badd',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 4,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'badd is a nice line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 19, selection: { start: 15, end: 19 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 19,
                      selection: { start: 15, end: 19 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badd',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 19,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a nice badd',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });
          });

          describe('backwards selection', () => {
            describe('inserting more chars than are removed', () => {
              it('should remove selection and insert the word in place of the selection, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 10, selection: { start: 10, end: 14 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 10,
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badguy',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 16,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a badguy line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 0, selection: { start: 0, end: 4 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 0,
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badguy',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 6,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'badguy is a nice line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 15, selection: { start: 15, end: 19 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 15,
                      selection: { start: 15, end: 19 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badguy',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 21,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a nice badguy',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badguy',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });

            describe("inserting less chars than are removed", ()  => {
              it('should remove selection and insert the word in place of the selection, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 10, selection: { start: 10, end: 14 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 10,
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'bad',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 13,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a bad line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 0, selection: { start: 0, end: 4 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 0,
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'bad',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 3,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'bad is a nice line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 15, selection: { start: 15, end: 19 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 15,
                      selection: { start: 15, end: 19 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'bad',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 18,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a nice bad',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'bad',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            }); 
            
            describe('inserting the same number of chars that are removed', () => {
              it('should remove selection and insert the word in place of the selection, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 10, selection: { start: 10, end: 14 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 10,
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badd',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 14,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a badd line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 0, selection: { start: 0, end: 4 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 0,
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badd',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 4,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'badd is a nice line',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
  
              it('should remove selection and insert the word in place of the selection, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'this is a nice line',
                  cursors: [{ position: 15, selection: { start: 15, end: 19 } }],
                });
                const subscriber = autoSubscribe(typewriter);
  
                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      data: undefined,
                      position: 15,
                      selection: { start: 15, end: 19 },
                      isBlinking: true,
                    },
                  ],
                  text: 'this is a nice line',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });
  
                jest.advanceTimersByTime(50);
  
                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'badd',
                        delay: 50,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        data: undefined,
                        position: 19,
                        selection: undefined,
                        isBlinking: false,
                      },
                    ],
                    text: 'this is a nice badd',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'badd',
                      delay: 50,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });
          });
        });
      });

      describe('backspace', () => {
        it('should know how to to apply a backspace from the start of the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'this is a nice line',
            cursors: [{ position: 10, selection: { start: 10, end: 14 } }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 10,
                selection: { start: 10, end: 14 },
                data: undefined,
                isBlinking: true,
              },
            ],
            text: 'this is a nice line',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 10,
                  selection: undefined,
                  data: undefined,
                  isBlinking: false,
                },
              ],
              text: 'this is a  line',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to to apply a backspace from the end of the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'this is a nice line',
            cursors: [{ position: 14, selection: { start: 10, end: 14 } }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 14,
                selection: { start: 10, end: 14 },
                data: undefined,
                isBlinking: true,
              },
            ],
            text: 'this is a nice line',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 10,
                  selection: undefined,
                  data: undefined,
                  isBlinking: false,
                },
              ],
              text: 'this is a  line',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when backspace from a selection is the last action start repeating', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 1000,
            text: 'this is a nice line',
            cursors: [{ position: 0, selection: { start: 0, end: 19 } }],
            repeat: 2,
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                data: undefined,
                position: 0,
                selection: { start: 0, end: 19 },
                isBlinking: true,
              },
            ],
            text: 'this is a nice line',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: 2,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  selection: undefined,
                  data: undefined,
                  isBlinking: false,
                },
              ],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: 2,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  data: undefined,
                  position: 0,
                  selection: { start: 0, end: 19 },
                  isBlinking: true,
                },
              ],
              text: 'this is a nice line',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: 2,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('clear all', () => {
        it('should know how to to apply a clear all and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'Hello world!',
            cursors: [{ position: 6, selection: { start: 6, end: 12 } }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 6,
                data: undefined,
                isBlinking: true,
                selection: { start: 6, end: 12 },
              },
            ],
            text: 'Hello world!',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to to finish on a clear all', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'Hello world!',
            cursors: [{ position: 0, selection: { start: 0, end: 5 } }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 5 },
              },
            ],
            text: 'Hello world!',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore a clear all when text is already empty', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 1000,
            text: 'a',
            cursors: [{ position: 1, selection: { start: 0, end: 1 } }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 1,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 1 },
              },
            ],
            text: 'a',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          // Clear all should be ignored
          expect(subscriber).toBeCalledTimes(1);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'b',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'b',
              blinkAfter: 1000,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when clear all is the last action start repeating, and restore the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: 'Hello world!',
            cursors: [{ position: 5, selection: { start: 0, end: 5 } }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 5,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 5 },
              },
            ],
            text: 'Hello world!',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄 world!',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 5,
                  data: undefined,
                  isBlinking: true,
                  selection: { start: 0, end: 5 },
                },
              ],
              text: 'Hello world!',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when clear all is ignored still start repeating, and restore the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: 'Hello world!',
            cursors: [{ position: 0, selection: { start: 0, end: 5 } }],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 5 },
              },
            ],
            text: 'Hello world!',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄 world!',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          // The last typewriterActionTypeClearAll should have no effect
          expect(subscriber).toBeCalledTimes(2);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeClearAll,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: { start: 0, end: 5 },
                },
              ],
              text: 'Hello world!',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeClearAll,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('move left', () => {
        it('should when the cursor is at the start of the selection, stay on the position, and clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abcd',
            cursors: [
              { position: 1, data: undefined, selection: { start: 1, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 1,
                data: undefined,
                isBlinking: true,
                selection: { start: 1, end: 3 },
              },
            ],
            text: 'abcd',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'abcd',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when the cursor is at the end of the selection, move to the start of the selection, and clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abcd',
            cursors: [
              { position: 3, data: undefined, selection: { start: 1, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 1, end: 3 },
              },
            ],
            text: 'abcd',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'abcd',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should not ignore a move left from the start when there is a selection but should clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 0, data: undefined, selection: { start: 0, end: 2 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 2 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a move left from the start which is ignored, and restore the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 0, data: undefined, selection: { start: 0, end: 1 } },
            ],
            repeat: true,
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 1 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: { start: 0, end: 1 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('move right', () => {
        it('should when the cursor is at the end of the selection, stay on the position, and clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abcd',
            cursors: [
              { position: 3, data: undefined, selection: { start: 1, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 1, end: 3 },
              },
            ],
            text: 'abcd',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abcd',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when the cursor is at the start of the selection, move to the end of the selection, and clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abcd',
            cursors: [
              { position: 1, data: undefined, selection: { start: 1, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 1,
                data: undefined,
                isBlinking: true,
                selection: { start: 1, end: 3 },
              },
            ],
            text: 'abcd',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abcd',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should not ignore a move right from the end when there is a selection but should clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 3, data: undefined, selection: { start: 0, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It not should ignore the action when there is a selection
          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a move right from the end which is ignored, and restore the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 3, data: undefined, selection: { start: 2, end: 3 } },
            ],
            repeat: true,
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 2, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: { start: 2, end: 3 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('mouse click', () => {
        it('should know to move the cursor to the position clicked, and clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 1,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 0, data: undefined, selection: { start: 0, end: 2 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 1,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 2 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 1,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 1,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'mouse',
                position: 1,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore selection when selection is already selected and continue the animation.', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
                selection: {
                  start: 0,
                  end: 3,
                },
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 3, data: undefined, selection: { start: 0, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
                selection: {
                  start: 0,
                  end: 3,
                },
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 3,
                  delay: 50,
                  cursor: 0,
                  selection: {
                    start: 0,
                    end: 3,
                  },
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'z',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should not ignore a mouse click on the current position, if there is a selection, clear it', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 3, data: undefined, selection: { start: 0, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should not ignore the action if there is a selection
          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 3,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'mouse',
                position: 3,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 3,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 4, data: undefined, isBlinking: false }],
              text: 'abcz',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click has a position less than 0 move to 0 instead, and clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 3, data: undefined, selection: { start: 0, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: -1,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: -1,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'zabc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click has a position less than 0 and the current position is zero not ignore the click but clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 0, data: undefined, selection: { start: 0, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It not should ignore the action but clear the selection
          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: -1,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'mouse',
                position: -1,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: -1,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'zabc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click has a position larger than the text move to text length instead, and clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 0, data: undefined, selection: { start: 0, end: 1 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 1 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 4,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 4,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 4, data: undefined, isBlinking: false }],
              text: 'abcz',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click has a position larger than the text and the current position is the text length not ignore the click but clear the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 3, data: undefined, selection: { start: 2, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 2, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should not ignore the action but reset the selection
          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 4,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'mouse',
                position: 4,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'mouse',
                  position: 4,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 4, data: undefined, isBlinking: false }],
              text: 'abcz',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when a mouse click is the last action start repeating, and restore the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: 'abc',
            cursors: [
              { position: 3, data: undefined, selection: { start: 2, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 2, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 0,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 3, data: undefined, isBlinking: false }],
              text: 'ab😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 0,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: 'ab😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'mouse',
                  position: 0,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: { start: 2, end: 3 },
                },
              ],
              text: 'abc',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'mouse',
                position: 0,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('select expand left', () => {
        it('should know how to expand a selection from the end to the middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 2, data: undefined, selection: { start: 2, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 2,
                data: undefined,
                isBlinking: true,
                selection: { start: 2, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 1,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 1, end: 3 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to expand a selection from the middle to the start', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 1, data: undefined, selection: { start: 1, end: 2 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 1,
                data: undefined,
                isBlinking: true,
                selection: { start: 1, end: 2 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 2 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore expand selection when on the start and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 0, data: undefined, selection: { start: 0, end: 2 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 2 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'zc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a expand left from the start which is ignored', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 0, data: undefined, selection: { start: 0, end: 2 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 2 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 2 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when expand left is the last action start repeating, and reset the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: 'abc',
            cursors: [
              { position: 0, data: undefined, selection: { start: 0, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 1 },
                },
              ],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectLeft,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: { start: 0, end: 3 },
                },
              ],
              text: 'abc',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('select expand right', () => {
        it('should know how to expand a selection from the start to the middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 1, data: undefined, selection: { start: 0, end: 1 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 1,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 1 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 2,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 2 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should know how to expand a selection from the middle to the end', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 2, data: undefined, selection: { start: 1, end: 2 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 2,
                data: undefined,
                isBlinking: true,
                selection: { start: 1, end: 2 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 3,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 1, end: 3 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should ignore expand selection when on the end and continue the animation', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 3, data: undefined, selection: { start: 0, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          // It should ignore the action
          jest.advanceTimersByTime(50);
          expect(subscriber).toBeCalledTimes(0);

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: 'z',
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: 'z',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: 'z',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should be able to finish from a expand right from the end which is ignored', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'abc',
            cursors: [
              { position: 3, data: undefined, selection: { start: 0, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 3,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 3 },
                },
              ],
              text: 'abc',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should when expand right is the last action start repeating, and reset the selection', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            ],
            repeat: true,
            blinkAfter: 1000,
            text: 'abc',
            cursors: [
              { position: 0, data: undefined, selection: { start: 0, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: { start: 0, end: 3 },
              },
            ],
            text: 'abc',
            blinkAfter: 1000,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 1, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: '😄',
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [{ position: 0, data: undefined, isBlinking: false }],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeLeft,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 1,
                  data: undefined,
                  isBlinking: false,
                  selection: { start: 0, end: 1 },
                },
              ],
              text: '😄',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'CHANGED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );

          jest.advanceTimersByTime(50);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: '😄',
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeLeft,
                  delay: 50,
                  cursor: 0,
                },
                {
                  type: 'keyboard',
                  text: typewriterActionTypeSelectRight,
                  delay: 50,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: { start: 0, end: 3 },
                },
              ],
              text: 'abc',
              blinkAfter: 1000,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: true,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeSelectRight,
                delay: 50,
                cursor: 0,
              },
            },
            {
              type: 'REPEATING',
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });
    });
  });

  describe('multiple cursors', () => {
    it('should know how to do a basic text animation from start to finish', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 2,
          },
          {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 1,
          },
          {
            type: 'keyboard',
            text: 'e',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
        text: 'hllwrld',
        cursors: [
          { position: 1, data: 'bert' },
          { position: 3, data: 'annie' },
          { position: 4, data: 'hank' },
        ],
      });
      const subscriber = autoSubscribe(typewriter);

      assertState(typewriter, {
        history: [],
        actions: [
          {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 2,
          },
          {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 1,
          },
          {
            type: 'keyboard',
            text: 'e',
            delay: 100,
            cursor: 0,
          },
        ],
        cursors: [
          { position: 1, data: 'bert', isBlinking: true, selection: undefined },
          {
            position: 3,
            data: 'annie',
            isBlinking: true,
            selection: undefined,
          },
          { position: 4, data: 'hank', isBlinking: true, selection: undefined },
        ],
        text: 'hllwrld',
        blinkAfter: 50,
        isPlaying: true,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: false,
        repeatDelay: 0,
        lastPerformedAction: null,
      });

      jest.advanceTimersByTime(100);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'o',
              delay: 100,
              cursor: 2,
            },
            {
              type: 'keyboard',
              text: 'o',
              delay: 100,
              cursor: 1,
            },
            {
              type: 'keyboard',
              text: 'e',
              delay: 100,
              cursor: 0,
            },
          ],
          cursors: [
            {
              position: 1,
              data: 'bert',
              isBlinking: true,
              selection: undefined,
            },
            {
              position: 3,
              data: 'annie',
              isBlinking: true,
              selection: undefined,
            },
            {
              position: 5,
              data: 'hank',
              isBlinking: false,
              selection: undefined,
            },
          ],
          text: 'hllworld',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 2,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 2,
          },
          time: new Date(),
          cursor: typewriter.cursors[2],
        }
      );

      jest.advanceTimersByTime(100);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'o',
              delay: 100,
              cursor: 2,
            },
            {
              type: 'keyboard',
              text: 'o',
              delay: 100,
              cursor: 1,
            },
            {
              type: 'keyboard',
              text: 'e',
              delay: 100,
              cursor: 0,
            },
          ],
          cursors: [
            {
              position: 1,
              data: 'bert',
              isBlinking: true,
              selection: undefined,
            },
            {
              position: 4,
              data: 'annie',
              isBlinking: false,
              selection: undefined,
            },
            {
              position: 6,
              data: 'hank',
              isBlinking: true,
              selection: undefined,
            },
          ],
          text: 'hlloworld',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 1,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 1,
          },
          time: new Date(),
          cursor: typewriter.cursors[1],
        }
      );

      jest.advanceTimersByTime(100);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'o',
              delay: 100,
              cursor: 2,
            },
            {
              type: 'keyboard',
              text: 'o',
              delay: 100,
              cursor: 1,
            },
            {
              type: 'keyboard',
              text: 'e',
              delay: 100,
              cursor: 0,
            },
          ],
          cursors: [
            {
              position: 2,
              data: 'bert',
              isBlinking: false,
              selection: undefined,
            },
            {
              position: 5,
              data: 'annie',
              isBlinking: true,
              selection: undefined,
            },
            {
              position: 7,
              data: 'hank',
              isBlinking: true,
              selection: undefined,
            },
          ],
          text: 'helloworld',
          blinkAfter: 50,
          isPlaying: false,
          isFinished: true,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'e',
            delay: 100,
            cursor: 0,
          },
        },
        {
          type: 'FINISHED',
          action: {
            type: 'keyboard',
            text: 'e',
            delay: 100,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );
    });

    it('should work even if one cursor does more animations than other cursors', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 1,
          },
          {
            type: 'keyboard',
            text: 'w',
            delay: 100,
            cursor: 1,
          },
          {
            type: 'keyboard',
            text: 'e',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
        text: 'hllorld',
        cursors: [
          { position: 1, data: 'john' },
          { position: 3, data: 'sally' },
        ],
      });
      const subscriber = autoSubscribe(typewriter);

      assertState(typewriter, {
        history: [],
        actions: [
          {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 1,
          },
          {
            type: 'keyboard',
            text: 'w',
            delay: 100,
            cursor: 1,
          },
          {
            type: 'keyboard',
            text: 'e',
            delay: 100,
            cursor: 0,
          },
        ],
        cursors: [
          { position: 1, data: 'john', isBlinking: true, selection: undefined },
          {
            position: 3,
            data: 'sally',
            isBlinking: true,
            selection: undefined,
          },
        ],
        text: 'hllorld',
        blinkAfter: 50,
        isPlaying: true,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: false,
        repeatDelay: 0,
        lastPerformedAction: null,
      });

      jest.advanceTimersByTime(100);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'o',
              delay: 100,
              cursor: 1,
            },
            {
              type: 'keyboard',
              text: 'w',
              delay: 100,
              cursor: 1,
            },
            {
              type: 'keyboard',
              text: 'e',
              delay: 100,
              cursor: 0,
            },
          ],
          cursors: [
            {
              position: 1,
              data: 'john',
              isBlinking: true,
              selection: undefined,
            },
            {
              position: 4,
              data: 'sally',
              isBlinking: false,
              selection: undefined,
            },
          ],
          text: 'hlloorld',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 1,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'o',
            delay: 100,
            cursor: 1,
          },
          time: new Date(),
          cursor: typewriter.cursors[1],
        }
      );

      jest.advanceTimersByTime(100);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'o',
              delay: 100,
              cursor: 1,
            },
            {
              type: 'keyboard',
              text: 'w',
              delay: 100,
              cursor: 1,
            },
            {
              type: 'keyboard',
              text: 'e',
              delay: 100,
              cursor: 0,
            },
          ],
          cursors: [
            {
              position: 1,
              data: 'john',
              isBlinking: true,
              selection: undefined,
            },
            {
              position: 5,
              data: 'sally',
              isBlinking: false,
              selection: undefined,
            },
          ],
          text: 'hlloworld',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'w',
            delay: 100,
            cursor: 1,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'w',
            delay: 100,
            cursor: 1,
          },
          time: new Date(),
          cursor: typewriter.cursors[1],
        }
      );

      jest.advanceTimersByTime(100);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'o',
              delay: 100,
              cursor: 1,
            },
            {
              type: 'keyboard',
              text: 'w',
              delay: 100,
              cursor: 1,
            },
            {
              type: 'keyboard',
              text: 'e',
              delay: 100,
              cursor: 0,
            },
          ],
          cursors: [
            {
              position: 2,
              data: 'john',
              isBlinking: false,
              selection: undefined,
            },
            {
              position: 6,
              data: 'sally',
              isBlinking: true,
              selection: undefined,
            },
          ],
          text: 'helloworld',
          blinkAfter: 50,
          isPlaying: false,
          isFinished: true,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'e',
            delay: 100,
            cursor: 0,
          },
        },
        {
          type: 'FINISHED',
          action: {
            type: 'keyboard',
            text: 'e',
            delay: 100,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );
    });

    it('should set all cursors to index 0 when a clear all is performed, and remove all selections', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: typewriterActionTypeClearAll,
            delay: 100,
            cursor: 2,
          },
        ],
        blinkAfter: 50,
        text: 'hllwrld',
        cursors: [
          { position: 0, data: undefined, selection: { start: 0, end: 6 } },
          { position: 4, data: undefined, selection: { start: 3, end: 4 } },
          { position: 5, data: undefined, selection: { start: 5, end: 7 } },
        ],
      });
      const subscriber = autoSubscribe(typewriter);

      assertState(typewriter, {
        history: [],
        actions: [
          {
            type: 'keyboard',
            text: typewriterActionTypeClearAll,
            delay: 100,
            cursor: 2,
          },
        ],
        cursors: [
          {
            position: 0,
            data: undefined,
            selection: { start: 0, end: 6 },
            isBlinking: true,
          },
          {
            position: 4,
            data: undefined,
            selection: { start: 3, end: 4 },
            isBlinking: true,
          },
          {
            position: 5,
            data: undefined,
            selection: { start: 5, end: 7 },
            isBlinking: true,
          },
        ],
        text: 'hllwrld',
        blinkAfter: 50,
        isPlaying: true,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: false,
        repeatDelay: 0,
        lastPerformedAction: null,
      });

      jest.advanceTimersByTime(100);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: typewriterActionTypeClearAll,
              delay: 100,
              cursor: 2,
            },
          ],
          cursors: [
            {
              position: 0,
              data: undefined,
              selection: undefined,
              isBlinking: true,
            },
            {
              position: 0,
              data: undefined,
              selection: undefined,
              isBlinking: true,
            },
            {
              position: 0,
              data: undefined,
              selection: undefined,
              isBlinking: false,
            },
          ],
          text: '',
          blinkAfter: 50,
          isPlaying: false,
          isFinished: true,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: typewriterActionTypeClearAll,
            delay: 100,
            cursor: 2,
          },
        },
        {
          type: 'FINISHED',
          action: {
            type: 'keyboard',
            text: typewriterActionTypeClearAll,
            delay: 100,
            cursor: 2,
          },
          time: new Date(),
          cursor: typewriter.cursors[2],
        }
      );
    });

    describe('backspace is pressed', () => {
      describe('cursor movement', () => {
        it('should do nothing (except blink cursor) when removing from the start, when cursor is already on the start', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'john',
            cursors: [
              { position: 0, data: undefined },

              { position: 2, data: undefined },
              { position: 3, data: undefined },
              { position: 1, data: undefined },
              { position: 0, data: undefined },
              { position: 4, data: undefined },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 2,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 1,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 4,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
            ],
            text: 'john',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: false,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 4,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'john',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should move cursors that are after or on the cursor one place backwards, and cursors that lie before should stay in position, when removing from the middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'john',
            cursors: [
              { position: 2, data: undefined },
              { position: 2, data: undefined },
              { position: 3, data: undefined },
              { position: 1, data: undefined },
              { position: 0, data: undefined },
              { position: 4, data: undefined },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 2,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 2,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 1,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 4,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
            ],
            text: 'john',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 1,
                  data: undefined,
                  isBlinking: false,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'jhn',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should move cursors that are after or on the cursor one place backwards, and cursors that lie before should stay in position, when removing from the end', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'john',
            cursors: [
              { position: 4, data: undefined },
              { position: 2, data: undefined },
              { position: 3, data: undefined },
              { position: 1, data: undefined },
              { position: 0, data: undefined },
              { position: 4, data: undefined },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 4,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 2,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 3,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 1,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 0,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
              {
                position: 4,
                data: undefined,
                isBlinking: true,
                selection: undefined,
              },
            ],
            text: 'john',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 3,
                  data: undefined,
                  isBlinking: false,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'joh',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('deleting cursor has no selection', () => {
        it('should reduce, remove or keep selection of other cursors, when removing from the start', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'aap noot mies',
            cursors: [
              // The cursor that is going to hit backspace, between the first a of aap
              { position: 1, data: undefined },

              // Selects 'a' becomes undefined
              { position: 0, data: 'a', selection: { start: 0, end: 1 } },
              // Selects 'aa', becomes 'a', 0 - 1
              { position: 2, data: 'aa', selection: { start: 0, end: 2 } },
              // Selects 'aap' becomes 'ap', 0 - 2
              { position: 0, data: 'aap', selection: { start: 0, end: 3 } },

              // Selects 'ap', stays 'ap', 0 - 2
              { position: 3, data: 'ap', selection: { start: 1, end: 3 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              { position: 1, data: undefined, isBlinking: true },
              {
                position: 0,
                data: 'a',
                selection: { start: 0, end: 1 },
                isBlinking: true,
              },
              {
                position: 2,
                data: 'aa',
                selection: { start: 0, end: 2 },
                isBlinking: true,
              },
              {
                position: 0,
                data: 'aap',
                selection: { start: 0, end: 3 },
                isBlinking: true,
              },
              {
                position: 3,
                data: 'ap',
                selection: { start: 1, end: 3 },
                isBlinking: true,
              },
            ],
            text: 'aap noot mies',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: undefined,
                  isBlinking: false,
                },
                {
                  position: 0,
                  data: 'a',
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 1,
                  data: 'aa',
                  selection: { start: 0, end: 1 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap',
                  selection: { start: 0, end: 2 },
                  isBlinking: true,
                },
                {
                  position: 2,
                  data: 'ap',
                  selection: { start: 0, end: 2 },
                  isBlinking: true,
                },
              ],
              text: 'ap noot mies',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should reduce, remove or keep selection of other cursors, when removing from the middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'aap noot mies',
            cursors: [
              // The cursor that is going to hit backspace, between the oo's
              { position: 6, data: undefined },

              {
                position: 13,
                data: 'aap noot mies',
                selection: { start: 0, end: 13 },
              },
              // Selects 'aap' stays 'aap', 0 - 3
              { position: 3, data: 'aap', selection: { start: 0, end: 3 } },
              // Selects 'noot', becomes 'not', 4 - 7
              { position: 4, data: 'noot', selection: { start: 4, end: 8 } },
              // Selects 'mies' stays 'mies', 8 - 12
              { position: 13, data: 'mies', selection: { start: 9, end: 13 } },

              // Selects 'p noot', becomes 'p not', 2 - 6
              { position: 2, data: 'p noo', selection: { start: 2, end: 7 } },
              // Selects 'ot mi', stays 'ot mi', 5 - 10
              { position: 11, data: 'ot mi', selection: { start: 6, end: 11 } },
              // Selects 'p no', becomes 'p n', 2 - 5
              { position: 2, data: 'p no', selection: { start: 2, end: 6 } },
              // Selects 'oot m', becomes 'ot m', 5 - 9
              { position: 10, data: 'oot m', selection: { start: 5, end: 10 } },
              // Selects 'aap noot mies', becomes 'aap not mies', 0 - 12

              // Selects 'aap n' stays 'aap n', 0 - 5
              { position: 5, data: 'aap n', selection: { start: 0, end: 5 } },
              // Selects 't mies' stays 't mies', 6 - 12
              { position: 7, data: 't mies', selection: { start: 7, end: 13 } },

              // Selects 'oo', becomes 'o', 5 - 6
              {
                position: 5,
                data: 'oo',
                selection: { start: 5, end: 7 },
              },

              // Selects 'o', becomes undefined
              {
                position: 6,
                data: 'o',
                selection: { start: 5, end: 6 },
              },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 6,
                data: undefined,
                selection: undefined,
                isBlinking: true,
              },
              {
                position: 13,
                data: 'aap noot mies',
                selection: { start: 0, end: 13 },
                isBlinking: true,
              },
              {
                position: 3,
                data: 'aap',
                selection: { start: 0, end: 3 },
                isBlinking: true,
              },
              {
                position: 4,
                data: 'noot',
                selection: { start: 4, end: 8 },
                isBlinking: true,
              },
              {
                position: 13,
                data: 'mies',
                selection: { start: 9, end: 13 },
                isBlinking: true,
              },
              {
                position: 2,
                data: 'p noo',
                selection: { start: 2, end: 7 },
                isBlinking: true,
              },
              {
                position: 11,
                data: 'ot mi',
                selection: { start: 6, end: 11 },
                isBlinking: true,
              },
              {
                position: 2,
                data: 'p no',
                selection: { start: 2, end: 6 },
                isBlinking: true,
              },
              {
                position: 10,
                data: 'oot m',
                selection: { start: 5, end: 10 },
                isBlinking: true,
              },
              {
                position: 5,
                data: 'aap n',
                selection: { start: 0, end: 5 },
                isBlinking: true,
              },
              {
                position: 7,
                data: 't mies',
                selection: { start: 7, end: 13 },
                isBlinking: true,
              },
              {
                position: 5,
                data: 'oo',
                selection: { start: 5, end: 7 },
                isBlinking: true,
              },
              {
                position: 6,
                data: 'o',
                selection: { start: 5, end: 6 },
                isBlinking: true,
              },
            ],
            text: 'aap noot mies',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 5,
                  data: undefined,
                  selection: undefined,
                  isBlinking: false,
                },
                {
                  position: 12,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 4,
                  data: 'noot',
                  selection: { start: 4, end: 7 },
                  isBlinking: true,
                },
                {
                  position: 12,
                  data: 'mies',
                  selection: { start: 8, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 2,
                  data: 'p noo',
                  selection: { start: 2, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 10,
                  data: 'ot mi',
                  selection: { start: 5, end: 10 },
                  isBlinking: true,
                },
                {
                  position: 2,
                  data: 'p no',
                  selection: { start: 2, end: 5 },
                  isBlinking: true,
                },
                {
                  position: 9,
                  data: 'oot m',
                  selection: { start: 5, end: 9 },
                  isBlinking: true,
                },
                {
                  position: 5,
                  data: 'aap n',
                  selection: { start: 0, end: 5 },
                  isBlinking: true,
                },
                {
                  position: 6,
                  data: 't mies',
                  selection: { start: 6, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 5,
                  data: 'oo',
                  selection: { start: 5, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 5,
                  data: 'o',
                  selection: undefined,
                  isBlinking: true,
                },
              ],
              text: 'aap not mies',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should reduce, remove or keep selection of other cursors, when removing from the end', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'aap noot mies',
            cursors: [
              // The cursor that is going to hit backspace, on the last position
              { position: 13, data: undefined },

              // Selects 's' becomes undefined
              { position: 12, data: 's', selection: { start: 12, end: 13 } },
              // Selects 'es', becomes 'e', 11 - 12
              { position: 13, data: 'es', selection: { start: 11, end: 13 } },
              // Selects 'ies' becomes 'ie', 10 - 12
              { position: 10, data: 'ies', selection: { start: 10, end: 13 } },

              // Selects 'mie', stays 'mie', 9 - 12
              { position: 9, data: 'mie', selection: { start: 9, end: 12 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              { position: 13, data: undefined, isBlinking: true },
              {
                position: 12,
                data: 's',
                selection: { start: 12, end: 13 },
                isBlinking: true,
              },
              {
                position: 13,
                data: 'es',
                selection: { start: 11, end: 13 },
                isBlinking: true,
              },
              {
                position: 10,
                data: 'ies',
                selection: { start: 10, end: 13 },
                isBlinking: true,
              },
              {
                position: 9,
                data: 'mie',
                selection: { start: 9, end: 12 },
                isBlinking: true,
              },
            ],
            text: 'aap noot mies',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                // The cursor that is going to hit backspace, on the last position
                {
                  position: 12,
                  data: undefined,
                  selection: undefined,
                  isBlinking: false,
                },
                {
                  position: 12,
                  data: 's',
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 12,
                  data: 'es',
                  selection: { start: 11, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 10,
                  data: 'ies',
                  selection: { start: 10, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 9,
                  data: 'mie',
                  selection: { start: 9, end: 12 },
                  isBlinking: true,
                },
              ],
              text: 'aap noot mie',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });

      describe('deleting cursor has selection', () => {
        it('should reduce, remove or keep selection of other cursors, when removing from the start', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'aap noot mies',
            cursors: [
              // The cursor that is going to hit backspace, selects the aa's
              { position: 0, data: undefined, selection: { start: 0, end: 2 } },

              // Selects 'a' becomes undefined
              { position: 0, data: 'a', selection: { start: 0, end: 1 } },
              // Selects 'aa', becomes undefined
              { position: 2, data: 'aa', selection: { start: 0, end: 2 } },
              // Selects 'aap' becomes 'p', 0 - 1
              { position: 0, data: 'aap', selection: { start: 0, end: 3 } },

              // Selects 'p n', stays 'p n', 0 - 3
              { position: 5, data: 'p n', selection: { start: 2, end: 5 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 0,
                data: undefined,
                selection: { start: 0, end: 2 },
                isBlinking: true,
              },
              {
                position: 0,
                data: 'a',
                selection: { start: 0, end: 1 },
                isBlinking: true,
              },
              {
                position: 2,
                data: 'aa',
                selection: { start: 0, end: 2 },
                isBlinking: true,
              },
              {
                position: 0,
                data: 'aap',
                selection: { start: 0, end: 3 },
                isBlinking: true,
              },
              {
                position: 5,
                data: 'p n',
                selection: { start: 2, end: 5 },
                isBlinking: true,
              },
            ],
            text: 'aap noot mies',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: undefined,
                  isBlinking: false,
                },
                {
                  position: 0,
                  data: 'a',
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aa',
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap',
                  selection: { start: 0, end: 1 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'p n',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
              ],
              text: 'p noot mies',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should reduce, remove or keep selection of other cursors, when removing from the middle', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'aap noot mies',
            cursors: [
              // The cursor that is going to hit backspace, selects the oo's
              { position: 5, data: undefined, selection: { start: 5, end: 7 } },
              // Selects 'aap' stays 'aap', 0 - 3
              { position: 3, data: 'aap', selection: { start: 0, end: 3 } },
              // Selects 'noot', becomes 'nt', 4 - 6
              { position: 4, data: 'noot', selection: { start: 4, end: 8 } },
              // Selects 'mies' stays 'mies', 7 - 11
              { position: 13, data: 'mies', selection: { start: 9, end: 13 } },
              // Selects 'p noot', becomes 'p nt', 2 - 6
              { position: 2, data: 'p noot', selection: { start: 2, end: 8 } },
              // Selects 'ot mi', becomes 't mi', 5 - 9
              { position: 11, data: 'ot mi', selection: { start: 6, end: 11 } },
              // Selects 't mi', stays 't mi', 5 - 9
              { position: 11, data: 't mi', selection: { start: 7, end: 11 } },
              // Selects 'p no', becomes 'p n', 2 - 5
              { position: 2, data: 'p no', selection: { start: 2, end: 6 } },
              // Selects 'oot m', becomes 't m', 5 - 8
              { position: 10, data: 'oot m', selection: { start: 5, end: 10 } },
              // Selects 'p noo', becomes 'p n', 2 - 5
              { position: 7, data: 'p noo', selection: { start: 2, end: 7 } },
              // Selects 'oot m', becomes 't m', 5 - 8
              // Selects 'aap noot mies', becomes 'aap nt mies', 0 - 11
              {
                position: 13,
                data: 'aap noot mies',
                selection: { start: 0, end: 13 },
              },
              // Selects 'noot mies', becomes 'nt mies' 4 - 11
              {
                position: 4,
                data: 'noot mies',
                selection: { start: 4, end: 13 },
              },
              // Selects 'oo', becomes undefined
              {
                position: 5,
                data: 'oo',
                selection: { start: 5, end: 7 },
              },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 5,
                data: undefined,
                selection: { start: 5, end: 7 },
                isBlinking: true,
              },
              {
                position: 3,
                data: 'aap',
                selection: { start: 0, end: 3 },
                isBlinking: true,
              },
              {
                position: 4,
                data: 'noot',
                selection: { start: 4, end: 8 },
                isBlinking: true,
              },
              {
                position: 13,
                data: 'mies',
                selection: { start: 9, end: 13 },
                isBlinking: true,
              },
              {
                position: 2,
                data: 'p noot',
                selection: { start: 2, end: 8 },
                isBlinking: true,
              },
              {
                position: 11,
                data: 'ot mi',
                selection: { start: 6, end: 11 },
                isBlinking: true,
              },
              {
                position: 11,
                data: 't mi',
                selection: { start: 7, end: 11 },
                isBlinking: true,
              },
              {
                position: 2,
                data: 'p no',
                selection: { start: 2, end: 6 },
                isBlinking: true,
              },
              {
                position: 10,
                data: 'oot m',
                selection: { start: 5, end: 10 },
                isBlinking: true,
              },
              {
                position: 7,
                data: 'p noo',
                selection: { start: 2, end: 7 },
                isBlinking: true,
              },
              {
                position: 13,
                data: 'aap noot mies',
                selection: { start: 0, end: 13 },
                isBlinking: true,
              },
              {
                position: 4,
                data: 'noot mies',
                selection: { start: 4, end: 13 },
                isBlinking: true,
              },
              {
                position: 5,
                data: 'oo',
                selection: { start: 5, end: 7 },
                isBlinking: true,
              },
            ],
            text: 'aap noot mies',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 5,
                  data: undefined,
                  selection: undefined,
                  isBlinking: false,
                },
                {
                  position: 3,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 4,
                  data: 'noot',
                  selection: { start: 4, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 11,
                  data: 'mies',
                  selection: { start: 7, end: 11 },
                  isBlinking: true,
                },
                {
                  position: 2,
                  data: 'p noot',
                  selection: { start: 2, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 9,
                  data: 'ot mi',
                  selection: { start: 5, end: 9 },
                  isBlinking: true,
                },
                {
                  position: 9,
                  data: 't mi',
                  selection: { start: 5, end: 9 },
                  isBlinking: true,
                },
                {
                  position: 2,
                  data: 'p no',
                  selection: { start: 2, end: 5 },
                  isBlinking: true,
                },
                {
                  position: 8,
                  data: 'oot m',
                  selection: { start: 5, end: 8 },
                  isBlinking: true,
                },
                {
                  position: 5,
                  data: 'p noo',
                  selection: { start: 2, end: 5 },
                  isBlinking: true,
                },
                {
                  position: 11,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 11 },
                  isBlinking: true,
                },
                {
                  position: 4,
                  data: 'noot mies',
                  selection: { start: 4, end: 11 },
                  isBlinking: true,
                },
                {
                  position: 5,
                  data: 'oo',
                  selection: undefined,
                  isBlinking: true,
                },
              ],
              text: 'aap nt mies',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });

        it('should reduce, remove or keep selection of other cursors, when removing from the end', () => {
          const typewriter = new Typewriter<string>({
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            blinkAfter: 50,
            text: 'aap noot mies',
            cursors: [
              // The cursor that is going to hit backspace, on es
              {
                position: 11,
                data: undefined,
                selection: { start: 11, end: 13 },
              },

              // Selects 's' becomes undefined
              { position: 12, data: 's', selection: { start: 12, end: 13 } },
              // Selects 'es', becomes undefined
              { position: 13, data: 'es', selection: { start: 11, end: 13 } },
              // Selects 'ies' becomes 'i', 10 - 11
              { position: 10, data: 'ies', selection: { start: 10, end: 13 } },
              // Selects 'mie', becomes 'mi', 9 - 11
              { position: 9, data: 'mie', selection: { start: 9, end: 12 } },
              // Selects 'mi', stays 'mi', 9 - 11
              { position: 9, data: 'mi', selection: { start: 9, end: 11 } },
            ],
          });
          const subscriber = autoSubscribe(typewriter);

          assertState(typewriter, {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            ],
            cursors: [
              {
                position: 11,
                data: undefined,
                selection: { start: 11, end: 13 },
                isBlinking: true,
              },
              {
                position: 12,
                data: 's',
                selection: { start: 12, end: 13 },
                isBlinking: true,
              },
              {
                position: 13,
                data: 'es',
                selection: { start: 11, end: 13 },
                isBlinking: true,
              },
              {
                position: 10,
                data: 'ies',
                selection: { start: 10, end: 13 },
                isBlinking: true,
              },
              {
                position: 9,
                data: 'mie',
                selection: { start: 9, end: 12 },
                isBlinking: true,
              },
              {
                position: 9,
                data: 'mi',
                selection: { start: 9, end: 11 },
                isBlinking: true,
              },
            ],
            text: 'aap noot mies',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: false,
            repeatDelay: 0,
            lastPerformedAction: null,
          });

          jest.advanceTimersByTime(100);

          assertLastSubscriber(
            subscriber,
            {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: typewriterActionTypeBackspace,
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                // The cursor that is going to hit backspace, on es
                {
                  position: 11,
                  data: undefined,
                  selection: undefined,
                  isBlinking: false,
                },
                {
                  position: 11,
                  data: 's',
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 11,
                  data: 'es',
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 10,
                  data: 'ies',
                  selection: { start: 10, end: 11 },
                  isBlinking: true,
                },
                {
                  position: 9,
                  data: 'mie',
                  selection: { start: 9, end: 11 },
                  isBlinking: true,
                },
                {
                  position: 9,
                  data: 'mi',
                  selection: { start: 9, end: 11 },
                  isBlinking: true,
                },
              ],
              text: 'aap noot mi',
              blinkAfter: 50,
              isPlaying: false,
              isFinished: true,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
            },
            {
              type: 'FINISHED',
              action: {
                type: 'keyboard',
                text: typewriterActionTypeBackspace,
                delay: 100,
                cursor: 0,
              },
              time: new Date(),
              cursor: typewriter.cursors[0],
            }
          );
        });
      });
    });

    describe('inserting', () => {
      describe('single letter', () => {
        describe('cursor movement', () => {
          it('should move cursors that are before the cursor one place forwards, and cursors that lie before or on should stay in position, when inserting at the start', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'j',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'ohn',
              cursors: [
                { position: 0, data: undefined },

                { position: 0, data: undefined },
                { position: 2, data: undefined },
                { position: 1, data: undefined },
                { position: 3, data: undefined },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'j',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'ohn',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'j',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 1,
                    data: undefined,
                    isBlinking: false,
                    selection: undefined,
                  },
                  {
                    position: 0,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 3,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 2,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 4,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                ],
                text: 'john',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'j',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'j',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should move cursors that are after or on the cursor one place backwards, and cursors that lie before should stay in position, when inserting at the middle', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'john',
              cursors: [
                { position: 2, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
                { position: 1, data: undefined },
                { position: 0, data: undefined },
                { position: 4, data: undefined },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 4,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'john',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 3,
                    data: undefined,
                    isBlinking: false,
                    selection: undefined,
                  },
                  {
                    position: 2,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 4,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 1,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 0,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 5,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                ],
                text: 'joxhn',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should not alter other cursors positions, when inserting at the end', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'john',
              cursors: [
                { position: 4, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
                { position: 1, data: undefined },
                { position: 0, data: undefined },
                { position: 4, data: undefined },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 4,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 4,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'john',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 5,
                    data: undefined,
                    isBlinking: false,
                    selection: undefined,
                  },
                  {
                    position: 2,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 3,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 1,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 0,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 4,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                ],
                text: 'johnx',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should alter other cursors positions, when inserting at the start', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'john',
              cursors: [
                { position: 0, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
                { position: 1, data: undefined },
                { position: 0, data: undefined },
                { position: 4, data: undefined },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 4,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'john',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 1,
                    data: undefined,
                    isBlinking: false,
                    selection: undefined,
                  },
                  {
                    position: 3,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 4,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 2,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 0,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 5,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                ],
                text: 'xjohn',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });
        });

        describe('inserting cursor has no selection', () => {
          it('should increase or keep selection of other cursors, when inserting at the start', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'ap noot mies',
              cursors: [
                // The cursor that is going to insert 'a' at the start
                { position: 0, data: undefined },

                // Selects 'a' becomes 'aa', 0 - 2, pos stays 0
                { position: 0, data: 'a', selection: { start: 0, end: 1 } },
                // Selects 'ap', becomes 'aap', 0 - 3, pos stays 0
                { position: 0, data: 'ap', selection: { start: 0, end: 2 } },
                // Selects 'ap ' becomes 'aap ', 0 - 4, pos stays 0
                { position: 0, data: 'ap ', selection: { start: 0, end: 3 } },

                // Selects 'a' becomes 'aa', 0 - 2, pos becomes 2
                { position: 1, data: 'a', selection: { start: 0, end: 1 } },
                // Selects 'ap', becomes 'aap', 0 - 3, pos becomes 3
                { position: 2, data: 'ap', selection: { start: 0, end: 2 } },
                // Selects 'ap ' becomes 'aap ', 0 - 4, pos becomes 4
                { position: 3, data: 'ap ', selection: { start: 0, end: 3 } },

                // Selects 'p', stays 'p', 2 - 3, pos becomes 2
                { position: 1, data: 'p', selection: { start: 1, end: 2 } },
                // Selects 'p ', stays 'p ', 2 - 4, pos becomes 2
                { position: 1, data: 'p ', selection: { start: 1, end: 3 } },

                // Selects 'p', stays 'p', 2 - 3, pos becomes 3
                { position: 2, data: 'p', selection: { start: 1, end: 2 } },
                // Selects 'p ', stays 'p ', 2 - 4, pos becomes 4
                { position: 3, data: 'p ', selection: { start: 1, end: 3 } },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'a',
                  selection: { start: 0, end: 1 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'ap',
                  selection: { start: 0, end: 2 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'ap ',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 1,
                  data: 'a',
                  selection: { start: 0, end: 1 },
                  isBlinking: true,
                },
                {
                  position: 2,
                  data: 'ap',
                  selection: { start: 0, end: 2 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'ap ',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 1,
                  data: 'p',
                  selection: { start: 1, end: 2 },
                  isBlinking: true,
                },
                {
                  position: 1,
                  data: 'p ',
                  selection: { start: 1, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 2,
                  data: 'p',
                  selection: { start: 1, end: 2 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'p ',
                  selection: { start: 1, end: 3 },
                  isBlinking: true,
                },
              ],
              text: 'ap noot mies',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'a',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 1,
                    data: undefined,
                    selection: undefined,
                    isBlinking: false,
                  },
                  {
                    position: 0,
                    data: 'a',
                    selection: { start: 0, end: 2 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'ap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'ap ',
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'a',
                    selection: { start: 0, end: 2 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'ap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'ap ',
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p',
                    selection: { start: 2, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p ',
                    selection: { start: 2, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'p',
                    selection: { start: 2, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'p ',
                    selection: { start: 2, end: 4 },
                    isBlinking: true,
                  },
                ],
                text: 'aap noot mies',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'a',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should increase or keep selection of other cursors, when inserting at the middle', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'o',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'aap not mies',
              cursors: [
                // The cursor that is going to add a second 'o' in 'not
                { position: 6, data: undefined },

                // Selects 'aap not mies' becomes 'aap noot mies', 0 - 13, pos becomes 13
                {
                  position: 12,
                  data: 'aap not mies',
                  selection: { start: 0, end: 12 },
                },
                // Selects 'aap not mies' becomes 'aap noot mies', 0 - 13, pos stays 0
                {
                  position: 0,
                  data: 'aap not mies',
                  selection: { start: 0, end: 12 },
                },
                // Selects 'aap' stays 'aap', 0 - 3, pos stays 3
                { position: 3, data: 'aap', selection: { start: 0, end: 3 } },
                // Selects 'aap' stays 'aap', 0 - 3, pos stays 0
                { position: 0, data: 'aap', selection: { start: 0, end: 3 } },

                // Selects 'mies' stays 'mies', 9 - 13, pos becomes 13
                {
                  position: 12,
                  data: 'mies',
                  selection: { start: 8, end: 12 },
                },
                // Selects 'mies' stays 'mies', 9 - 13, pos becomes 9
                { position: 8, data: 'mies', selection: { start: 8, end: 12 } },

                // Selects 'not', becomes 'noot', 4 - 8, pos stays 4
                { position: 4, data: 'not', selection: { start: 4, end: 7 } },
                // Selects 'not', becomes 'noot', 4 - 8, pos becomes 8
                { position: 7, data: 'not', selection: { start: 4, end: 7 } },

                // Selects 'no', stays 'no', 4 - 6, pos stays 4
                { position: 4, data: 'no', selection: { start: 4, end: 6 } },
                // Selects 'no', stays 'no', 4 - 6, pos stays 6
                { position: 6, data: 'no', selection: { start: 4, end: 6 } },

                // Selects 'o', stays 'o', 5 - 6, pos stays 5
                { position: 5, data: 'o', selection: { start: 5, end: 6 } },
                // Selects 'o', stays 'o', 5 - 6, pos stays 6
                { position: 6, data: 'o', selection: { start: 5, end: 6 } },

                // Selects 't', becomes 'ot', 6 - 8, pos stays 6
                { position: 6, data: 't', selection: { start: 6, end: 7 } },
                // Selects 't', stays 'ot', 6 - 8, pos becomes 8
                { position: 7, data: 't', selection: { start: 6, end: 7 } },

                // Selects 't ', becomes 'ot ', 6 - 9, pos stays 6
                { position: 6, data: 't ', selection: { start: 6, end: 8 } },
                // Selects 't ', stays 'ot ', 6 - 9, pos becomes 9
                { position: 8, data: 't ', selection: { start: 6, end: 8 } },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'o',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 6,
                  data: undefined,
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 12,
                  data: 'aap not mies',
                  selection: { start: 0, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap not mies',
                  selection: { start: 0, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 12,
                  data: 'mies',
                  selection: { start: 8, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 8,
                  data: 'mies',
                  selection: { start: 8, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 4,
                  data: 'not',
                  selection: { start: 4, end: 7 },
                  isBlinking: true,
                },
                {
                  position: 7,
                  data: 'not',
                  selection: { start: 4, end: 7 },
                  isBlinking: true,
                },
                {
                  position: 4,
                  data: 'no',
                  selection: { start: 4, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 6,
                  data: 'no',
                  selection: { start: 4, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 5,
                  data: 'o',
                  selection: { start: 5, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 6,
                  data: 'o',
                  selection: { start: 5, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 6,
                  data: 't',
                  selection: { start: 6, end: 7 },
                  isBlinking: true,
                },
                {
                  position: 7,
                  data: 't',
                  selection: { start: 6, end: 7 },
                  isBlinking: true,
                },
                {
                  position: 6,
                  data: 't ',
                  selection: { start: 6, end: 8 },
                  isBlinking: true,
                },
                {
                  position: 8,
                  data: 't ',
                  selection: { start: 6, end: 8 },
                  isBlinking: true,
                },
              ],
              text: 'aap not mies',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'o',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 7,
                    data: undefined,
                    selection: undefined,
                    isBlinking: false,
                  },
                  {
                    position: 13,
                    data: 'aap not mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap not mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'not',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'not',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'no',
                    selection: { start: 4, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'no',
                    selection: { start: 4, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'o',
                    selection: { start: 5, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'o',
                    selection: { start: 5, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 't',
                    selection: { start: 6, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 't',
                    selection: { start: 6, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 't ',
                    selection: { start: 6, end: 9 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 't ',
                    selection: { start: 6, end: 9 },
                    isBlinking: true,
                  },
                ],
                text: 'aap noot mies',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'o',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'o',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('keep selection of other cursors, when inserting at the end', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'aap noot mies',
              cursors: [
                // The cursor that is going to add 'x' to the last position.
                { position: 13, data: undefined },

                // All cursors should not be affected
                {
                  position: 13,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 13 },
                },
                {
                  position: 0,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 13 },
                },
                { position: 3, data: 'aap', selection: { start: 0, end: 3 } },
                { position: 0, data: 'aap', selection: { start: 0, end: 3 } },
                {
                  position: 13,
                  data: 'mies',
                  selection: { start: 9, end: 13 },
                },
                { position: 9, data: 'mies', selection: { start: 9, end: 13 } },
                { position: 4, data: 'noot', selection: { start: 4, end: 8 } },
                { position: 8, data: 'noot', selection: { start: 4, end: 8 } },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 13,
                  data: undefined,
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 13,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 13 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 13 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 13,
                  data: 'mies',
                  selection: { start: 9, end: 13 },
                  isBlinking: true,
                },
                {
                  position: 9,
                  data: 'mies',
                  selection: { start: 9, end: 13 },
                  isBlinking: true,
                },
                {
                  position: 4,
                  data: 'noot',
                  selection: { start: 4, end: 8 },
                  isBlinking: true,
                },
                {
                  position: 8,
                  data: 'noot',
                  selection: { start: 4, end: 8 },
                  isBlinking: true,
                },
              ],
              text: 'aap noot mies',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 14,
                    data: undefined,
                    selection: undefined,
                    isBlinking: false,
                  },
                  {
                    position: 13,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                ],
                text: 'aap noot miesx',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'x',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });
        });

        describe('inserting cursor has selection', () => {
          describe('with backward selection', () => {
            it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the start', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'aap noot mies', // x noot mies
                cursors: [
                  // The cursor that is going to insert 'x' at the start, while selecting 'aap'
                  {
                    position: 0,
                    data: undefined,
                    selection: { start: 0, end: 3 },
                  },

                  // Selects 'aap' becomes undefined, pos stays 0
                  {
                    position: 0,
                    data: 'aap-0',
                    selection: { start: 0, end: 3 },
                  },

                  // Selects 'aap' becomes undefined, pos becomes 0
                  {
                    position: 3,
                    data: 'aap-3',
                    selection: { start: 0, end: 3 },
                  },

                  // Selects 'ap' becomes undefined, pos becomes 0
                  {
                    position: 1,
                    data: 'ap-1',
                    selection: { start: 1, end: 3 },
                  },

                  // Selects 'ap' becomes undefined, pos becomes 0
                  {
                    position: 3,
                    data: 'ap-3',
                    selection: { start: 1, end: 3 },
                  },

                  // Selects 'p' becomes undefined, pos becomes 0
                  { position: 2, data: 'p-2', selection: { start: 2, end: 3 } },

                  // Selects 'p' becomes undefined, pos becomes 0
                  { position: 3, data: 'p-3', selection: { start: 2, end: 3 } },

                  // Selects 'aap ' becomes 'x ', 0 - 2 , pos stays 0
                  {
                    position: 0,
                    data: 'aap -0',
                    selection: { start: 0, end: 4 },
                  },

                  // Selects 'aap ' becomes 'x ', 0 - 2 , pos becomes 2
                  {
                    position: 4,
                    data: 'aap -4',
                    selection: { start: 0, end: 4 },
                  },

                  // Selects ' noot' stays 'x noot', 0 - 6 , pos becomes 1
                  {
                    position: 3,
                    data: ' noot-3',
                    selection: { start: 3, end: 8 },
                  },
                  // Selects ' noot' stays 'x noot', 0 - 6 , pos becomes 6
                  {
                    position: 8,
                    data: ' noot-8',
                    selection: { start: 3, end: 8 },
                  },

                  // Selects 'noot' stays 'noot', 2 - 6 , pos becomes 2
                  {
                    position: 4,
                    data: 'noot-4',
                    selection: { start: 4, end: 8 },
                  },

                  // Selects 'noot' stays 'noot', 2 - 6 , pos becomes 6
                  {
                    position: 8,
                    data: 'noot-8',
                    selection: { start: 4, end: 8 },
                  },

                  // All selected positions, become 0
                  {
                    position: 0,
                    data: 'position-0',
                  },
                  {
                    position: 1,
                    data: 'position-1',
                  },
                  {
                    position: 2,
                    data: 'position-2',
                  },
                  {
                    position: 3,
                    data: 'position-3',
                  },
                  // One after, becomes 2
                  {
                    position: 4,
                    data: 'position-4',
                  },
                  // Final position, becomes 11
                  {
                    position: 13,
                    data: 'position-13',
                  },
                ],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 0,
                    data: undefined,
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap-0',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'aap-3',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 1,
                    data: 'ap-1',
                    selection: { start: 1, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'ap-3',
                    selection: { start: 1, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p-2',
                    selection: { start: 2, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'p-3',
                    selection: { start: 2, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap -0',
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'aap -4',
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: ' noot-3',
                    selection: { start: 3, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: ' noot-8',
                    selection: { start: 3, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'noot-4',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'noot-8',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'position-0',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 1,
                    data: 'position-1',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'position-2',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'position-3',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'position-4',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'position-13',
                    selection: undefined,
                    isBlinking: true,
                  },
                ],
                text: 'aap noot mies',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(100);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 1,
                      data: undefined,
                      selection: undefined,
                      isBlinking: false,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'ap-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'ap-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'p-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'p-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 2 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'aap -4',
                      selection: { start: 0, end: 2 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: ' noot-3',
                      selection: { start: 0, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: ' noot-8',
                      selection: { start: 0, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'noot-4',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'noot-8',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      selection: undefined,
                      data: 'position-13',
                      isBlinking: true,
                    },
                  ],
                  text: 'x noot mies',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });

            it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the middle', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'aap noot mies',
                cursors: [
                  // The cursor that is going to add 'x', selects the oo's
                  {
                    position: 5,
                    data: undefined,
                    selection: { start: 5, end: 7 },
                  },
                  // Selects 'aap' stays 'aap', 0 - 3
                  { position: 3, data: 'aap', selection: { start: 0, end: 3 } },
                  { position: 0, data: 'aap', selection: { start: 0, end: 3 } },
                  // Selects 'noot', becomes 'nxt', 4 - 7
                  {
                    position: 8,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                  },
                  {
                    position: 4,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                  },
                  // Selects 'mies' stays 'mies', 8 - 12
                  {
                    position: 13,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                  },
                  {
                    position: 9,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                  },
                  // Selects 'p noot', becomes 'p nxt', 2 - 7
                  {
                    position: 8,
                    data: 'p noot',
                    selection: { start: 2, end: 8 },
                  },
                  {
                    position: 2,
                    data: 'p noot',
                    selection: { start: 2, end: 8 },
                  },
                  // Selects 'ot mi', becomes 'xt mi', 5 - 10
                  {
                    position: 11,
                    data: 'ot mi',
                    selection: { start: 6, end: 11 },
                  },
                  {
                    position: 6,
                    data: 'ot mi',
                    selection: { start: 6, end: 11 },
                  },

                  // Selects 't mi', becomes 'xt mi', 5 - 10
                  {
                    position: 11,
                    data: 't mi',
                    selection: { start: 7, end: 11 },
                  },
                  {
                    position: 7,
                    data: 't mi',
                    selection: { start: 7, end: 11 },
                  },

                  // 'p no' is a bit unexpected as you might think the x will be selected but it is not.
                  // Selects 'p no', becomes 'p n', 2 - 5
                  {
                    position: 6,
                    data: 'p no',
                    selection: { start: 2, end: 6 },
                  },
                  {
                    position: 2,
                    data: 'p no',
                    selection: { start: 2, end: 6 },
                  },

                  // Selects 'oot m', becomes 'xt m', 5 - 9
                  {
                    position: 10,
                    data: 'oot m',
                    selection: { start: 5, end: 10 },
                  },
                  {
                    position: 5,
                    data: 'oot m',
                    selection: { start: 5, end: 10 },
                  },

                  // 'p noo' is a bit unexpected as you might think the x will be selected but it is not.
                  // Selects 'p noo', becomes 'p n', 2 - 5
                  {
                    position: 7,
                    data: 'p noo',
                    selection: { start: 2, end: 7 },
                  },
                  {
                    position: 2,
                    data: 'p noo',
                    selection: { start: 2, end: 7 },
                  },
                  // Selects 'aap noot mies', becomes 'aap nxt mies', 0 - 12
                  {
                    position: 13,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                  },
                  {
                    position: 0,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                  },
                  // Selects 'noot mies', becomes 'nxt mies' 4 - 12
                  {
                    position: 13,
                    data: 'noot mies',
                    selection: { start: 4, end: 13 },
                  },
                  {
                    position: 4,
                    data: 'noot mies',
                    selection: { start: 4, end: 13 },
                  },
                  // Selects 'oo', becomes undefined
                  {
                    position: 7,
                    data: 'oo',
                    selection: { start: 5, end: 7 },
                  },
                  {
                    position: 5,
                    data: 'oo',
                    selection: { start: 5, end: 7 },
                  },

                  // All selected positions, become 5
                  {
                    position: 5,
                    data: 'position-5',
                  },
                  {
                    position: 6,
                    data: 'position-6',
                  },
                  {
                    position: 7,
                    data: 'position-7',
                  },
                  // One before, stays 4
                  {
                    position: 4,
                    data: 'position-4',
                  },
                  // One after, becomes 7
                  {
                    position: 8,
                    data: 'position-8',
                  },
                  // First position, stays 0
                  {
                    position: 0,
                    data: 'position-0',
                  },
                  // Final position, becomes 12
                  {
                    position: 13,
                    data: 'position-13',
                  },
                ],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 5,
                    data: undefined,
                    selection: { start: 5, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'p noot',
                    selection: { start: 2, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p noot',
                    selection: { start: 2, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 'ot mi',
                    selection: { start: 6, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'ot mi',
                    selection: { start: 6, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 't mi',
                    selection: { start: 7, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 7,
                    data: 't mi',
                    selection: { start: 7, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'p no',
                    selection: { start: 2, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p no',
                    selection: { start: 2, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 10,
                    data: 'oot m',
                    selection: { start: 5, end: 10 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'oot m',
                    selection: { start: 5, end: 10 },
                    isBlinking: true,
                  },
                  {
                    position: 7,
                    data: 'p noo',
                    selection: { start: 2, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p noo',
                    selection: { start: 2, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'noot mies',
                    selection: { start: 4, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'noot mies',
                    selection: { start: 4, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 7,
                    data: 'oo',
                    selection: { start: 5, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'oo',
                    selection: { start: 5, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'position-5',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'position-6',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 7,
                    data: 'position-7',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'position-4',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'position-8',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'position-0',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'position-13',
                    selection: undefined,
                    isBlinking: true,
                  },
                ],
                text: 'aap noot mies',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(100);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 6,
                      data: undefined,
                      selection: undefined,
                      isBlinking: false,
                    },
                    {
                      position: 3,
                      data: 'aap',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'noot',
                      selection: { start: 4, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot',
                      selection: { start: 4, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'mies',
                      selection: { start: 8, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'mies',
                      selection: { start: 8, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'p noot',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noot',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ot mi',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'ot mi',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 't mi',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 't mi',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'p no',
                      selection: { start: 2, end: 5 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p no',
                      selection: { start: 2, end: 5 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'oot m',
                      selection: { start: 5, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oot m',
                      selection: { start: 5, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'p noo',
                      selection: { start: 2, end: 5 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noo',
                      selection: { start: 2, end: 5 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'aap noot mies',
                      selection: { start: 0, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap noot mies',
                      selection: { start: 0, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'noot mies',
                      selection: { start: 4, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot mies',
                      selection: { start: 4, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oo',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oo',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-5',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-6',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-7',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'position-8',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap nxt mies',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });

            it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the end', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'aap noot mies',
                cursors: [
                  // The cursor that is going to hit 'x', on es
                  {
                    position: 11,
                    data: undefined,
                    selection: { start: 11, end: 13 },
                  },

                  // Selects 's' becomes undefined, pos 11
                  {
                    position: 12,
                    data: 's',
                    selection: { start: 12, end: 13 },
                  },
                  // Selects 's' becomes undefined, pos 11
                  {
                    position: 13,
                    data: 's',
                    selection: { start: 12, end: 13 },
                  },

                  // Selects 'es', becomes undefined pos 11
                  {
                    position: 11,
                    data: 'es',
                    selection: { start: 11, end: 13 },
                  },
                  // Selects 'es', becomes undefined pos 11
                  {
                    position: 13,
                    data: 'es',
                    selection: { start: 11, end: 13 },
                  },

                  // Selects 'ies' becomes 'i', 10 - 11 pos 10
                  {
                    position: 10,
                    data: 'ies',
                    selection: { start: 10, end: 13 },
                  },
                  // Selects 'ies' becomes 'i', 10 - 11 pos 11
                  {
                    position: 13,
                    data: 'ies',
                    selection: { start: 10, end: 13 },
                  },

                  // Selects 'mie', becomes 'mi', 9 - 11 pos 9
                  {
                    position: 9,
                    data: 'mie',
                    selection: { start: 9, end: 12 },
                  },
                  // Selects 'mie', becomes 'mi', 9 - 11 pos 11
                  {
                    position: 12,
                    data: 'mie',
                    selection: { start: 9, end: 12 },
                  },

                  // Selects 'mi', stays 'mi', 9 - 11 pos 9
                  { position: 9, data: 'mi', selection: { start: 9, end: 11 } },
                  // Selects 'mi', stays 'mi', 9 - 11 pos 11
                  {
                    position: 11,
                    data: 'mi',
                    selection: { start: 9, end: 11 },
                  },

                  // All selected positions, become 11
                  {
                    position: 11,
                    data: 'position-11',
                  },
                  {
                    position: 12,
                    data: 'position-12',
                  },
                  {
                    position: 13,
                    data: 'position-13',
                  },
                  // One before, stays 10
                  {
                    position: 10,
                    data: 'position-10',
                  },
                  // First position, stays 0
                  {
                    position: 0,
                    data: 'position-0',
                  },
                ],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 11,
                    data: undefined,
                    selection: { start: 11, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 12,
                    data: 's',
                    selection: { start: 12, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 's',
                    selection: { start: 12, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 'es',
                    selection: { start: 11, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'es',
                    selection: { start: 11, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 10,
                    data: 'ies',
                    selection: { start: 10, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'ies',
                    selection: { start: 10, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 'mie',
                    selection: { start: 9, end: 12 },
                    isBlinking: true,
                  },
                  {
                    position: 12,
                    data: 'mie',
                    selection: { start: 9, end: 12 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 'mi',
                    selection: { start: 9, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 'mi',
                    selection: { start: 9, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 'position-11',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 12,
                    data: 'position-12',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'position-13',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 10,
                    data: 'position-10',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'position-0',
                    selection: undefined,
                    isBlinking: true,
                  },
                ],
                text: 'aap noot mies',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(100);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 12,
                      data: undefined,
                      selection: undefined,
                      isBlinking: false,
                    },
                    {
                      position: 11,
                      data: 's',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 's',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ies',
                      selection: { start: 10, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'ies',
                      selection: { start: 10, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mie',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mie',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mi',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mi',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-11',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-12',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'position-10',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mix',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });
          });

          describe('with forward selection', () => {
            it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the start', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'aap noot mies', // x noot mies
                cursors: [
                  // The cursor that is going to insert 'x' at the start, while selecting 'aap'
                  {
                    position: 3,
                    data: undefined,
                    selection: { start: 0, end: 3 },
                  },

                  // Selects 'aap' becomes undefined, pos stays 0
                  {
                    position: 0,
                    data: 'aap-0',
                    selection: { start: 0, end: 3 },
                  },

                  // Selects 'aap' becomes undefined, pos becomes 0
                  {
                    position: 3,
                    data: 'aap-3',
                    selection: { start: 0, end: 3 },
                  },

                  // Selects 'ap' becomes undefined, pos becomes 0
                  {
                    position: 1,
                    data: 'ap-1',
                    selection: { start: 1, end: 3 },
                  },

                  // Selects 'ap' becomes undefined, pos becomes 0
                  {
                    position: 3,
                    data: 'ap-3',
                    selection: { start: 1, end: 3 },
                  },

                  // Selects 'p' becomes undefined, pos becomes 0
                  { position: 2, data: 'p-2', selection: { start: 2, end: 3 } },

                  // Selects 'p' becomes undefined, pos becomes 0
                  { position: 3, data: 'p-3', selection: { start: 2, end: 3 } },

                  // Selects 'aap ' becomes 'x ', 0 - 2 , pos stays 0
                  {
                    position: 0,
                    data: 'aap -0',
                    selection: { start: 0, end: 4 },
                  },

                  // Selects 'aap ' becomes 'x ', 0 - 2 , pos becomes 2
                  {
                    position: 4,
                    data: 'aap -4',
                    selection: { start: 0, end: 4 },
                  },

                  // Selects ' noot' stays 'x noot', 0 - 6 , pos becomes 1
                  {
                    position: 3,
                    data: ' noot-3',
                    selection: { start: 3, end: 8 },
                  },
                  // Selects ' noot' stays 'x noot', 0 - 6 , pos becomes 6
                  {
                    position: 8,
                    data: ' noot-8',
                    selection: { start: 3, end: 8 },
                  },

                  // Selects 'noot' stays 'noot', 2 - 6 , pos becomes 2
                  {
                    position: 4,
                    data: 'noot-4',
                    selection: { start: 4, end: 8 },
                  },

                  // Selects 'noot' stays 'noot', 2 - 6 , pos becomes 6
                  {
                    position: 8,
                    data: 'noot-8',
                    selection: { start: 4, end: 8 },
                  },

                  // All selected positions, become 0
                  {
                    position: 0,
                    data: 'position-0',
                  },
                  {
                    position: 1,
                    data: 'position-1',
                  },
                  {
                    position: 2,
                    data: 'position-2',
                  },
                  {
                    position: 3,
                    data: 'position-3',
                  },
                  // One after, becomes 2
                  {
                    position: 4,
                    data: 'position-4',
                  },
                  // Final position, becomes 11
                  {
                    position: 13,
                    data: 'position-13',
                  },
                ],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 3,
                    data: undefined,
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap-0',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'aap-3',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 1,
                    data: 'ap-1',
                    selection: { start: 1, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'ap-3',
                    selection: { start: 1, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p-2',
                    selection: { start: 2, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'p-3',
                    selection: { start: 2, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap -0',
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'aap -4',
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: ' noot-3',
                    selection: { start: 3, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: ' noot-8',
                    selection: { start: 3, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'noot-4',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'noot-8',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'position-0',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 1,
                    data: 'position-1',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'position-2',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'position-3',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'position-4',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'position-13',
                    selection: undefined,
                    isBlinking: true,
                  },
                ],
                text: 'aap noot mies',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(100);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 1,
                      data: undefined,
                      selection: undefined,
                      isBlinking: false,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'ap-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'ap-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'p-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'p-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 2 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'aap -4',
                      selection: { start: 0, end: 2 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: ' noot-3',
                      selection: { start: 0, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: ' noot-8',
                      selection: { start: 0, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'noot-4',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'noot-8',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      selection: undefined,
                      data: 'position-13',
                      isBlinking: true,
                    },
                  ],
                  text: 'x noot mies',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });

            it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the middle', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'aap noot mies',
                cursors: [
                  // The cursor that is going to add 'x', selects the oo's
                  {
                    position: 7,
                    data: undefined,
                    selection: { start: 5, end: 7 },
                  },
                  // Selects 'aap' stays 'aap', 0 - 3
                  { position: 3, data: 'aap', selection: { start: 0, end: 3 } },
                  { position: 0, data: 'aap', selection: { start: 0, end: 3 } },
                  // Selects 'noot', becomes 'nxt', 4 - 7
                  {
                    position: 8,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                  },
                  {
                    position: 4,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                  },
                  // Selects 'mies' stays 'mies', 8 - 12
                  {
                    position: 13,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                  },
                  {
                    position: 9,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                  },
                  // Selects 'p noot', becomes 'p nxt', 2 - 7
                  {
                    position: 8,
                    data: 'p noot',
                    selection: { start: 2, end: 8 },
                  },
                  {
                    position: 2,
                    data: 'p noot',
                    selection: { start: 2, end: 8 },
                  },
                  // Selects 'ot mi', becomes 'xt mi', 5 - 10
                  {
                    position: 11,
                    data: 'ot mi',
                    selection: { start: 6, end: 11 },
                  },
                  {
                    position: 6,
                    data: 'ot mi',
                    selection: { start: 6, end: 11 },
                  },

                  // Selects 't mi', becomes 'xt mi', 5 - 10
                  {
                    position: 11,
                    data: 't mi',
                    selection: { start: 7, end: 11 },
                  },
                  {
                    position: 7,
                    data: 't mi',
                    selection: { start: 7, end: 11 },
                  },

                  // 'p no' is a bit unexpected as you might think the x will be selected but it is not.
                  // Selects 'p no', becomes 'p n', 2 - 5
                  {
                    position: 6,
                    data: 'p no',
                    selection: { start: 2, end: 6 },
                  },
                  {
                    position: 2,
                    data: 'p no',
                    selection: { start: 2, end: 6 },
                  },

                  // Selects 'oot m', becomes 'xt m', 5 - 9
                  {
                    position: 10,
                    data: 'oot m',
                    selection: { start: 5, end: 10 },
                  },
                  {
                    position: 5,
                    data: 'oot m',
                    selection: { start: 5, end: 10 },
                  },

                  // 'p noo' is a bit unexpected as you might think the x will be selected but it is not.
                  // Selects 'p noo', becomes 'p n', 2 - 5
                  {
                    position: 7,
                    data: 'p noo',
                    selection: { start: 2, end: 7 },
                  },
                  {
                    position: 2,
                    data: 'p noo',
                    selection: { start: 2, end: 7 },
                  },
                  // Selects 'aap noot mies', becomes 'aap nxt mies', 0 - 12
                  {
                    position: 13,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                  },
                  {
                    position: 0,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                  },
                  // Selects 'noot mies', becomes 'nxt mies' 4 - 12
                  {
                    position: 13,
                    data: 'noot mies',
                    selection: { start: 4, end: 13 },
                  },
                  {
                    position: 4,
                    data: 'noot mies',
                    selection: { start: 4, end: 13 },
                  },
                  // Selects 'oo', becomes undefined
                  {
                    position: 7,
                    data: 'oo',
                    selection: { start: 5, end: 7 },
                  },
                  {
                    position: 5,
                    data: 'oo',
                    selection: { start: 5, end: 7 },
                  },

                  // All selected positions, become 5
                  {
                    position: 5,
                    data: 'position-5',
                  },
                  {
                    position: 6,
                    data: 'position-6',
                  },
                  {
                    position: 7,
                    data: 'position-7',
                  },
                  // One before, stays 4
                  {
                    position: 4,
                    data: 'position-4',
                  },
                  // One after, becomes 7
                  {
                    position: 8,
                    data: 'position-8',
                  },
                  // First position, stays 0
                  {
                    position: 0,
                    data: 'position-0',
                  },
                  // Final position, becomes 12
                  {
                    position: 13,
                    data: 'position-13',
                  },
                ],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 7,
                    data: undefined,
                    selection: { start: 5, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'p noot',
                    selection: { start: 2, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p noot',
                    selection: { start: 2, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 'ot mi',
                    selection: { start: 6, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'ot mi',
                    selection: { start: 6, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 't mi',
                    selection: { start: 7, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 7,
                    data: 't mi',
                    selection: { start: 7, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'p no',
                    selection: { start: 2, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p no',
                    selection: { start: 2, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 10,
                    data: 'oot m',
                    selection: { start: 5, end: 10 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'oot m',
                    selection: { start: 5, end: 10 },
                    isBlinking: true,
                  },
                  {
                    position: 7,
                    data: 'p noo',
                    selection: { start: 2, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 2,
                    data: 'p noo',
                    selection: { start: 2, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'noot mies',
                    selection: { start: 4, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'noot mies',
                    selection: { start: 4, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 7,
                    data: 'oo',
                    selection: { start: 5, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'oo',
                    selection: { start: 5, end: 7 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'position-5',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'position-6',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 7,
                    data: 'position-7',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'position-4',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'position-8',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'position-0',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'position-13',
                    selection: undefined,
                    isBlinking: true,
                  },
                ],
                text: 'aap noot mies',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(100);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 6,
                      data: undefined,
                      selection: undefined,
                      isBlinking: false,
                    },
                    {
                      position: 3,
                      data: 'aap',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'noot',
                      selection: { start: 4, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot',
                      selection: { start: 4, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'mies',
                      selection: { start: 8, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'mies',
                      selection: { start: 8, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'p noot',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noot',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ot mi',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'ot mi',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 't mi',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 't mi',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'p no',
                      selection: { start: 2, end: 5 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p no',
                      selection: { start: 2, end: 5 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'oot m',
                      selection: { start: 5, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oot m',
                      selection: { start: 5, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'p noo',
                      selection: { start: 2, end: 5 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noo',
                      selection: { start: 2, end: 5 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'aap noot mies',
                      selection: { start: 0, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap noot mies',
                      selection: { start: 0, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'noot mies',
                      selection: { start: 4, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot mies',
                      selection: { start: 4, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oo',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oo',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-5',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-6',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-7',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'position-8',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap nxt mies',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });

            it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the end', () => {
              const typewriter = new Typewriter<string>({
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                blinkAfter: 50,
                text: 'aap noot mies',
                cursors: [
                  // The cursor that is going to hit 'x', on es
                  {
                    position: 13,
                    data: undefined,
                    selection: { start: 11, end: 13 },
                  },

                  // Selects 's' becomes undefined, pos 11
                  {
                    position: 12,
                    data: 's',
                    selection: { start: 12, end: 13 },
                  },
                  // Selects 's' becomes undefined, pos 11
                  {
                    position: 13,
                    data: 's',
                    selection: { start: 12, end: 13 },
                  },

                  // Selects 'es', becomes undefined pos 11
                  {
                    position: 11,
                    data: 'es',
                    selection: { start: 11, end: 13 },
                  },
                  // Selects 'es', becomes undefined pos 11
                  {
                    position: 13,
                    data: 'es',
                    selection: { start: 11, end: 13 },
                  },

                  // Selects 'ies' becomes 'i', 10 - 11 pos 10
                  {
                    position: 10,
                    data: 'ies',
                    selection: { start: 10, end: 13 },
                  },
                  // Selects 'ies' becomes 'i', 10 - 11 pos 11
                  {
                    position: 13,
                    data: 'ies',
                    selection: { start: 10, end: 13 },
                  },

                  // Selects 'mie', becomes 'mi', 9 - 11 pos 9
                  {
                    position: 9,
                    data: 'mie',
                    selection: { start: 9, end: 12 },
                  },
                  // Selects 'mie', becomes 'mi', 9 - 11 pos 11
                  {
                    position: 12,
                    data: 'mie',
                    selection: { start: 9, end: 12 },
                  },

                  // Selects 'mi', stays 'mi', 9 - 11 pos 9
                  { position: 9, data: 'mi', selection: { start: 9, end: 11 } },
                  // Selects 'mi', stays 'mi', 9 - 11 pos 11
                  {
                    position: 11,
                    data: 'mi',
                    selection: { start: 9, end: 11 },
                  },

                  // All selected positions, become 11
                  {
                    position: 11,
                    data: 'position-11',
                  },
                  {
                    position: 12,
                    data: 'position-12',
                  },
                  {
                    position: 13,
                    data: 'position-13',
                  },
                  // One before, stays 10
                  {
                    position: 10,
                    data: 'position-10',
                  },
                  // First position, stays 0
                  {
                    position: 0,
                    data: 'position-0',
                  },
                ],
              });
              const subscriber = autoSubscribe(typewriter);

              assertState(typewriter, {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 13,
                    data: undefined,
                    selection: { start: 11, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 12,
                    data: 's',
                    selection: { start: 12, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 's',
                    selection: { start: 12, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 'es',
                    selection: { start: 11, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'es',
                    selection: { start: 11, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 10,
                    data: 'ies',
                    selection: { start: 10, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'ies',
                    selection: { start: 10, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 'mie',
                    selection: { start: 9, end: 12 },
                    isBlinking: true,
                  },
                  {
                    position: 12,
                    data: 'mie',
                    selection: { start: 9, end: 12 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 'mi',
                    selection: { start: 9, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 'mi',
                    selection: { start: 9, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 'position-11',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 12,
                    data: 'position-12',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'position-13',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 10,
                    data: 'position-10',
                    selection: undefined,
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'position-0',
                    selection: undefined,
                    isBlinking: true,
                  },
                ],
                text: 'aap noot mies',
                blinkAfter: 50,
                isPlaying: true,
                isFinished: false,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: null,
              });

              jest.advanceTimersByTime(100);

              assertLastSubscriber(
                subscriber,
                {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'x',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 12,
                      data: undefined,
                      selection: undefined,
                      isBlinking: false,
                    },
                    {
                      position: 11,
                      data: 's',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 's',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ies',
                      selection: { start: 10, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'ies',
                      selection: { start: 10, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mie',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mie',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mi',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mi',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-11',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-12',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'position-10',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mix',
                  blinkAfter: 50,
                  isPlaying: false,
                  isFinished: true,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                },
                {
                  type: 'FINISHED',
                  action: {
                    type: 'keyboard',
                    text: 'x',
                    delay: 100,
                    cursor: 0,
                  },
                  time: new Date(),
                  cursor: typewriter.cursors[0],
                }
              );
            });
          });
        });
      });

      describe('word', () => {
        describe('cursor movement', () => {
          it('should move cursors that are before the cursor one place forwards, and cursors that lie before or on should stay in position, when inserting at the start', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'tall j',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'ohn',
              cursors: [
                { position: 0, data: undefined },

                { position: 0, data: undefined },
                { position: 2, data: undefined },
                { position: 1, data: undefined },
                { position: 3, data: undefined },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'tall j',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'ohn',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'tall j',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 6,
                    data: undefined,
                    isBlinking: false,
                    selection: undefined,
                  },
                  {
                    position: 0,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 8,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 7,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 9,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                ],
                text: 'tall john',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'tall j',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'tall j',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should move cursors that are after or on the cursor one place backwards, and cursors that lie before should stay in position, when inserting at the middle', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'xox',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'john',
              cursors: [
                { position: 2, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
                { position: 1, data: undefined },
                { position: 0, data: undefined },
                { position: 4, data: undefined },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'xox',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 4,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'john',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'xox',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 5,
                    data: undefined,
                    isBlinking: false,
                    selection: undefined,
                  },
                  {
                    position: 2,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 6,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 1,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 0,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 7,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                ],
                text: 'joxoxhn',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'xox',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'xox',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should not alter other cursors positions, when inserting at the end', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'athan',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'john',
              cursors: [
                { position: 4, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
                { position: 1, data: undefined },
                { position: 0, data: undefined },
                { position: 4, data: undefined },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'athan',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 4,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 4,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'john',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'athan',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 9,
                    data: undefined,
                    isBlinking: false,
                    selection: undefined,
                  },
                  {
                    position: 2,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 3,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 1,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 0,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 4,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                ],
                text: 'johnathan',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'athan',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'athan',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should alter other cursors positions, when inserting at the start', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'tin ',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'john',
              cursors: [
                { position: 0, data: undefined },
                { position: 2, data: undefined },
                { position: 3, data: undefined },
                { position: 1, data: undefined },
                { position: 0, data: undefined },
                { position: 4, data: undefined },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'tin ',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 2,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 3,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 1,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 0,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
                {
                  position: 4,
                  data: undefined,
                  isBlinking: true,
                  selection: undefined,
                },
              ],
              text: 'john',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'tin ',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 4,
                    data: undefined,
                    isBlinking: false,
                    selection: undefined,
                  },
                  {
                    position: 6,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 7,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 5,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 0,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                  {
                    position: 8,
                    data: undefined,
                    isBlinking: true,
                    selection: undefined,
                  },
                ],
                text: 'tin john',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'tin ',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'tin ',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });
        });

        describe('inserting cursor has no selection', () => {
          it('should increase or keep selection of other cursors, when inserting at the start', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'pa',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'ap noot mies',
              cursors: [
                // The cursor that is going to insert 'pa' at the start
                { position: 0, data: undefined },

                // Selects 'a' becomes 'paa', 0 - 3, pos stays 0
                { position: 0, data: 'a', selection: { start: 0, end: 1 } },
                // Selects 'ap', becomes 'paap', 0 - 4, pos stays 0
                { position: 0, data: 'ap', selection: { start: 0, end: 2 } },
                // Selects 'ap ' becomes 'paap ', 0 - 5, pos stays 0
                { position: 0, data: 'ap ', selection: { start: 0, end: 3 } },

                // Selects 'a' becomes 'paa', 0 - 3, pos becomes 3
                { position: 1, data: 'a', selection: { start: 0, end: 1 } },
                // Selects 'ap', becomes 'paap', 0 - 4, pos becomes 4
                { position: 2, data: 'ap', selection: { start: 0, end: 2 } },
                // Selects 'ap ' becomes 'paap ', 0 - 5, pos becomes 5
                { position: 3, data: 'ap ', selection: { start: 0, end: 3 } },

                // Selects 'p', stays 'p', 3 - 4, pos becomes 3
                { position: 1, data: 'p', selection: { start: 1, end: 2 } },
                // Selects 'p ', stays 'p ', 3 - 5, pos becomes 3
                { position: 1, data: 'p ', selection: { start: 1, end: 3 } },

                // Selects 'p', stays 'p', 3 - 4, pos becomes 4
                { position: 2, data: 'p', selection: { start: 1, end: 2 } },
                // Selects 'p ', stays 'p ', 3 - 5, pos becomes 5
                { position: 3, data: 'p ', selection: { start: 1, end: 3 } },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'pa',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 0,
                  data: undefined,
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'a',
                  selection: { start: 0, end: 1 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'ap',
                  selection: { start: 0, end: 2 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'ap ',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 1,
                  data: 'a',
                  selection: { start: 0, end: 1 },
                  isBlinking: true,
                },
                {
                  position: 2,
                  data: 'ap',
                  selection: { start: 0, end: 2 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'ap ',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 1,
                  data: 'p',
                  selection: { start: 1, end: 2 },
                  isBlinking: true,
                },
                {
                  position: 1,
                  data: 'p ',
                  selection: { start: 1, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 2,
                  data: 'p',
                  selection: { start: 1, end: 2 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'p ',
                  selection: { start: 1, end: 3 },
                  isBlinking: true,
                },
              ],
              text: 'ap noot mies',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'pa',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 2,
                    data: undefined,
                    selection: undefined,
                    isBlinking: false,
                  },
                  {
                    position: 0,
                    data: 'a',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'ap',
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'ap ',
                    selection: { start: 0, end: 5 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'a',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'ap',
                    selection: { start: 0, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'ap ',
                    selection: { start: 0, end: 5 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'p',
                    selection: { start: 3, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'p ',
                    selection: { start: 3, end: 5 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'p',
                    selection: { start: 3, end: 4 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'p ',
                    selection: { start: 3, end: 5 },
                    isBlinking: true,
                  },
                ],
                text: 'paap noot mies',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'pa',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'pa',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('should increase or keep selection of other cursors, when inserting at the middle', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'ooo',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'aap not mies',
              cursors: [
                // The cursor that is going to add 'ooo' in 'not
                { position: 6, data: undefined },

                // Selects 'aap not mies' becomes 'aap noooot mies', 0 - 15, pos becomes 15
                {
                  position: 12,
                  data: 'aap not mies',
                  selection: { start: 0, end: 12 },
                },
                // Selects 'aap not mies' becomes 'aap noooot mies', 0 - 15, pos stays 0
                {
                  position: 0,
                  data: 'aap not mies',
                  selection: { start: 0, end: 12 },
                },
                // Selects 'aap' stays 'aap', 0 - 3, pos stays 3
                { position: 3, data: 'aap', selection: { start: 0, end: 3 } },
                // Selects 'aap' stays 'aap', 0 - 3, pos stays 0
                { position: 0, data: 'aap', selection: { start: 0, end: 3 } },

                // Selects 'mies' stays 'mies', 11 - 15, pos becomes 15
                {
                  position: 12,
                  data: 'mies',
                  selection: { start: 8, end: 12 },
                },
                // Selects 'mies' stays 'mies', 11 - 15, pos becomes 11
                { position: 8, data: 'mies', selection: { start: 8, end: 12 } },

                // Selects 'not', becomes 'noooot', 4 - 10 pos stays 4
                { position: 4, data: 'not', selection: { start: 4, end: 7 } },
                // Selects 'not', becomes 'noooot', 4 - 10, pos becomes 10
                { position: 7, data: 'not', selection: { start: 4, end: 7 } },

                // Selects 'no', stays 'no', 4 - 6, pos stays 4
                { position: 4, data: 'no', selection: { start: 4, end: 6 } },
                // Selects 'no', stays 'no', 4 - 6, pos stays 6
                { position: 6, data: 'no', selection: { start: 4, end: 6 } },

                // Selects 'o', stays 'o', 5 - 6, pos stays 5
                { position: 5, data: 'o', selection: { start: 5, end: 6 } },
                // Selects 'o', stays 'o', 5 - 6, pos stays 6
                { position: 6, data: 'o', selection: { start: 5, end: 6 } },

                // Selects 't', becomes 'ooot', 6 - 10, pos stays 6
                { position: 6, data: 't', selection: { start: 6, end: 7 } },
                // Selects 't', stays 'ooot', 6 - 10, pos becomes 10
                { position: 7, data: 't', selection: { start: 6, end: 7 } },

                // Selects 't ', becomes 'ooot ', 6 - 11, pos stays 6
                { position: 6, data: 't ', selection: { start: 6, end: 8 } },
                // Selects 't ', stays 'ooot ', 6 - 11, pos becomes 11
                { position: 8, data: 't ', selection: { start: 6, end: 8 } },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'ooo',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 6,
                  data: undefined,
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 12,
                  data: 'aap not mies',
                  selection: { start: 0, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap not mies',
                  selection: { start: 0, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 12,
                  data: 'mies',
                  selection: { start: 8, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 8,
                  data: 'mies',
                  selection: { start: 8, end: 12 },
                  isBlinking: true,
                },
                {
                  position: 4,
                  data: 'not',
                  selection: { start: 4, end: 7 },
                  isBlinking: true,
                },
                {
                  position: 7,
                  data: 'not',
                  selection: { start: 4, end: 7 },
                  isBlinking: true,
                },
                {
                  position: 4,
                  data: 'no',
                  selection: { start: 4, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 6,
                  data: 'no',
                  selection: { start: 4, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 5,
                  data: 'o',
                  selection: { start: 5, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 6,
                  data: 'o',
                  selection: { start: 5, end: 6 },
                  isBlinking: true,
                },
                {
                  position: 6,
                  data: 't',
                  selection: { start: 6, end: 7 },
                  isBlinking: true,
                },
                {
                  position: 7,
                  data: 't',
                  selection: { start: 6, end: 7 },
                  isBlinking: true,
                },
                {
                  position: 6,
                  data: 't ',
                  selection: { start: 6, end: 8 },
                  isBlinking: true,
                },
                {
                  position: 8,
                  data: 't ',
                  selection: { start: 6, end: 8 },
                  isBlinking: true,
                },
              ],
              text: 'aap not mies',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'ooo',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 9,
                    data: undefined,
                    selection: undefined,
                    isBlinking: false,
                  },
                  {
                    position: 15,
                    data: 'aap not mies',
                    selection: { start: 0, end: 15 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap not mies',
                    selection: { start: 0, end: 15 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 15,
                    data: 'mies',
                    selection: { start: 11, end: 15 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 'mies',
                    selection: { start: 11, end: 15 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'not',
                    selection: { start: 4, end: 10 },
                    isBlinking: true,
                  },
                  {
                    position: 10,
                    data: 'not',
                    selection: { start: 4, end: 10 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'no',
                    selection: { start: 4, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'no',
                    selection: { start: 4, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 5,
                    data: 'o',
                    selection: { start: 5, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 'o',
                    selection: { start: 5, end: 6 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 't',
                    selection: { start: 6, end: 10 },
                    isBlinking: true,
                  },
                  {
                    position: 10,
                    data: 't',
                    selection: { start: 6, end: 10 },
                    isBlinking: true,
                  },
                  {
                    position: 6,
                    data: 't ',
                    selection: { start: 6, end: 11 },
                    isBlinking: true,
                  },
                  {
                    position: 11,
                    data: 't ',
                    selection: { start: 6, end: 11 },
                    isBlinking: true,
                  },
                ],
                text: 'aap noooot mies',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'ooo',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'ooo',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });

          it('keep selection of other cursors, when inserting at the end', () => {
            const typewriter = new Typewriter<string>({
              actions: [
                {
                  type: 'keyboard',
                  text: 'xoor',
                  delay: 100,
                  cursor: 0,
                },
              ],
              blinkAfter: 50,
              text: 'aap noot mies',
              cursors: [
                // The cursor that is going to add 'xoor' to the last position.
                { position: 13, data: undefined },

                // All cursors should not be affected
                {
                  position: 13,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 13 },
                },
                {
                  position: 0,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 13 },
                },
                { position: 3, data: 'aap', selection: { start: 0, end: 3 } },
                { position: 0, data: 'aap', selection: { start: 0, end: 3 } },
                {
                  position: 13,
                  data: 'mies',
                  selection: { start: 9, end: 13 },
                },
                { position: 9, data: 'mies', selection: { start: 9, end: 13 } },
                { position: 4, data: 'noot', selection: { start: 4, end: 8 } },
                { position: 8, data: 'noot', selection: { start: 4, end: 8 } },
              ],
            });
            const subscriber = autoSubscribe(typewriter);

            assertState(typewriter, {
              history: [],
              actions: [
                {
                  type: 'keyboard',
                  text: 'xoor',
                  delay: 100,
                  cursor: 0,
                },
              ],
              cursors: [
                {
                  position: 13,
                  data: undefined,
                  selection: undefined,
                  isBlinking: true,
                },
                {
                  position: 13,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 13 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap noot mies',
                  selection: { start: 0, end: 13 },
                  isBlinking: true,
                },
                {
                  position: 3,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 0,
                  data: 'aap',
                  selection: { start: 0, end: 3 },
                  isBlinking: true,
                },
                {
                  position: 13,
                  data: 'mies',
                  selection: { start: 9, end: 13 },
                  isBlinking: true,
                },
                {
                  position: 9,
                  data: 'mies',
                  selection: { start: 9, end: 13 },
                  isBlinking: true,
                },
                {
                  position: 4,
                  data: 'noot',
                  selection: { start: 4, end: 8 },
                  isBlinking: true,
                },
                {
                  position: 8,
                  data: 'noot',
                  selection: { start: 4, end: 8 },
                  isBlinking: true,
                },
              ],
              text: 'aap noot mies',
              blinkAfter: 50,
              isPlaying: true,
              isFinished: false,
              hasBeenStoppedBefore: false,
              repeat: false,
              repeatDelay: 0,
              lastPerformedAction: null,
            });

            jest.advanceTimersByTime(100);

            assertLastSubscriber(
              subscriber,
              {
                history: [],
                actions: [
                  {
                    type: 'keyboard',
                    text: 'xoor',
                    delay: 100,
                    cursor: 0,
                  },
                ],
                cursors: [
                  {
                    position: 17,
                    data: undefined,
                    selection: undefined,
                    isBlinking: false,
                  },
                  {
                    position: 13,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap noot mies',
                    selection: { start: 0, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 3,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 0,
                    data: 'aap',
                    selection: { start: 0, end: 3 },
                    isBlinking: true,
                  },
                  {
                    position: 13,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 9,
                    data: 'mies',
                    selection: { start: 9, end: 13 },
                    isBlinking: true,
                  },
                  {
                    position: 4,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                  {
                    position: 8,
                    data: 'noot',
                    selection: { start: 4, end: 8 },
                    isBlinking: true,
                  },
                ],
                text: 'aap noot miesxoor',
                blinkAfter: 50,
                isPlaying: false,
                isFinished: true,
                hasBeenStoppedBefore: false,
                repeat: false,
                repeatDelay: 0,
                lastPerformedAction: {
                  type: 'keyboard',
                  text: 'xoor',
                  delay: 100,
                  cursor: 0,
                },
              },
              {
                type: 'FINISHED',
                action: {
                  type: 'keyboard',
                  text: 'xoor',
                  delay: 100,
                  cursor: 0,
                },
                time: new Date(),
                cursor: typewriter.cursors[0],
              }
            );
          });
        });

        describe('inserting cursor has selection', () => {
          describe('with backward selection', () => {
            describe('inserting more chars than are removed', () => {
              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ploo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'ploo noot mies'
                  cursors: [
                    // The cursor that is going to insert 'ploo' at the start, while selecting 'aap'
                    {
                      position: 0,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos stays 0
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'aap ' becomes 'ploo ', 0 - 5 , pos stays 0
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects 'aap ' becomes 'ploo ', 0 - 5 , pos becomes 5
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects ' noot' becomes 'ploo noot', 0 - 9 , pos becomes 0
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                    },
                    // Selects ' noot' stays ' noot', 0 - 9 , pos becomes 9
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 5 - 9 , pos stays 4
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 5 - 9 , pos becomes 9
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },

                    // All selected positions, become 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    {
                      position: 1,
                      data: 'position-1',
                    },
                    {
                      position: 2,
                      data: 'position-2',
                    },
                    {
                      position: 3,
                      data: 'position-3',
                    },
                    // One after, becomes 5
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // Final position, becomes 14
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ploo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 0,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'position-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'position-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'position-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'ploo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 4,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap -0',
                        selection: { start: 0, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'aap -4',
                        selection: { start: 0, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: ' noot-3',
                        selection: { start: 0, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: ' noot-8',
                        selection: { start: 0, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'noot-4',
                        selection: { start: 5, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'noot-8',
                        selection: { start: 5, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'ploo noot mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'ploo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'ploo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ada',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap nadat mies'
                  cursors: [
                    // The cursor that is going to add 'ada', selects the oo's
                    {
                      position: 5,
                      data: undefined,
                      selection: { start: 5, end: 7 },
                    },

                    // Selects 'aap' stays 'aap', 0 - 3
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'noot', becomes 'nadat', 4 - 9
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'mies' stays 'mies', 10 - 14
                    {
                      position: 13,
                      data: 'mies-13',
                      selection: { start: 9, end: 13 },
                    },
                    {
                      position: 9,
                      data: 'mies-9',
                      selection: { start: 9, end: 13 },
                    },

                    // Selects 'p noot', becomes 'p nadat', 2 - 9
                    {
                      position: 8,
                      data: 'p noot-8',
                      selection: { start: 2, end: 8 },
                    },
                    {
                      position: 2,
                      data: 'p noot-2',
                      selection: { start: 2, end: 8 },
                    },

                    // Selects 'ot mi', becomes 'adat mi', 5 - 12
                    {
                      position: 11,
                      data: 'ot mi-11',
                      selection: { start: 6, end: 11 },
                    },
                    {
                      position: 6,
                      data: 'ot mi-6',
                      selection: { start: 6, end: 11 },
                    },

                    // Selects 't mi', becomes 'adat mi', 5 - 12
                    {
                      position: 11,
                      data: 't mi-11',
                      selection: { start: 7, end: 11 },
                    },
                    {
                      position: 7,
                      data: 't mi-7',
                      selection: { start: 7, end: 11 },
                    },

                    // 'p no' is a bit unexpected as you might think the 'ada' will be selected but it is not.
                    // Selects 'p no', becomes 'p n', 2 - 5
                    {
                      position: 6,
                      data: 'p no-6',
                      selection: { start: 2, end: 6 },
                    },
                    {
                      position: 2,
                      data: 'p no-2',
                      selection: { start: 2, end: 6 },
                    },

                    // Selects 'oot m', becomes 'adat m', 5 - 11
                    {
                      position: 10,
                      data: 'oot m-10',
                      selection: { start: 5, end: 10 },
                    },
                    {
                      position: 5,
                      data: 'oot m-5',
                      selection: { start: 5, end: 10 },
                    },

                    // 'p noo' is a bit unexpected as you might think the 'ada' will be selected but it is not.
                    // Selects 'p noo', becomes 'p n', 2 - 5
                    {
                      position: 7,
                      data: 'p noo-7',
                      selection: { start: 2, end: 7 },
                    },
                    {
                      position: 2,
                      data: 'p noo-2',
                      selection: { start: 2, end: 7 },
                    },

                    // Selects 'aap noot mies', becomes 'aap nadat mies', 0 - 14
                    {
                      position: 13,
                      data: 'aap noot mies-13',
                      selection: { start: 0, end: 13 },
                    },
                    {
                      position: 0,
                      data: 'aap noot mies-0',
                      selection: { start: 0, end: 13 },
                    },

                    // Selects 'noot mies', becomes 'nadat mies' 4 - 14
                    {
                      position: 13,
                      data: 'noot mies-13',
                      selection: { start: 4, end: 13 },
                    },
                    {
                      position: 4,
                      data: 'noot mies-4',
                      selection: { start: 4, end: 13 },
                    },

                    // Selects 'oo', becomes undefined
                    {
                      position: 7,
                      data: 'oo-7',
                      selection: { start: 5, end: 7 },
                    },
                    {
                      position: 5,
                      data: 'oo-5',
                      selection: { start: 5, end: 7 },
                    },

                    // All selected positions, become 5
                    {
                      position: 5,
                      data: 'position-5',
                    },
                    {
                      position: 6,
                      data: 'position-6',
                    },
                    {
                      position: 7,
                      data: 'position-7',
                    },
                    // One before, stays 4
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // One after, becomes 9
                    {
                      position: 8,
                      data: 'position-8',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    // Final position, becomes 14
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ada',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 5,
                      data: undefined,
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'mies-13',
                      selection: { start: 9, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mies-9',
                      selection: { start: 9, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'p noot-8',
                      selection: { start: 2, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noot-2',
                      selection: { start: 2, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'ot mi-11',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'ot mi-6',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 't mi-11',
                      selection: { start: 7, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 't mi-7',
                      selection: { start: 7, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'p no-6',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p no-2',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'oot m-10',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oot m-5',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'p noo-7',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noo-2',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'aap noot mies-13',
                      selection: { start: 0, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap noot mies-0',
                      selection: { start: 0, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'noot mies-13',
                      selection: { start: 4, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot mies-4',
                      selection: { start: 4, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'oo-7',
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oo-5',
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-5',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'position-6',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'position-7',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'position-8',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'ada',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 8,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 3,
                        data: 'aap-3',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'noot-8',
                        selection: { start: 4, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot-4',
                        selection: { start: 4, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'mies-13',
                        selection: { start: 10, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'mies-9',
                        selection: { start: 10, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'p noot-8',
                        selection: { start: 2, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p noot-2',
                        selection: { start: 2, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 12,
                        data: 'ot mi-11',
                        selection: { start: 5, end: 12 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'ot mi-6',
                        selection: { start: 5, end: 12 },
                        isBlinking: true,
                      },
                      {
                        position: 12,
                        data: 't mi-11',
                        selection: { start: 5, end: 12 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 't mi-7',
                        selection: { start: 5, end: 12 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p no-6',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p no-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'oot m-10',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oot m-5',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p noo-7',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p noo-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'aap noot mies-13',
                        selection: { start: 0, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap noot mies-0',
                        selection: { start: 0, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'noot mies-13',
                        selection: { start: 4, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot mies-4',
                        selection: { start: 4, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oo-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oo-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-6',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'position-8',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap nadat mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'ada',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'ada',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xoxo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap noot mixoxo'
                  cursors: [
                    // The cursor that is going to hit 'xoxo', on es
                    {
                      position: 11,
                      data: undefined,
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 's' becomes undefined, pos 11
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                    },
                    // Selects 's' becomes undefined, pos 11
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                    },

                    // Selects 'es', becomes undefined pos 11
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                    },
                    // Selects 'es', becomes undefined pos 11
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 'ies' becomes 'i', 10 - 11 pos 10
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                    },
                    // Selects 'ies' becomes 'i', 10 - 11 pos 11
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                    },

                    // Selects 'mie', becomes 'mi', 9 - 11 pos 9
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                    },
                    // Selects 'mie', becomes 'mi', 9 - 11 pos 11
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                    },

                    // Selects 'mi', stays 'mi', 9 - 11 pos 9
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                    },
                    // Selects 'mi', stays 'mi', 9 - 11 pos 11
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                    },
                    // All selected positions, become 11
                    {
                      position: 11,
                      data: 'position-11',
                    },
                    {
                      position: 12,
                      data: 'position-12',
                    },
                    {
                      position: 13,
                      data: 'position-13',
                    },
                    // One before, stays 10
                    {
                      position: 10,
                      data: 'position-10',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xoxo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 11,
                      data: undefined,
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-11',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'position-12',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'position-10',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xoxo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 15,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 11,
                        data: 's-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 's-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'es-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'es-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'ies-10',
                        selection: { start: 10, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'ies-13',
                        selection: { start: 10, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mie-9',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'mie-12',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mi-9',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'mi-11',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-10',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap noot mixoxo',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xoxo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xoxo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });

            describe('inserting less chars than are removed', () => {
              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xa',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'xa noot mies
                  cursors: [
                    // The cursor that is going to insert 'xa' at the start, while selecting 'aap'
                    {
                      position: 0,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos stays 0
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'aap ' becomes 'xa ', 0 - 3 , pos stays 0
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects 'aap ' becomes 'xap ', 0 - 3 , pos becomes 3
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects ' noot' becomes 'xa noot', 0 - 7 , pos becomes 0
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                    },
                    // Selects ' noot' becomes 'xa noot', 0 - 7 , pos becomes 7
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 3 - 7 , pos becomes 3
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 3 - 7 , pos becomes 7
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },
                    // All selected positions, become 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    {
                      position: 1,
                      data: 'position-1',
                    },
                    {
                      position: 2,
                      data: 'position-2',
                    },
                    {
                      position: 3,
                      data: 'position-3',
                    },
                    // One after, becomes 3
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // Final position, becomes 12
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xa',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 0,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'position-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'position-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'position-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xa',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 2,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap -0',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 3,
                        data: 'aap -4',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: ' noot-3',
                        selection: { start: 0, end: 7 },
                        isBlinking: true,
                      },
                      {
                        position: 7,
                        data: ' noot-8',
                        selection: { start: 0, end: 7 },
                        isBlinking: true,
                      },
                      {
                        position: 3,
                        data: 'noot-4',
                        selection: { start: 3, end: 7 },
                        isBlinking: true,
                      },
                      {
                        position: 7,
                        data: 'noot-8',
                        selection: { start: 3, end: 7 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 3,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 12,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'xa noot mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xa',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xa',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'oo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap nadat mies', // 'aap noot mies'
                  cursors: [
                    // The cursor that is going to add 'oo', selects 'ada'
                    {
                      position: 5,
                      data: undefined,
                      selection: { start: 5, end: 8 },
                    },

                    // Selects 'aap' stays 'aap', 0 - 3
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },
                    // Selects 'aap' stays 'aap', 0 - 3
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'nadat', becomes 'noot', 4 - 8
                    {
                      position: 9,
                      data: 'nadat-9',
                      selection: { start: 4, end: 9 },
                    },
                    {
                      position: 4,
                      data: 'nadat-4',
                      selection: { start: 4, end: 9 },
                    },

                    // Selects 'mies' stays 'mies', 9 - 13
                    {
                      position: 14,
                      data: 'mies-14',
                      selection: { start: 10, end: 14 },
                    },
                    {
                      position: 10,
                      data: 'mies-10',
                      selection: { start: 10, end: 14 },
                    },

                    // Selects 'p nadat', becomes 'p noot', 2 - 8
                    {
                      position: 9,
                      data: 'p nadat-9',
                      selection: { start: 2, end: 9 },
                    },
                    {
                      position: 2,
                      data: 'p nadat-2',
                      selection: { start: 2, end: 9 },
                    },

                    // Selects 'at mi', becomes 'oot mi', 5 - 11
                    {
                      position: 12,
                      data: 'at mi-12',
                      selection: { start: 7, end: 12 },
                    },
                    {
                      position: 7,
                      data: 'at mi-7',
                      selection: { start: 7, end: 12 },
                    },

                    // Selects 't mi', becomes 'oot mi', 5 - 11
                    {
                      position: 12,
                      data: 't mi-12',
                      selection: { start: 8, end: 12 },
                    },
                    {
                      position: 8,
                      data: 't mi-8',
                      selection: { start: 8, end: 12 },
                    },

                    // 'p na' is a bit unexpected as you might think the 'ada' will be selected but it is not.
                    // Selects 'p na', becomes 'p n', 2 - 5
                    {
                      position: 6,
                      data: 'p na-6',
                      selection: { start: 2, end: 6 },
                    },
                    {
                      position: 2,
                      data: 'p na-2',
                      selection: { start: 2, end: 6 },
                    },

                    // Selects 'dat m', becomes 'oot m', 5 - 10
                    {
                      position: 11,
                      data: 'dat m-11',
                      selection: { start: 6, end: 11 },
                    },
                    {
                      position: 6,
                      data: 'dat m-6',
                      selection: { start: 6, end: 11 },
                    },

                    // 'p nad' is a bit unexpected as you might think the 'oo' will be selected but it is not.
                    // Selects 'p nad', becomes 'p n', 2 - 5
                    {
                      position: 7,
                      data: 'p nad-7',
                      selection: { start: 2, end: 7 },
                    },
                    {
                      position: 2,
                      data: 'p nad-2',
                      selection: { start: 2, end: 7 },
                    },

                    // Selects 'aap nadat mies', becomes 'aap noot mies', 0 - 13
                    {
                      position: 14,
                      data: 'aap nadat mies-14',
                      selection: { start: 0, end: 14 },
                    },
                    {
                      position: 0,
                      data: 'aap nadat mies-0',
                      selection: { start: 0, end: 14 },
                    },

                    // Selects 'nadat mies', becomes 'noot mies' 4 - 13
                    {
                      position: 14,
                      data: 'nadat mies-14',
                      selection: { start: 4, end: 14 },
                    },
                    {
                      position: 4,
                      data: 'nadat mies-4',
                      selection: { start: 4, end: 14 },
                    },

                    // Selects 'ada', becomes undefined, pos 5
                    {
                      position: 8,
                      data: 'ada-8',
                      selection: { start: 5, end: 8 },
                    },
                    {
                      position: 5,
                      data: 'ada-5',
                      selection: { start: 5, end: 8 },
                    },

                    // All selected positions, become 5
                    {
                      position: 5,
                      data: 'position-5',
                    },
                    {
                      position: 6,
                      data: 'position-6',
                    },
                    {
                      position: 7,
                      data: 'position-7',
                    },
                    {
                      position: 8,
                      data: 'position-8',
                    },
                    // One before, stays 4
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // One after, becomes 8
                    {
                      position: 9,
                      data: 'position-9',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    // Final position, becomes 13
                    {
                      position: 14,
                      data: 'position-14',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'oo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 5,
                      data: undefined,
                      selection: { start: 5, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'nadat-9',
                      selection: { start: 4, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'nadat-4',
                      selection: { start: 4, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 14,
                      data: 'mies-14',
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'mies-10',
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'p nadat-9',
                      selection: { start: 2, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p nadat-2',
                      selection: { start: 2, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'at mi-12',
                      selection: { start: 7, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'at mi-7',
                      selection: { start: 7, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 't mi-12',
                      selection: { start: 8, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 't mi-8',
                      selection: { start: 8, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'p na-6',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p na-2',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'dat m-11',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'dat m-6',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'p nad-7',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p nad-2',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 14,
                      data: 'aap nadat mies-14',
                      selection: { start: 0, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap nadat mies-0',
                      selection: { start: 0, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 14,
                      data: 'nadat mies-14',
                      selection: { start: 4, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'nadat mies-4',
                      selection: { start: 4, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'ada-8',
                      selection: { start: 5, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'ada-5',
                      selection: { start: 5, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-5',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'position-6',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'position-7',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'position-8',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'position-9',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 14,
                      data: 'position-14',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap nadat mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'oo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 7,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 3,
                        data: 'aap-3',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'nadat-9',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'nadat-4',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'mies-14',
                        selection: { start: 9, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mies-10',
                        selection: { start: 9, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'p nadat-9',
                        selection: { start: 2, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p nadat-2',
                        selection: { start: 2, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'at mi-12',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'at mi-7',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 't mi-12',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 't mi-8',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p na-6',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p na-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'dat m-11',
                        selection: { start: 5, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'dat m-6',
                        selection: { start: 5, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p nad-7',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p nad-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'aap nadat mies-14',
                        selection: { start: 0, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap nadat mies-0',
                        selection: { start: 0, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'nadat mies-14',
                        selection: { start: 4, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'nadat mies-4',
                        selection: { start: 4, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'ada-8',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'ada-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-6',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-8',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'position-9',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'position-14',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap noot mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'oo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'oo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap noot mxo'
                  cursors: [
                    // The cursor that is going to hit 'xo', on ies
                    {
                      position: 10,
                      data: undefined,
                      selection: { start: 10, end: 13 },
                    },

                    // Selects 's' becomes undefined, pos 10
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                    },

                    // Selects 'es', becomes undefined pos 10
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 'ies' becomes undefined', pos 10
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                    },

                    // Selects 'mie', becomes 'm', 9 - 10
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                    },

                    // Selects 'mi', becomes 'm', 9 - 10
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                    },

                    // Selects 't m', stays 't m', 7 - 10
                    {
                      position: 7,
                      data: 't m-7',
                      selection: { start: 7, end: 10 },
                    },
                    {
                      position: 10,
                      data: 't m-10',
                      selection: { start: 7, end: 10 },
                    },

                    // All selected positions, become 10
                    {
                      position: 10,
                      data: 'position-10',
                    },
                    {
                      position: 11,
                      data: 'position-11',
                    },
                    {
                      position: 12,
                      data: 'position-12',
                    },
                    {
                      position: 13,
                      data: 'position-13',
                    },
                    // One before, stays 9
                    {
                      position: 9,
                      data: 'position-9',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 10,
                      data: undefined,
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 't m-7',
                      selection: { start: 7, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 't m-10',
                      selection: { start: 7, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'position-10',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-11',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'position-12',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'position-9',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 12,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 10,
                        data: 's-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 's-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'es-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'es-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'ies-10',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'ies-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mie-9',
                        selection: { start: 9, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'mie-12',
                        selection: { start: 9, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mi-9',
                        selection: { start: 9, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'mi-11',
                        selection: { start: 9, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 7,
                        data: 't m-7',
                        selection: { start: 7, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 't m-10',
                        selection: { start: 7, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-10',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'position-9',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap noot mxo',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });

            describe('inserting the same number of chars that are removed', () => {
              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xap',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies',
                  cursors: [
                    // The cursor that is going to insert 'xap' at the start, while selecting 'aap'
                    {
                      position: 0,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos stays 0
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'aap ' becomes 'xap ', 0 - 4 , pos stays 0
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects 'aap ' becomes 'xap ', 0 - 4 , pos stays 4
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects ' noot' becomes 'xap noot', 3 - 8 , pos becomes 0
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                    },
                    // Selects ' noot' stays 'xap noot', 3 - 8 , pos stays 8
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 4 - 8 , pos stays 4
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 4 - 8 , pos stays 8
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },

                    // All selected positions, become 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    {
                      position: 1,
                      data: 'position-1',
                    },
                    {
                      position: 2,
                      data: 'position-2',
                    },
                    {
                      position: 3,
                      data: 'position-3',
                    },
                    // One after, stays 4
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // Final position, stays 13
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xap',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 0,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'position-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'position-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'position-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xap',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 3,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap -0',
                        selection: { start: 0, end: 4 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'aap -4',
                        selection: { start: 0, end: 4 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: ' noot-3',
                        selection: { start: 0, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: ' noot-8',
                        selection: { start: 0, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot-4',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'noot-8',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'xap noot mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xap',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xap',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ad',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap nadt mies'
                  cursors: [
                    // The cursor that is going to add 'ad', selects the oo's
                    {
                      position: 5,
                      data: undefined,
                      selection: { start: 5, end: 7 },
                    },

                    // Selects 'aap' stays 'aap', 0 - 3
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'noot', becomes 'nadt', 4 - 8
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'mies' stays 'mies', 9 - 13
                    {
                      position: 13,
                      data: 'mies-13',
                      selection: { start: 9, end: 13 },
                    },
                    {
                      position: 9,
                      data: 'mies-9',
                      selection: { start: 9, end: 13 },
                    },

                    // Selects 'p noot', becomes 'p nadt', 2 - 8
                    {
                      position: 8,
                      data: 'p noot-8',
                      selection: { start: 2, end: 8 },
                    },
                    {
                      position: 2,
                      data: 'p noot-2',
                      selection: { start: 2, end: 8 },
                    },

                    // Selects 'ot mi', becomes 'adt mi', 5 - 11
                    {
                      position: 11,
                      data: 'ot mi-11',
                      selection: { start: 6, end: 11 },
                    },
                    {
                      position: 6,
                      data: 'ot mi-6',
                      selection: { start: 6, end: 11 },
                    },

                    // 't mi' in google docs becomes 'adt mi' which is very unexpected
                    // I'm ignoring that result.

                    // Selects 't mi', becomes 'adt mi', 7 - 11
                    {
                      position: 11,
                      data: 't mi-11',
                      selection: { start: 7, end: 11 },
                    },
                    {
                      position: 7,
                      data: 't mi-7',
                      selection: { start: 7, end: 11 },
                    },

                    // 'p no' is a bit unexpected as you might think the 'a' will be selected but it is not.
                    // Selects 'p no', becomes 'p n', 2 - 5
                    {
                      position: 6,
                      data: 'p no-6',
                      selection: { start: 2, end: 6 },
                    },
                    {
                      position: 2,
                      data: 'p no-2',
                      selection: { start: 2, end: 6 },
                    },

                    // Selects 'oot m', becomes 'adt m', 5 - 10
                    {
                      position: 10,
                      data: 'oot m-10',
                      selection: { start: 5, end: 10 },
                    },
                    {
                      position: 5,
                      data: 'oot m-5',
                      selection: { start: 5, end: 10 },
                    },

                    // 'p noo' is a bit unexpected as you might think the 'a' will be selected but it is not.
                    // Selects 'p noo', becomes 'p n', 2 - 5
                    {
                      position: 7,
                      data: 'p noo-7',
                      selection: { start: 2, end: 7 },
                    },
                    {
                      position: 2,
                      data: 'p noo-2',
                      selection: { start: 2, end: 7 },
                    },

                    // Selects 'aap noot mies', becomes 'aap nadt mies', 0 - 13
                    {
                      position: 13,
                      data: 'aap noot mies-13',
                      selection: { start: 0, end: 13 },
                    },
                    {
                      position: 0,
                      data: 'aap noot mies-0',
                      selection: { start: 0, end: 13 },
                    },

                    // Selects 'noot mies', becomes 'nadt mies' 4 - 13
                    {
                      position: 13,
                      data: 'noot mies-13',
                      selection: { start: 4, end: 13 },
                    },
                    {
                      position: 4,
                      data: 'noot mies-4',
                      selection: { start: 4, end: 13 },
                    },

                    // Selects 'oo', becomes undefines, pos 5
                    {
                      position: 7,
                      data: 'oo-7',
                      selection: { start: 5, end: 7 },
                    },
                    {
                      position: 5,
                      data: 'oo-5',
                      selection: { start: 5, end: 7 },
                    },

                    // All selected positions, become 5
                    {
                      position: 5,
                      data: 'position-5',
                    },
                    {
                      position: 6,
                      data: 'position-6',
                    },
                    {
                      position: 7,
                      data: 'position-7',
                    },
                    // One before, stays 4
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // One after, stays 8
                    {
                      position: 8,
                      data: 'position-8',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    // Final position, stays 13
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ad',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 5,
                      data: undefined,
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'mies-13',
                      selection: { start: 9, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mies-9',
                      selection: { start: 9, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'p noot-8',
                      selection: { start: 2, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noot-2',
                      selection: { start: 2, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'ot mi-11',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'ot mi-6',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 't mi-11',
                      selection: { start: 7, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 't mi-7',
                      selection: { start: 7, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'p no-6',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p no-2',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'oot m-10',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oot m-5',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'p noo-7',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noo-2',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'aap noot mies-13',
                      selection: { start: 0, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap noot mies-0',
                      selection: { start: 0, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'noot mies-13',
                      selection: { start: 4, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot mies-4',
                      selection: { start: 4, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'oo-7',
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oo-5',
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-5',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'position-6',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'position-7',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'position-8',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'ad',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 7,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 3,
                        data: 'aap-3',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'noot-8',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot-4',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'mies-13',
                        selection: { start: 9, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mies-9',
                        selection: { start: 9, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'p noot-8',
                        selection: { start: 2, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p noot-2',
                        selection: { start: 2, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'ot mi-11',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'ot mi-6',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 't mi-11',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 't mi-7',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p no-6',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p no-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'oot m-10',
                        selection: { start: 5, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oot m-5',
                        selection: { start: 5, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p noo-7',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p noo-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'aap noot mies-13',
                        selection: { start: 0, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap noot mies-0',
                        selection: { start: 0, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'noot mies-13',
                        selection: { start: 4, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot mies-4',
                        selection: { start: 4, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oo-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oo-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-6',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'position-8',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap nadt mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'ad',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'ad',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap noot mixo'
                  cursors: [
                    // The cursor that is going to hit 'xo', on es
                    {
                      position: 11,
                      data: undefined,
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 's' becomes undefined, pos 11
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                    },

                    // Selects 'es', becomes undefined pos 11
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 'ies' becomes 'i', 10 - 11
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                    },

                    // Selects 'mie', becomes 'mi', 9 - 11
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                    },

                    // Selects 'mi', stays 'mi', 9 - 11
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                    },

                    // All selected positions, become 11
                    {
                      position: 11,
                      data: 'position-11',
                    },
                    {
                      position: 12,
                      data: 'position-12',
                    },
                    {
                      position: 13,
                      data: 'position-13',
                    },
                    // One before, stays 10
                    {
                      position: 10,
                      data: 'position-10',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 11,
                      data: undefined,
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-11',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'position-12',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'position-10',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 13,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 11,
                        data: 's-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 's-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'es-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'es-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'ies-10',
                        selection: { start: 10, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'ies-13',
                        selection: { start: 10, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mie-9',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'mie-12',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mi-9',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'mi-11',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-10',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap noot mixo',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });
          });

          describe('with forward selection', () => {
            describe('inserting more chars than are removed', () => {
              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ploo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'ploo noot mies'
                  cursors: [
                    // The cursor that is going to insert 'ploo' at the start, while selecting 'aap'
                    {
                      position: 3,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos stays 0
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'aap ' becomes 'ploo ', 0 - 5 , pos stays 0
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects 'aap ' becomes 'ploo ', 0 - 5 , pos becomes 5
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects ' noot' becomes 'ploo noot', 0 - 9 , pos becomes 0
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                    },
                    // Selects ' noot' stays ' noot', 0 - 9 , pos becomes 9
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 5 - 9 , pos stays 4
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 5 - 9 , pos becomes 9
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },

                    // All selected positions, become 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    {
                      position: 1,
                      data: 'position-1',
                    },
                    {
                      position: 2,
                      data: 'position-2',
                    },
                    {
                      position: 3,
                      data: 'position-3',
                    },
                    // One after, becomes 5
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // Final position, becomes 14
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ploo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 3,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'position-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'position-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'position-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'ploo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 4,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap -0',
                        selection: { start: 0, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'aap -4',
                        selection: { start: 0, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: ' noot-3',
                        selection: { start: 0, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: ' noot-8',
                        selection: { start: 0, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'noot-4',
                        selection: { start: 5, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'noot-8',
                        selection: { start: 5, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'ploo noot mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'ploo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'ploo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ada',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap nadat mies'
                  cursors: [
                    // The cursor that is going to add 'ada', selects the oo's
                    {
                      position: 7,
                      data: undefined,
                      selection: { start: 5, end: 7 },
                    },

                    // Selects 'aap' stays 'aap', 0 - 3
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'noot', becomes 'nadat', 4 - 9
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'mies' stays 'mies', 10 - 14
                    {
                      position: 13,
                      data: 'mies-13',
                      selection: { start: 9, end: 13 },
                    },
                    {
                      position: 9,
                      data: 'mies-9',
                      selection: { start: 9, end: 13 },
                    },

                    // Selects 'p noot', becomes 'p nadat', 2 - 9
                    {
                      position: 8,
                      data: 'p noot-8',
                      selection: { start: 2, end: 8 },
                    },
                    {
                      position: 2,
                      data: 'p noot-2',
                      selection: { start: 2, end: 8 },
                    },

                    // Selects 'ot mi', becomes 'adat mi', 5 - 12
                    {
                      position: 11,
                      data: 'ot mi-11',
                      selection: { start: 6, end: 11 },
                    },
                    {
                      position: 6,
                      data: 'ot mi-6',
                      selection: { start: 6, end: 11 },
                    },

                    // Selects 't mi', becomes 'adat mi', 5 - 12
                    {
                      position: 11,
                      data: 't mi-11',
                      selection: { start: 7, end: 11 },
                    },
                    {
                      position: 7,
                      data: 't mi-7',
                      selection: { start: 7, end: 11 },
                    },

                    // 'p no' is a bit unexpected as you might think the 'ada' will be selected but it is not.
                    // Selects 'p no', becomes 'p n', 2 - 5
                    {
                      position: 6,
                      data: 'p no-6',
                      selection: { start: 2, end: 6 },
                    },
                    {
                      position: 2,
                      data: 'p no-2',
                      selection: { start: 2, end: 6 },
                    },

                    // Selects 'oot m', becomes 'adat m', 5 - 11
                    {
                      position: 10,
                      data: 'oot m-10',
                      selection: { start: 5, end: 10 },
                    },
                    {
                      position: 5,
                      data: 'oot m-5',
                      selection: { start: 5, end: 10 },
                    },

                    // 'p noo' is a bit unexpected as you might think the 'ada' will be selected but it is not.
                    // Selects 'p noo', becomes 'p n', 2 - 5
                    {
                      position: 7,
                      data: 'p noo-7',
                      selection: { start: 2, end: 7 },
                    },
                    {
                      position: 2,
                      data: 'p noo-2',
                      selection: { start: 2, end: 7 },
                    },

                    // Selects 'aap noot mies', becomes 'aap nadat mies', 0 - 14
                    {
                      position: 13,
                      data: 'aap noot mies-13',
                      selection: { start: 0, end: 13 },
                    },
                    {
                      position: 0,
                      data: 'aap noot mies-0',
                      selection: { start: 0, end: 13 },
                    },

                    // Selects 'noot mies', becomes 'nadat mies' 4 - 14
                    {
                      position: 13,
                      data: 'noot mies-13',
                      selection: { start: 4, end: 13 },
                    },
                    {
                      position: 4,
                      data: 'noot mies-4',
                      selection: { start: 4, end: 13 },
                    },

                    // Selects 'oo', becomes undefined
                    {
                      position: 7,
                      data: 'oo-7',
                      selection: { start: 5, end: 7 },
                    },
                    {
                      position: 5,
                      data: 'oo-5',
                      selection: { start: 5, end: 7 },
                    },

                    // All selected positions, become 5
                    {
                      position: 5,
                      data: 'position-5',
                    },
                    {
                      position: 6,
                      data: 'position-6',
                    },
                    {
                      position: 7,
                      data: 'position-7',
                    },
                    // One before, stays 4
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // One after, becomes 9
                    {
                      position: 8,
                      data: 'position-8',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    // Final position, becomes 14
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ada',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 7,
                      data: undefined,
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'mies-13',
                      selection: { start: 9, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mies-9',
                      selection: { start: 9, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'p noot-8',
                      selection: { start: 2, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noot-2',
                      selection: { start: 2, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'ot mi-11',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'ot mi-6',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 't mi-11',
                      selection: { start: 7, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 't mi-7',
                      selection: { start: 7, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'p no-6',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p no-2',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'oot m-10',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oot m-5',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'p noo-7',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noo-2',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'aap noot mies-13',
                      selection: { start: 0, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap noot mies-0',
                      selection: { start: 0, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'noot mies-13',
                      selection: { start: 4, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot mies-4',
                      selection: { start: 4, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'oo-7',
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oo-5',
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-5',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'position-6',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'position-7',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'position-8',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'ada',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 8,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 3,
                        data: 'aap-3',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'noot-8',
                        selection: { start: 4, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot-4',
                        selection: { start: 4, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'mies-13',
                        selection: { start: 10, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'mies-9',
                        selection: { start: 10, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'p noot-8',
                        selection: { start: 2, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p noot-2',
                        selection: { start: 2, end: 9 },
                        isBlinking: true,
                      },
                      {
                        position: 12,
                        data: 'ot mi-11',
                        selection: { start: 5, end: 12 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'ot mi-6',
                        selection: { start: 5, end: 12 },
                        isBlinking: true,
                      },
                      {
                        position: 12,
                        data: 't mi-11',
                        selection: { start: 5, end: 12 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 't mi-7',
                        selection: { start: 5, end: 12 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p no-6',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p no-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'oot m-10',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oot m-5',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p noo-7',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p noo-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'aap noot mies-13',
                        selection: { start: 0, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap noot mies-0',
                        selection: { start: 0, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'noot mies-13',
                        selection: { start: 4, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot mies-4',
                        selection: { start: 4, end: 14 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oo-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oo-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-6',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'position-8',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 14,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap nadat mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'ada',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'ada',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xoxo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap noot mixoxo'
                  cursors: [
                    // The cursor that is going to hit 'xoxo', on es
                    {
                      position: 13,
                      data: undefined,
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 's' becomes undefined, pos 11
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                    },
                    // Selects 's' becomes undefined, pos 11
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                    },

                    // Selects 'es', becomes undefined pos 11
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                    },
                    // Selects 'es', becomes undefined pos 11
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 'ies' becomes 'i', 10 - 11 pos 10
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                    },
                    // Selects 'ies' becomes 'i', 10 - 11 pos 11
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                    },

                    // Selects 'mie', becomes 'mi', 9 - 11 pos 9
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                    },
                    // Selects 'mie', becomes 'mi', 9 - 11 pos 11
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                    },

                    // Selects 'mi', stays 'mi', 9 - 11 pos 9
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                    },
                    // Selects 'mi', stays 'mi', 9 - 11 pos 11
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                    },
                    // All selected positions, become 11
                    {
                      position: 11,
                      data: 'position-11',
                    },
                    {
                      position: 12,
                      data: 'position-12',
                    },
                    {
                      position: 13,
                      data: 'position-13',
                    },
                    // One before, stays 10
                    {
                      position: 10,
                      data: 'position-10',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xoxo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 13,
                      data: undefined,
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-11',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'position-12',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'position-10',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xoxo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 15,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 11,
                        data: 's-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 's-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'es-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'es-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'ies-10',
                        selection: { start: 10, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'ies-13',
                        selection: { start: 10, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mie-9',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'mie-12',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mi-9',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'mi-11',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-10',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap noot mixoxo',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xoxo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xoxo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });

            describe('inserting less chars than are removed', () => {
              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xa',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'xa noot mies
                  cursors: [
                    // The cursor that is going to insert 'xa' at the start, while selecting 'aap'
                    {
                      position: 3,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos stays 0
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'aap ' becomes 'xa ', 0 - 3 , pos stays 0
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects 'aap ' becomes 'xap ', 0 - 3 , pos becomes 3
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects ' noot' becomes 'xa noot', 0 - 7 , pos becomes 0
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                    },
                    // Selects ' noot' becomes 'xa noot', 0 - 7 , pos becomes 7
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 3 - 7 , pos becomes 3
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 3 - 7 , pos becomes 7
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },
                    // All selected positions, become 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    {
                      position: 1,
                      data: 'position-1',
                    },
                    {
                      position: 2,
                      data: 'position-2',
                    },
                    {
                      position: 3,
                      data: 'position-3',
                    },
                    // One after, becomes 3
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // Final position, becomes 12
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xa',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 3,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'position-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'position-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'position-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xa',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 2,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap -0',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 3,
                        data: 'aap -4',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: ' noot-3',
                        selection: { start: 0, end: 7 },
                        isBlinking: true,
                      },
                      {
                        position: 7,
                        data: ' noot-8',
                        selection: { start: 0, end: 7 },
                        isBlinking: true,
                      },
                      {
                        position: 3,
                        data: 'noot-4',
                        selection: { start: 3, end: 7 },
                        isBlinking: true,
                      },
                      {
                        position: 7,
                        data: 'noot-8',
                        selection: { start: 3, end: 7 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 3,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 12,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'xa noot mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xa',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xa',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'oo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap nadat mies', // 'aap noot mies'
                  cursors: [
                    // The cursor that is going to add 'oo', selects 'ada'
                    {
                      position: 8,
                      data: undefined,
                      selection: { start: 5, end: 8 },
                    },

                    // Selects 'aap' stays 'aap', 0 - 3
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },
                    // Selects 'aap' stays 'aap', 0 - 3
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'nadat', becomes 'noot', 4 - 8
                    {
                      position: 9,
                      data: 'nadat-9',
                      selection: { start: 4, end: 9 },
                    },
                    {
                      position: 4,
                      data: 'nadat-4',
                      selection: { start: 4, end: 9 },
                    },

                    // Selects 'mies' stays 'mies', 9 - 13
                    {
                      position: 14,
                      data: 'mies-14',
                      selection: { start: 10, end: 14 },
                    },
                    {
                      position: 10,
                      data: 'mies-10',
                      selection: { start: 10, end: 14 },
                    },

                    // Selects 'p nadat', becomes 'p noot', 2 - 8
                    {
                      position: 9,
                      data: 'p nadat-9',
                      selection: { start: 2, end: 9 },
                    },
                    {
                      position: 2,
                      data: 'p nadat-2',
                      selection: { start: 2, end: 9 },
                    },

                    // Selects 'at mi', becomes 'oot mi', 5 - 11
                    {
                      position: 12,
                      data: 'at mi-12',
                      selection: { start: 7, end: 12 },
                    },
                    {
                      position: 7,
                      data: 'at mi-7',
                      selection: { start: 7, end: 12 },
                    },

                    // Selects 't mi', becomes 'oot mi', 5 - 11
                    {
                      position: 12,
                      data: 't mi-12',
                      selection: { start: 8, end: 12 },
                    },
                    {
                      position: 8,
                      data: 't mi-8',
                      selection: { start: 8, end: 12 },
                    },

                    // 'p na' is a bit unexpected as you might think the 'ada' will be selected but it is not.
                    // Selects 'p na', becomes 'p n', 2 - 5
                    {
                      position: 6,
                      data: 'p na-6',
                      selection: { start: 2, end: 6 },
                    },
                    {
                      position: 2,
                      data: 'p na-2',
                      selection: { start: 2, end: 6 },
                    },

                    // Selects 'dat m', becomes 'oot m', 5 - 10
                    {
                      position: 11,
                      data: 'dat m-11',
                      selection: { start: 6, end: 11 },
                    },
                    {
                      position: 6,
                      data: 'dat m-6',
                      selection: { start: 6, end: 11 },
                    },

                    // 'p nad' is a bit unexpected as you might think the 'oo' will be selected but it is not.
                    // Selects 'p nad', becomes 'p n', 2 - 5
                    {
                      position: 7,
                      data: 'p nad-7',
                      selection: { start: 2, end: 7 },
                    },
                    {
                      position: 2,
                      data: 'p nad-2',
                      selection: { start: 2, end: 7 },
                    },

                    // Selects 'aap nadat mies', becomes 'aap noot mies', 0 - 13
                    {
                      position: 14,
                      data: 'aap nadat mies-14',
                      selection: { start: 0, end: 14 },
                    },
                    {
                      position: 0,
                      data: 'aap nadat mies-0',
                      selection: { start: 0, end: 14 },
                    },

                    // Selects 'nadat mies', becomes 'noot mies' 4 - 13
                    {
                      position: 14,
                      data: 'nadat mies-14',
                      selection: { start: 4, end: 14 },
                    },
                    {
                      position: 4,
                      data: 'nadat mies-4',
                      selection: { start: 4, end: 14 },
                    },

                    // Selects 'ada', becomes undefined, pos 5
                    {
                      position: 8,
                      data: 'ada-8',
                      selection: { start: 5, end: 8 },
                    },
                    {
                      position: 5,
                      data: 'ada-5',
                      selection: { start: 5, end: 8 },
                    },

                    // All selected positions, become 5
                    {
                      position: 5,
                      data: 'position-5',
                    },
                    {
                      position: 6,
                      data: 'position-6',
                    },
                    {
                      position: 7,
                      data: 'position-7',
                    },
                    {
                      position: 8,
                      data: 'position-8',
                    },
                    // One before, stays 4
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // One after, becomes 8
                    {
                      position: 9,
                      data: 'position-9',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    // Final position, becomes 13
                    {
                      position: 14,
                      data: 'position-14',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'oo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 8,
                      data: undefined,
                      selection: { start: 5, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'nadat-9',
                      selection: { start: 4, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'nadat-4',
                      selection: { start: 4, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 14,
                      data: 'mies-14',
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'mies-10',
                      selection: { start: 10, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'p nadat-9',
                      selection: { start: 2, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p nadat-2',
                      selection: { start: 2, end: 9 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'at mi-12',
                      selection: { start: 7, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'at mi-7',
                      selection: { start: 7, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 't mi-12',
                      selection: { start: 8, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 't mi-8',
                      selection: { start: 8, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'p na-6',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p na-2',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'dat m-11',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'dat m-6',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'p nad-7',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p nad-2',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 14,
                      data: 'aap nadat mies-14',
                      selection: { start: 0, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap nadat mies-0',
                      selection: { start: 0, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 14,
                      data: 'nadat mies-14',
                      selection: { start: 4, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'nadat mies-4',
                      selection: { start: 4, end: 14 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'ada-8',
                      selection: { start: 5, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'ada-5',
                      selection: { start: 5, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-5',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'position-6',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'position-7',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'position-8',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'position-9',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 14,
                      data: 'position-14',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap nadat mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'oo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 7,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 3,
                        data: 'aap-3',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'nadat-9',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'nadat-4',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'mies-14',
                        selection: { start: 9, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mies-10',
                        selection: { start: 9, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'p nadat-9',
                        selection: { start: 2, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p nadat-2',
                        selection: { start: 2, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'at mi-12',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'at mi-7',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 't mi-12',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 't mi-8',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p na-6',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p na-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'dat m-11',
                        selection: { start: 5, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'dat m-6',
                        selection: { start: 5, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p nad-7',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p nad-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'aap nadat mies-14',
                        selection: { start: 0, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap nadat mies-0',
                        selection: { start: 0, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'nadat mies-14',
                        selection: { start: 4, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'nadat mies-4',
                        selection: { start: 4, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'ada-8',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'ada-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-6',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-8',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'position-9',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'position-14',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap noot mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'oo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'oo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap noot mxo'
                  cursors: [
                    // The cursor that is going to hit 'xo', on ies
                    {
                      position: 13,
                      data: undefined,
                      selection: { start: 10, end: 13 },
                    },

                    // Selects 's' becomes undefined, pos 10
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                    },

                    // Selects 'es', becomes undefined pos 10
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 'ies' becomes undefined', pos 10
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                    },

                    // Selects 'mie', becomes 'm', 9 - 10
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                    },

                    // Selects 'mi', becomes 'm', 9 - 10
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                    },

                    // Selects 't m', stays 't m', 7 - 10
                    {
                      position: 7,
                      data: 't m-7',
                      selection: { start: 7, end: 10 },
                    },
                    {
                      position: 10,
                      data: 't m-10',
                      selection: { start: 7, end: 10 },
                    },

                    // All selected positions, become 10
                    {
                      position: 10,
                      data: 'position-10',
                    },
                    {
                      position: 11,
                      data: 'position-11',
                    },
                    {
                      position: 12,
                      data: 'position-12',
                    },
                    {
                      position: 13,
                      data: 'position-13',
                    },
                    // One before, stays 9
                    {
                      position: 9,
                      data: 'position-9',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 13,
                      data: undefined,
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 't m-7',
                      selection: { start: 7, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 't m-10',
                      selection: { start: 7, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'position-10',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-11',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'position-12',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'position-9',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 12,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 10,
                        data: 's-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 's-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'es-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'es-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'ies-10',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'ies-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mie-9',
                        selection: { start: 9, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'mie-12',
                        selection: { start: 9, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mi-9',
                        selection: { start: 9, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'mi-11',
                        selection: { start: 9, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 7,
                        data: 't m-7',
                        selection: { start: 7, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 't m-10',
                        selection: { start: 7, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-10',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'position-9',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap noot mxo',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });

            describe('inserting the same number of chars that are removed', () => {
              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the start', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xap',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies',
                  cursors: [
                    // The cursor that is going to insert 'xap' at the start, while selecting 'aap'
                    {
                      position: 3,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos stays 0
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'aap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'ap' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'p' becomes undefined, pos becomes 0
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                    },

                    // Selects 'aap ' becomes 'xap ', 0 - 4 , pos stays 0
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects 'aap ' becomes 'xap ', 0 - 4 , pos stays 4
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                    },

                    // Selects ' noot' becomes 'xap noot', 3 - 8 , pos becomes 0
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                    },
                    // Selects ' noot' stays 'xap noot', 3 - 8 , pos stays 8
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 4 - 8 , pos stays 4
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'noot' stays 'noot', 4 - 8 , pos stays 8
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },

                    // All selected positions, become 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    {
                      position: 1,
                      data: 'position-1',
                    },
                    {
                      position: 2,
                      data: 'position-2',
                    },
                    {
                      position: 3,
                      data: 'position-3',
                    },
                    // One after, stays 4
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // Final position, stays 13
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xap',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 3,
                      data: undefined,
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'ap-1',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'ap-3',
                      selection: { start: 1, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p-2',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'p-3',
                      selection: { start: 2, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap -0',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'aap -4',
                      selection: { start: 0, end: 4 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: ' noot-3',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: ' noot-8',
                      selection: { start: 3, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 1,
                      data: 'position-1',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'position-2',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'position-3',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xap',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 3,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'ap-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'p-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap -0',
                        selection: { start: 0, end: 4 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'aap -4',
                        selection: { start: 0, end: 4 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: ' noot-3',
                        selection: { start: 0, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: ' noot-8',
                        selection: { start: 0, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot-4',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'noot-8',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-1',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-2',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-3',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'xap noot mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xap',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xap',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the middle', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ad',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap nadt mies'
                  cursors: [
                    // The cursor that is going to add 'ad', selects the oo's
                    {
                      position: 7,
                      data: undefined,
                      selection: { start: 5, end: 7 },
                    },

                    // Selects 'aap' stays 'aap', 0 - 3
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                    },

                    // Selects 'noot', becomes 'nadt', 4 - 8
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                    },

                    // Selects 'mies' stays 'mies', 9 - 13
                    {
                      position: 13,
                      data: 'mies-13',
                      selection: { start: 9, end: 13 },
                    },
                    {
                      position: 9,
                      data: 'mies-9',
                      selection: { start: 9, end: 13 },
                    },

                    // Selects 'p noot', becomes 'p nadt', 2 - 8
                    {
                      position: 8,
                      data: 'p noot-8',
                      selection: { start: 2, end: 8 },
                    },
                    {
                      position: 2,
                      data: 'p noot-2',
                      selection: { start: 2, end: 8 },
                    },

                    // Selects 'ot mi', becomes 'adt mi', 5 - 11
                    {
                      position: 11,
                      data: 'ot mi-11',
                      selection: { start: 6, end: 11 },
                    },
                    {
                      position: 6,
                      data: 'ot mi-6',
                      selection: { start: 6, end: 11 },
                    },

                    // 't mi' in google docs becomes 'adt mi' which is very unexpected
                    // I'm ignoring that result.

                    // Selects 't mi', becomes 'adt mi', 7 - 11
                    {
                      position: 11,
                      data: 't mi-11',
                      selection: { start: 7, end: 11 },
                    },
                    {
                      position: 7,
                      data: 't mi-7',
                      selection: { start: 7, end: 11 },
                    },

                    // 'p no' is a bit unexpected as you might think the 'a' will be selected but it is not.
                    // Selects 'p no', becomes 'p n', 2 - 5
                    {
                      position: 6,
                      data: 'p no-6',
                      selection: { start: 2, end: 6 },
                    },
                    {
                      position: 2,
                      data: 'p no-2',
                      selection: { start: 2, end: 6 },
                    },

                    // Selects 'oot m', becomes 'adt m', 5 - 10
                    {
                      position: 10,
                      data: 'oot m-10',
                      selection: { start: 5, end: 10 },
                    },
                    {
                      position: 5,
                      data: 'oot m-5',
                      selection: { start: 5, end: 10 },
                    },

                    // 'p noo' is a bit unexpected as you might think the 'a' will be selected but it is not.
                    // Selects 'p noo', becomes 'p n', 2 - 5
                    {
                      position: 7,
                      data: 'p noo-7',
                      selection: { start: 2, end: 7 },
                    },
                    {
                      position: 2,
                      data: 'p noo-2',
                      selection: { start: 2, end: 7 },
                    },

                    // Selects 'aap noot mies', becomes 'aap nadt mies', 0 - 13
                    {
                      position: 13,
                      data: 'aap noot mies-13',
                      selection: { start: 0, end: 13 },
                    },
                    {
                      position: 0,
                      data: 'aap noot mies-0',
                      selection: { start: 0, end: 13 },
                    },

                    // Selects 'noot mies', becomes 'nadt mies' 4 - 13
                    {
                      position: 13,
                      data: 'noot mies-13',
                      selection: { start: 4, end: 13 },
                    },
                    {
                      position: 4,
                      data: 'noot mies-4',
                      selection: { start: 4, end: 13 },
                    },

                    // Selects 'oo', becomes undefines, pos 5
                    {
                      position: 7,
                      data: 'oo-7',
                      selection: { start: 5, end: 7 },
                    },
                    {
                      position: 5,
                      data: 'oo-5',
                      selection: { start: 5, end: 7 },
                    },

                    // All selected positions, become 5
                    {
                      position: 5,
                      data: 'position-5',
                    },
                    {
                      position: 6,
                      data: 'position-6',
                    },
                    {
                      position: 7,
                      data: 'position-7',
                    },
                    // One before, stays 4
                    {
                      position: 4,
                      data: 'position-4',
                    },
                    // One after, stays 8
                    {
                      position: 8,
                      data: 'position-8',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                    // Final position, stays 13
                    {
                      position: 13,
                      data: 'position-13',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'ad',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 7,
                      data: undefined,
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 3,
                      data: 'aap-3',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap-0',
                      selection: { start: 0, end: 3 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'noot-8',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot-4',
                      selection: { start: 4, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'mies-13',
                      selection: { start: 9, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mies-9',
                      selection: { start: 9, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'p noot-8',
                      selection: { start: 2, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noot-2',
                      selection: { start: 2, end: 8 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'ot mi-11',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'ot mi-6',
                      selection: { start: 6, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 't mi-11',
                      selection: { start: 7, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 't mi-7',
                      selection: { start: 7, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'p no-6',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p no-2',
                      selection: { start: 2, end: 6 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'oot m-10',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oot m-5',
                      selection: { start: 5, end: 10 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'p noo-7',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 2,
                      data: 'p noo-2',
                      selection: { start: 2, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'aap noot mies-13',
                      selection: { start: 0, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'aap noot mies-0',
                      selection: { start: 0, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'noot mies-13',
                      selection: { start: 4, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'noot mies-4',
                      selection: { start: 4, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'oo-7',
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'oo-5',
                      selection: { start: 5, end: 7 },
                      isBlinking: true,
                    },
                    {
                      position: 5,
                      data: 'position-5',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 6,
                      data: 'position-6',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 7,
                      data: 'position-7',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 4,
                      data: 'position-4',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 8,
                      data: 'position-8',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'ad',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 7,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 3,
                        data: 'aap-3',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap-0',
                        selection: { start: 0, end: 3 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'noot-8',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot-4',
                        selection: { start: 4, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'mies-13',
                        selection: { start: 9, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mies-9',
                        selection: { start: 9, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'p noot-8',
                        selection: { start: 2, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p noot-2',
                        selection: { start: 2, end: 8 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'ot mi-11',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'ot mi-6',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 't mi-11',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 't mi-7',
                        selection: { start: 5, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p no-6',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p no-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'oot m-10',
                        selection: { start: 5, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oot m-5',
                        selection: { start: 5, end: 10 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'p noo-7',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 2,
                        data: 'p noo-2',
                        selection: { start: 2, end: 5 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'aap noot mies-13',
                        selection: { start: 0, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'aap noot mies-0',
                        selection: { start: 0, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'noot mies-13',
                        selection: { start: 4, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'noot mies-4',
                        selection: { start: 4, end: 13 },
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oo-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'oo-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-5',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-6',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 5,
                        data: 'position-7',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 4,
                        data: 'position-4',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 8,
                        data: 'position-8',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 13,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap nadt mies',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'ad',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'ad',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });

              it('should increase, remove or keep selection of other cursors, and update positions, when inserting at the end', () => {
                const typewriter = new Typewriter<string>({
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  blinkAfter: 50,
                  text: 'aap noot mies', // 'aap noot mixo'
                  cursors: [
                    // The cursor that is going to hit 'xo', on es
                    {
                      position: 13,
                      data: undefined,
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 's' becomes undefined, pos 11
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                    },

                    // Selects 'es', becomes undefined pos 11
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                    },

                    // Selects 'ies' becomes 'i', 10 - 11
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                    },

                    // Selects 'mie', becomes 'mi', 9 - 11
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                    },

                    // Selects 'mi', stays 'mi', 9 - 11
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                    },

                    // All selected positions, become 11
                    {
                      position: 11,
                      data: 'position-11',
                    },
                    {
                      position: 12,
                      data: 'position-12',
                    },
                    {
                      position: 13,
                      data: 'position-13',
                    },
                    // One before, stays 10
                    {
                      position: 10,
                      data: 'position-10',
                    },
                    // First position, stays 0
                    {
                      position: 0,
                      data: 'position-0',
                    },
                  ],
                });
                const subscriber = autoSubscribe(typewriter);

                assertState(typewriter, {
                  history: [],
                  actions: [
                    {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  ],
                  cursors: [
                    {
                      position: 13,
                      data: undefined,
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 's-12',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 's-13',
                      selection: { start: 12, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'es-11',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'es-13',
                      selection: { start: 11, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'ies-10',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'ies-13',
                      selection: { start: 10, end: 13 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mie-9',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'mie-12',
                      selection: { start: 9, end: 12 },
                      isBlinking: true,
                    },
                    {
                      position: 9,
                      data: 'mi-9',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'mi-11',
                      selection: { start: 9, end: 11 },
                      isBlinking: true,
                    },
                    {
                      position: 11,
                      data: 'position-11',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 12,
                      data: 'position-12',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 13,
                      data: 'position-13',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 10,
                      data: 'position-10',
                      selection: undefined,
                      isBlinking: true,
                    },
                    {
                      position: 0,
                      data: 'position-0',
                      selection: undefined,
                      isBlinking: true,
                    },
                  ],
                  text: 'aap noot mies',
                  blinkAfter: 50,
                  isPlaying: true,
                  isFinished: false,
                  hasBeenStoppedBefore: false,
                  repeat: false,
                  repeatDelay: 0,
                  lastPerformedAction: null,
                });

                jest.advanceTimersByTime(100);

                assertLastSubscriber(
                  subscriber,
                  {
                    history: [],
                    actions: [
                      {
                        type: 'keyboard',
                        text: 'xo',
                        delay: 100,
                        cursor: 0,
                      },
                    ],
                    cursors: [
                      {
                        position: 13,
                        data: undefined,
                        selection: undefined,
                        isBlinking: false,
                      },
                      {
                        position: 11,
                        data: 's-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 's-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'es-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'es-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'ies-10',
                        selection: { start: 10, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'ies-13',
                        selection: { start: 10, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mie-9',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'mie-12',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 9,
                        data: 'mi-9',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'mi-11',
                        selection: { start: 9, end: 11 },
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-11',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-12',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 11,
                        data: 'position-13',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 10,
                        data: 'position-10',
                        selection: undefined,
                        isBlinking: true,
                      },
                      {
                        position: 0,
                        data: 'position-0',
                        selection: undefined,
                        isBlinking: true,
                      },
                    ],
                    text: 'aap noot mixo',
                    blinkAfter: 50,
                    isPlaying: false,
                    isFinished: true,
                    hasBeenStoppedBefore: false,
                    repeat: false,
                    repeatDelay: 0,
                    lastPerformedAction: {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                  },
                  {
                    type: 'FINISHED',
                    action: {
                      type: 'keyboard',
                      text: 'xo',
                      delay: 100,
                      cursor: 0,
                    },
                    time: new Date(),
                    cursor: typewriter.cursors[0],
                  }
                );
              });
            });
          });
        });
      });
    });
  });

  describe('repeat', () => {
    it('should when repeat is false run the animation only once', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
        repeat: false,
        repeatDelay: 0,
      });
      const subscriber = autoSubscribe(typewriter);

      assertState(typewriter, {
        history: [],
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        ],
        cursors: [{ position: 0, data: undefined, isBlinking: true }],
        text: '',
        blinkAfter: 50,
        isPlaying: true,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: false,
        repeatDelay: 0,
        lastPerformedAction: null,
      });

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 1, data: undefined, isBlinking: false }],
          text: 'a',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 2, data: undefined, isBlinking: false }],
          text: 'ab',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 3, data: undefined, isBlinking: false }],
          text: 'abc',
          blinkAfter: 50,
          isPlaying: false,
          isFinished: true,
          hasBeenStoppedBefore: false,
          repeat: false,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'FINISHED',
          action: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );
    });

    it('should when repeat is 1 run the animation only once', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
        repeat: 1,
        repeatDelay: 0,
      });
      const subscriber = autoSubscribe(typewriter);

      assertState(typewriter, {
        history: [],
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        ],
        cursors: [{ position: 0, data: undefined, isBlinking: true }],
        text: '',
        blinkAfter: 50,
        isPlaying: true,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: 1,
        repeatDelay: 0,
        lastPerformedAction: null,
      });

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 1, data: undefined, isBlinking: false }],
          text: 'a',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 1,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 2, data: undefined, isBlinking: false }],
          text: 'ab',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 1,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 3, data: undefined, isBlinking: false }],
          text: 'abc',
          blinkAfter: 50,
          isPlaying: false,
          isFinished: true,
          hasBeenStoppedBefore: false,
          repeat: 1,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'FINISHED',
          action: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );
    });

    it('should when repeat is true run the animation indefinitely', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
        repeat: true,
        repeatDelay: 1,
        cursors: [{ position: 0, data: 'Owen' }],
      });
      const subscriber = autoSubscribe(typewriter);

      assertState(typewriter, {
        history: [],
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        ],
        cursors: [{ position: 0, data: 'Owen', isBlinking: true }],
        text: '',
        blinkAfter: 50,
        isPlaying: true,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: true,
        repeatDelay: 1,
        lastPerformedAction: null,
      });

      function checkIteration() {
        jest.advanceTimersByTime(50);

        assertLastSubscriber(
          subscriber,
          {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: 'a',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'c',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 1, data: 'Owen', isBlinking: false }],
            text: 'a',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 1,
            lastPerformedAction: {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
          },
          {
            type: 'CHANGED',
            action: {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            time: new Date(),
            cursor: typewriter.cursors[0],
          }
        );

        jest.advanceTimersByTime(50);

        assertLastSubscriber(
          subscriber,
          {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: 'a',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'c',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 2, data: 'Owen', isBlinking: false }],
            text: 'ab',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 1,
            lastPerformedAction: {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
          },
          {
            type: 'CHANGED',
            action: {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            time: new Date(),
            cursor: typewriter.cursors[0],
          }
        );

        jest.advanceTimersByTime(50);

        assertLastSubscriber(
          subscriber,
          {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: 'a',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'c',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 3, data: 'Owen', isBlinking: false }],
            text: 'abc',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 1,
            lastPerformedAction: {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          },
          {
            type: 'CHANGED',
            action: {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
            time: new Date(),
            cursor: typewriter.cursors[0],
          }
        );

        jest.advanceTimersByTime(1);

        assertLastSubscriber(
          subscriber,
          {
            history: [],
            actions: [
              {
                type: 'keyboard',
                text: 'a',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'b',
                delay: 50,
                cursor: 0,
              },
              {
                type: 'keyboard',
                text: 'c',
                delay: 50,
                cursor: 0,
              },
            ],
            cursors: [{ position: 0, data: 'Owen', isBlinking: true }],
            text: '',
            blinkAfter: 50,
            isPlaying: true,
            isFinished: false,
            hasBeenStoppedBefore: false,
            repeat: true,
            repeatDelay: 1,
            lastPerformedAction: {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          },
          {
            type: 'REPEATING',
            time: new Date(),
            cursor: typewriter.cursors[0],
          }
        );
      }

      // Run 10 times then call it a day
      checkIteration();
      checkIteration();
      checkIteration();
      checkIteration();
      checkIteration();
      checkIteration();
      checkIteration();
      checkIteration();
      checkIteration();
    });

    it('should when repeat is a number repeat that number amount of times, and then finish', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        ],
        text: 'z',
        blinkAfter: 50,
        repeat: 3,
      });
      const subscriber = autoSubscribe(typewriter);

      assertState(typewriter, {
        history: [],
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        ],
        cursors: [{ position: 1, data: undefined, isBlinking: true }],
        text: 'z',
        blinkAfter: 50,
        isPlaying: true,
        isFinished: false,
        hasBeenStoppedBefore: false,
        repeat: 3,
        repeatDelay: 0,
        lastPerformedAction: null,
      });

      // First iteration

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 2, data: undefined, isBlinking: false }],
          text: 'za',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 3, data: undefined, isBlinking: false }],
          text: 'zab',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 4, data: undefined, isBlinking: false }],
          text: 'zabc',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(1);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 1, data: undefined, isBlinking: true }],
          text: 'z',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'REPEATING',
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      // Second iteration

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 2, data: undefined, isBlinking: false }],
          text: 'za',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 3, data: undefined, isBlinking: false }],
          text: 'zab',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 4, data: undefined, isBlinking: false }],
          text: 'zabc',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(1);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 1, data: undefined, isBlinking: true }],
          text: 'z',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'REPEATING',
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      // Third iteration

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 2, data: undefined, isBlinking: false }],
          text: 'za',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'a',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 3, data: undefined, isBlinking: false }],
          text: 'zab',
          blinkAfter: 50,
          isPlaying: true,
          isFinished: false,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'CHANGED',
          action: {
            type: 'keyboard',
            text: 'b',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(50);

      assertLastSubscriber(
        subscriber,
        {
          history: [],
          actions: [
            {
              type: 'keyboard',
              text: 'a',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'b',
              delay: 50,
              cursor: 0,
            },
            {
              type: 'keyboard',
              text: 'c',
              delay: 50,
              cursor: 0,
            },
          ],
          cursors: [{ position: 4, data: undefined, isBlinking: false }],
          text: 'zabc',
          blinkAfter: 50,
          isPlaying: false,
          isFinished: true,
          hasBeenStoppedBefore: false,
          repeat: 3,
          repeatDelay: 0,
          lastPerformedAction: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
        },
        {
          type: 'FINISHED',
          action: {
            type: 'keyboard',
            text: 'c',
            delay: 50,
            cursor: 0,
          },
          time: new Date(),
          cursor: typewriter.cursors[0],
        }
      );

      jest.advanceTimersByTime(1);
    });
  });

  describe('play & pause and stop', () => {
    test('that the animation can be paused and continued', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      // After 100 milliseconds it should now be 'a'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED']);

      // Now pause it at the half way, it should be blinking now.
      jest.advanceTimersByTime(50);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING']);

      typewriter.pause();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'PAUSED']);

      // When paused advancing the time should do nothing.
      jest.advanceTimersByTime(500);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'PAUSED']);

      // Even when advancing a huge amount of seconds, it should
      // stay paused no matter what.
      jest.advanceTimersByTime(10000);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'PAUSED']);

      // Now press play, after 50 milliseconds it should type 'b'
      typewriter.play();

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'PAUSED', 'PLAYING']);

      // Just before nothing should happen
      jest.advanceTimersByTime(49);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'PAUSED', 'PLAYING']);

      // Force it over
      jest.advanceTimersByTime(1);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('ab');
      assertEvents(subscriber, [
        'CHANGED',
        'BLINKING',
        'PAUSED',
        'PLAYING',
        'CHANGED',
      ]);
    });

    test('that the animation can be paused and continued multiple times', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 10000000,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      // After 100 milliseconds it should now be 'a'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED']);

      // Now pause it at the half way
      jest.advanceTimersByTime(50);
      typewriter.pause();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'PAUSED']);

      // Now press play, after 50 milliseconds it should type 'b'
      typewriter.play();
      jest.advanceTimersByTime(50);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('ab');
      assertEvents(subscriber, ['CHANGED', 'PAUSED', 'PLAYING', 'CHANGED']);

      // Now pause it at the half way
      jest.advanceTimersByTime(50);
      typewriter.pause();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('ab');
      assertEvents(subscriber, [
        'CHANGED',
        'PAUSED',
        'PLAYING',
        'CHANGED',
        'PAUSED',
      ]);

      // Now press play
      typewriter.play();

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('ab');
      assertEvents(subscriber, [
        'CHANGED',
        'PAUSED',
        'PLAYING',
        'CHANGED',
        'PAUSED',
        'PLAYING',
      ]);

      // after 50 milliseconds it should type 'c'
      jest.advanceTimersByTime(50);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.isFinished).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('abc');
      assertEvents(subscriber, [
        'CHANGED',
        'PAUSED',
        'PLAYING',
        'CHANGED',
        'PAUSED',
        'PLAYING',
        'FINISHED',
      ]);
    });

    test('that the animation can be paused and continued to completion', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'd',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 10000000,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      // After 100 milliseconds it should now be 'a'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED']);

      // Now pause it at the half way
      jest.advanceTimersByTime(50);
      typewriter.pause();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'PAUSED']);

      typewriter.play();
      jest.advanceTimersByTime(50);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('ab');
      assertEvents(subscriber, ['CHANGED', 'PAUSED', 'PLAYING', 'CHANGED']);

      // after 100 milliseconds it should type 'c'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.isFinished).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('abc');
      assertEvents(subscriber, [
        'CHANGED',
        'PAUSED',
        'PLAYING',
        'CHANGED',
        'CHANGED',
      ]);

      // after 100 milliseconds it should type 'd'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.isFinished).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('abcd');
      assertEvents(subscriber, [
        'CHANGED',
        'PAUSED',
        'PLAYING',
        'CHANGED',
        'CHANGED',
        'FINISHED',
      ]);
    });

    test('that the autoplay can be stopped and restarted', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      // After 100 milliseconds it should now be 'a'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED']);

      // Now stop it at the half way, it should be blinking now.
      jest.advanceTimersByTime(50);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING']);

      typewriter.stop();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED']);

      // When stopped advancing the time should do nothing.
      jest.advanceTimersByTime(500);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED']);

      // Even when advancing a huge amount of seconds, it should
      // stay stopped no matter what.
      jest.advanceTimersByTime(10000);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED']);

      // Now press play, after 100 milliseconds it should type 'a'
      typewriter.play();

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED', 'PLAYING']);

      // Just before nothing should happen
      jest.advanceTimersByTime(99);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED', 'PLAYING']);

      // Force it over
      jest.advanceTimersByTime(1);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, [
        'CHANGED',
        'BLINKING',
        'STOPPED',
        'PLAYING',
        'CHANGED',
      ]);
    });

    test('that calling play when finished restarts the animation', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 200,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      // After 100 milliseconds it should now be 'a'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.isFinished).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED']);

      // Add in a stop for good measure
      typewriter.stop();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.isFinished).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'STOPPED']);

      // Now trigger the play and run the animation to finished.
      typewriter.play();

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.isFinished).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, ['CHANGED', 'STOPPED', 'PLAYING']);

      // After 100 milliseconds it should now be 'a'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.isFinished).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'STOPPED', 'PLAYING', 'CHANGED']);

      // After 100 milliseconds it should now be 'b'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.isFinished).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('ab');
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'FINISHED',
      ]);

      // Trigger blinking
      jest.advanceTimersByTime(200);
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'FINISHED',
        'BLINKING',
      ]);

      // Nothing should happen unless play() is called
      jest.advanceTimersByTime(1000);
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'FINISHED',
        'BLINKING',
      ]);

      // Call play
      typewriter.play();

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.isFinished).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'FINISHED',
        'BLINKING',
        'PLAYING',
      ]);

      // After 100 milliseconds it should now be 'a'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.isFinished).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'FINISHED',
        'BLINKING',
        'PLAYING',
        'CHANGED',
      ]);

      // After 100 milliseconds it should now be 'b'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.isFinished).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('ab');
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'FINISHED',
        'BLINKING',
        'PLAYING',
        'CHANGED',
        'FINISHED',
      ]);
    });

    test('that the autoplay can be stopped and restarted with the original text', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
        text: 'z',
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('z');
      assertEvents(subscriber, []);

      // After 100 milliseconds it should now be 'a'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('za');
      assertEvents(subscriber, ['CHANGED']);

      // Now stop it at the half way, it should be blinking now.
      jest.advanceTimersByTime(50);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('za');
      assertEvents(subscriber, ['CHANGED', 'BLINKING']);

      typewriter.stop();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);
      expect(typewriter.text).toBe('za');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED']);

      // When stopped advancing the time should do nothing.
      jest.advanceTimersByTime(500);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);
      expect(typewriter.text).toBe('za');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED']);

      // Even when advancing a huge amount of seconds, it should
      // stay stopped no matter what.
      jest.advanceTimersByTime(10000);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);
      expect(typewriter.text).toBe('za');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED']);

      // Now press play, after 100 milliseconds it should type 'a'
      typewriter.play();

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('z');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED', 'PLAYING']);

      // Just before nothing should happen
      jest.advanceTimersByTime(99);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('z');
      assertEvents(subscriber, ['CHANGED', 'BLINKING', 'STOPPED', 'PLAYING']);

      // Force it over
      jest.advanceTimersByTime(1);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('za');
      assertEvents(subscriber, [
        'CHANGED',
        'BLINKING',
        'STOPPED',
        'PLAYING',
        'CHANGED',
      ]);
    });

    test('that the autoplay can be stopped and restarted when animation repeats', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 1000,
        repeat: 2,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      // After 100 milliseconds it should now be 'a'
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED']);

      // Stop at 'a'
      typewriter.stop();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'STOPPED']);

      // Reset now, the animation should now play twice.
      typewriter.play();

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, ['CHANGED', 'STOPPED', 'PLAYING']);

      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED', 'STOPPED', 'PLAYING', 'CHANGED']);

      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('ab');
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'CHANGED',
      ]);

      // Repeat first time
      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'CHANGED',
        'REPEATING',
      ]);

      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'CHANGED',
        'REPEATING',
        'CHANGED',
      ]);

      jest.advanceTimersByTime(100);

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('ab');
      assertEvents(subscriber, [
        'CHANGED',
        'STOPPED',
        'PLAYING',
        'CHANGED',
        'CHANGED',
        'REPEATING',
        'CHANGED',
        'FINISHED',
      ]);
    });

    test('that it is possible to pause first then stop', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      typewriter.pause();

      expect(typewriter.isPlaying).toBe(false);

      assertEvents(subscriber, ['PAUSED']);

      // Now press stop it should clear the the pause
      typewriter.stop();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);

      assertEvents(subscriber, ['PAUSED', 'STOPPED']);
    });

    test('that it is not possible to pause when already paused', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      typewriter.pause();

      expect(typewriter.isPlaying).toBe(false);

      assertEvents(subscriber, ['PAUSED']);

      // Now press pause again it should be ignored
      typewriter.pause();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);

      assertEvents(subscriber, ['PAUSED']);
    });

    test('that it is not possible to stop when already stopped', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      typewriter.stop();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);

      assertEvents(subscriber, ['STOPPED']);

      // Now press stop again it should be ignored
      typewriter.stop();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(true);

      assertEvents(subscriber, ['STOPPED']);
    });

    test('that it is not possible to stop when never playing', () => {
      const typewriter = new Typewriter<string>();
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      typewriter.stop();

      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);

      assertEvents(subscriber, []);
    });

    test('that it is not possible to play when already playing', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 100,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      typewriter.play();

      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);

      assertEvents(subscriber, []);
    });

    test('that it is not possible to stop when already finished', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
        ],
        blinkAfter: 50,
      });
      const subscriber = autoSubscribe(typewriter);

      // Should be empty initially
      expect(typewriter.isFinished).toBe(false);
      expect(typewriter.isPlaying).toBe(true);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      // Let the animation run its course
      jest.advanceTimersByTime(100);

      expect(typewriter.isFinished).toBe(true);
      expect(typewriter.isPlaying).toBe(false);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.hasBeenStoppedBefore).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['FINISHED']);

      // Should not do anything.
      typewriter.stop();

      expect(typewriter.hasBeenStoppedBefore).toBe(false);

      assertEvents(subscriber, ['FINISHED']);
    });
  });

  describe('blinking', () => {
    it('should not blink a cursor when the user is typing until after the blinkAfter, and debounce the blinking whenever an event occurs', () => {
      const typewriter = new Typewriter<string>({
        blinkAfter: 250, // btw this is the default
        cursors: [{ position: 0 }],
        actions: [
          { type: 'keyboard', text: 'j', delay: 50, cursor: 0 },
          { type: 'keyboard', text: 'o', delay: 50, cursor: 0 },
          { type: 'keyboard', text: 'y', delay: 50, cursor: 0 },
          { type: 'keyboard', text: '!', delay: 50, cursor: 0 },
        ],
      });
      const subscriber = autoSubscribe(typewriter);

      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      jest.advanceTimersByTime(50);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.text).toBe('j');
      assertEvents(subscriber, ['CHANGED']);

      jest.advanceTimersByTime(50);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.text).toBe('jo');
      assertEvents(subscriber, ['CHANGED', 'CHANGED']);

      jest.advanceTimersByTime(50);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.text).toBe('joy');
      assertEvents(subscriber, ['CHANGED', 'CHANGED', 'CHANGED']);

      jest.advanceTimersByTime(50);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.text).toBe('joy!');
      assertEvents(subscriber, ['CHANGED', 'CHANGED', 'CHANGED', 'FINISHED']);

      // Move it to the edge
      jest.advanceTimersByTime(249);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.text).toBe('joy!');
      assertEvents(subscriber, ['CHANGED', 'CHANGED', 'CHANGED', 'FINISHED']);

      // Push it over
      jest.advanceTimersByTime(1);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      assertEvents(subscriber, [
        'CHANGED',
        'CHANGED',
        'CHANGED',
        'FINISHED',
        'BLINKING',
      ]);
    });

    describe('testing the edges', () => {
      it('should work even if a blinkAfter is equal to the delay', () => {
        // In this test we kind of misconfigure the Typewriter by
        // setting the blinkAfter equal to the delay.

        const typewriter = new Typewriter<string>({
          blinkAfter: 50,
          cursors: [{ position: 0 }],
          actions: [
            { type: 'keyboard', text: 'j', delay: 50, cursor: 0 },
            { type: 'keyboard', text: 'o', delay: 50, cursor: 0 },
            { type: 'keyboard', text: 'y', delay: 50, cursor: 0 },
            { type: 'keyboard', text: '!', delay: 50, cursor: 0 },
          ],
        });
        const subscriber = autoSubscribe(typewriter);

        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, []);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, ['CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('jo');
        assertEvents(subscriber, ['CHANGED', 'BLINKING', 'CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy');
        assertEvents(subscriber, [
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'CHANGED',
        ]);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'FINISHED',
        ]);

        // Move it to the edge
        jest.advanceTimersByTime(49);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'FINISHED',
        ]);

        // Push it over
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        assertEvents(subscriber, [
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'FINISHED',
          'BLINKING',
        ]);
      });

      it('should work even if a blinkAfter is one number less than the delay', () => {
        // In this test we kind of misconfigure the Typewriter by
        // setting the blinkAfter one less than the delay.

        const typewriter = new Typewriter<string>({
          blinkAfter: 49,
          cursors: [{ position: 0 }],
          actions: [
            { type: 'keyboard', text: 'j', delay: 50, cursor: 0 },
            { type: 'keyboard', text: 'o', delay: 50, cursor: 0 },
            { type: 'keyboard', text: 'y', delay: 50, cursor: 0 },
            { type: 'keyboard', text: '!', delay: 50, cursor: 0 },
          ],
        });
        const subscriber = autoSubscribe(typewriter);

        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, []);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, ['CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('jo');
        assertEvents(subscriber, ['CHANGED', 'BLINKING', 'CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy');
        assertEvents(subscriber, [
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'CHANGED',
        ]);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'FINISHED',
        ]);

        // Move it to the edge
        jest.advanceTimersByTime(48);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'FINISHED',
        ]);

        // Push it over
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        assertEvents(subscriber, [
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'CHANGED',
          'BLINKING',
          'FINISHED',
          'BLINKING',
        ]);
      });

      it('should work even if a blinkAfter is one more than the delay', () => {
        // This one is not a misconfiguration, but it is cutting it close :P

        const typewriter = new Typewriter<string>({
          blinkAfter: 51,
          cursors: [{ position: 0 }],
          actions: [
            { type: 'keyboard', text: 'j', delay: 50, cursor: 0 },
            { type: 'keyboard', text: 'o', delay: 50, cursor: 0 },
            { type: 'keyboard', text: 'y', delay: 50, cursor: 0 },
            { type: 'keyboard', text: '!', delay: 50, cursor: 0 },
          ],
        });
        const subscriber = autoSubscribe(typewriter);

        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, []);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, ['CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('jo');
        assertEvents(subscriber, ['CHANGED', 'CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy');
        assertEvents(subscriber, ['CHANGED', 'CHANGED', 'CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, ['CHANGED', 'CHANGED', 'CHANGED', 'FINISHED']);

        // Move it to the edge
        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, ['CHANGED', 'CHANGED', 'CHANGED', 'FINISHED']);

        // Push it over
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'FINISHED',
          'BLINKING', // This might seem odd but in line with what FINISHED means.
        ]);
      });
    });

    it('should blink multiple cursors independently', () => {
      const typewriter = new Typewriter<string>({
        blinkAfter: 100,
        cursors: [
          { position: 0, data: 'first' },
          { position: 0, data: 'middle' }, // This one should always blink
          { position: 0, data: 'last' }, // This one does the first and last action
        ],
        actions: [
          { type: 'keyboard', text: 'a', delay: 50, cursor: 2 },
          { type: 'keyboard', text: 'b', delay: 50, cursor: 0 },
          { type: 'keyboard', text: 'c', delay: 50, cursor: 0 },
          { type: 'keyboard', text: 'd', delay: 50, cursor: 2 },
        ],
      });
      const subscriber = autoSubscribe(typewriter);

      // All cursors should blink at the start
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.cursors[1].isBlinking).toBe(true);
      expect(typewriter.cursors[2].isBlinking).toBe(true);
      expect(typewriter.text).toBe('');
      assertEvents(subscriber, []);

      // Now the last cursor should not blink because it typed 'a'
      jest.advanceTimersByTime(50);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.cursors[1].isBlinking).toBe(true);
      expect(typewriter.cursors[2].isBlinking).toBe(false);
      expect(typewriter.text).toBe('a');
      assertEvents(subscriber, ['CHANGED']);

      // Now the last cursor should still blink because it has not
      // passed blinkAfter/ The first one typed 'b' to it does not
      // blink now
      jest.advanceTimersByTime(50);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.cursors[1].isBlinking).toBe(true);
      expect(typewriter.cursors[2].isBlinking).toBe(false);
      expect(typewriter.text).toBe('ba');
      assertEvents(subscriber, ['CHANGED', 'CHANGED']);

      // Now the first cursor types in 'c' so it does not blink.
      // but the final cursor now starts blinking again.
      jest.advanceTimersByTime(50);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.cursors[1].isBlinking).toBe(true);
      expect(typewriter.cursors[2].isBlinking).toBe(true);
      expect(typewriter.text).toBe('bca');
      assertEvents(subscriber, ['CHANGED', 'CHANGED', 'BLINKING', 'CHANGED']);

      // Now the first cursor is still blinking, and the final cursor stops
      // blinking again since it typed 'd' .
      jest.advanceTimersByTime(50);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.cursors[1].isBlinking).toBe(true);
      expect(typewriter.cursors[2].isBlinking).toBe(false);
      expect(typewriter.text).toBe('bcad');
      assertEvents(subscriber, [
        'CHANGED',
        'CHANGED',
        'BLINKING',
        'CHANGED',
        'FINISHED',
      ]);

      // Move the first cursor to the edge
      jest.advanceTimersByTime(49);
      expect(typewriter.cursors[0].isBlinking).toBe(false);
      expect(typewriter.cursors[1].isBlinking).toBe(true);
      expect(typewriter.cursors[2].isBlinking).toBe(false);
      expect(typewriter.text).toBe('bcad');

      // Push it over
      jest.advanceTimersByTime(1);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.cursors[1].isBlinking).toBe(true);
      expect(typewriter.cursors[2].isBlinking).toBe(false);
      assertEvents(subscriber, [
        'CHANGED',
        'CHANGED',
        'BLINKING',
        'CHANGED',
        'FINISHED',
        'BLINKING',
      ]);

      // Move the last cursor to the edge
      jest.advanceTimersByTime(49);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.cursors[1].isBlinking).toBe(true);
      expect(typewriter.cursors[2].isBlinking).toBe(false);
      assertEvents(subscriber, [
        'CHANGED',
        'CHANGED',
        'BLINKING',
        'CHANGED',
        'FINISHED',
        'BLINKING',
      ]);

      // Push it over
      jest.advanceTimersByTime(1);
      expect(typewriter.cursors[0].isBlinking).toBe(true);
      expect(typewriter.cursors[1].isBlinking).toBe(true);
      expect(typewriter.cursors[2].isBlinking).toBe(true);
      assertEvents(subscriber, [
        'CHANGED',
        'CHANGED',
        'BLINKING',
        'CHANGED',
        'FINISHED',
        'BLINKING',
        'BLINKING',
      ]);
    });

    describe('effects of repeating on blinking', () => {
      it('should still start blinking during the repeatDelay', () => {
        const typewriter = new Typewriter<string>({
          blinkAfter: 100,
          repeat: 2,
          repeatDelay: 1000,
          cursors: [{ position: 0 }],
          actions: [
            { type: 'keyboard', text: 'j', delay: 50, cursor: 0 },
            { type: 'keyboard', text: 'o', delay: 50, cursor: 0 },
            { type: 'keyboard', text: 'y', delay: 50, cursor: 0 },
            { type: 'keyboard', text: '!', delay: 50, cursor: 0 },
          ],
        });
        const subscriber = autoSubscribe(typewriter);

        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, []);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, ['CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('jo');
        assertEvents(subscriber, ['CHANGED', 'CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy');
        assertEvents(subscriber, ['CHANGED', 'CHANGED', 'CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, ['CHANGED', 'CHANGED', 'CHANGED', 'CHANGED']);

        // At this time we finished this animation iteration, and are
        // awaiting the repeat delay.
        jest.advanceTimersByTime(99);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, ['CHANGED', 'CHANGED', 'CHANGED', 'CHANGED']);

        // Should start blinking now
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
        ]);

        // Should still be blinking now, the second before the repeat
        jest.advanceTimersByTime(899);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
        ]);

        // Check the firing of the repeat
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
          'REPEATING',
        ]);

        // Once more check the animation, just to be sure
        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
          'REPEATING',
          'CHANGED',
        ]);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('jo');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
          'REPEATING',
          'CHANGED',
          'CHANGED',
        ]);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
          'REPEATING',
          'CHANGED',
          'CHANGED',
          'CHANGED',
        ]);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
          'REPEATING',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'FINISHED',
        ]);

        // At this time we finished this animation iteration, and are
        // awaiting the repeat delay.
        jest.advanceTimersByTime(99);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
          'REPEATING',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'FINISHED',
        ]);

        // Should start blinking now
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
          'REPEATING',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'FINISHED',
          'BLINKING',
        ]);

        // Should still be blinking now, the second before the repeat
        jest.advanceTimersByTime(899);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
          'REPEATING',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'FINISHED',
          'BLINKING',
        ]);

        // Check the firing of the finished event.
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('joy!');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'BLINKING',
          'REPEATING',
          'CHANGED',
          'CHANGED',
          'CHANGED',
          'FINISHED',
          'BLINKING',
        ]);
      });

      it('should when repeating reset the cursor and ignore blinks from the previous iterations', () => {
        const typewriter = new Typewriter<string>({
          blinkAfter: 51,
          repeat: true,
          repeatDelay: 50, // The repeatDelay lies before the blinkAfter
          cursors: [{ position: 0 }],
          actions: [
            { type: 'keyboard', text: 'j', delay: 50, cursor: 0 },
            { type: 'keyboard', text: '!', delay: 50, cursor: 0 },
          ],
        });
        const subscriber = autoSubscribe(typewriter);

        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, []);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, ['CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j!');
        assertEvents(subscriber, ['CHANGED', 'CHANGED']);

        // At this time we finished this animation iteration, and are
        // awaiting the repeat delay.
        jest.advanceTimersByTime(49);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j!');
        assertEvents(subscriber, ['CHANGED', 'CHANGED']);

        // Should start repeating and blinking due to the reset
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, ['CHANGED', 'CHANGED', 'REPEATING']);

        // Trigger first letter
        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'REPEATING',
          'CHANGED',
        ]);

        // This would have triggerd the blink from the previous '!' if
        // blinks from previous iterations are not ignored.
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'REPEATING',
          'CHANGED',
        ]);

        // Make sure changed is the next event is not BLINKING.
        jest.advanceTimersByTime(49);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.text).toBe('j!');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'REPEATING',
          'CHANGED',
          'CHANGED',
        ]);
      });

      it('should when repeating reset the cursors and ignore blinks from the previous iterations for multiple cursors', () => {
        // Two cursors first cursor is not the last action, but
        // blinks in the time of the repeatDelay.

        // Timeline: 0 50 100 150 200 250 300
        //  Actions:   j   !   R   j   !   R
        //    Blink:            0   1
        const typewriter = new Typewriter<string>({
          blinkAfter: 101,
          repeat: true,
          repeatDelay: 50,
          cursors: [{ position: 0 }, { position: 0 }],
          actions: [
            { type: 'keyboard', text: 'j', delay: 50, cursor: 0 },
            { type: 'keyboard', text: '!', delay: 50, cursor: 1 },
          ],
        });
        const subscriber = autoSubscribe(typewriter);

        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.cursors[1].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, []);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.cursors[1].isBlinking).toBe(true);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, ['CHANGED']);

        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.cursors[1].isBlinking).toBe(false);
        expect(typewriter.text).toBe('!j');
        assertEvents(subscriber, ['CHANGED', 'CHANGED']);

        // At this time we finished this animation iteration, and are
        // awaiting the repeat delay.
        jest.advanceTimersByTime(49);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.cursors[1].isBlinking).toBe(false);
        expect(typewriter.text).toBe('!j');
        assertEvents(subscriber, ['CHANGED', 'CHANGED']);

        // Should start repeating and blinking due to the reset
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.cursors[1].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, ['CHANGED', 'CHANGED', 'REPEATING']);

        // This would have triggerd the blink from the previous 'j' if
        // blinks from previous iterations are not ignored.
        jest.advanceTimersByTime(1);
        expect(typewriter.cursors[0].isBlinking).toBe(true);
        expect(typewriter.cursors[1].isBlinking).toBe(true);
        expect(typewriter.text).toBe('');
        assertEvents(subscriber, ['CHANGED', 'CHANGED', 'REPEATING']);

        // Trigger first letter
        jest.advanceTimersByTime(49);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.cursors[1].isBlinking).toBe(true);
        expect(typewriter.text).toBe('j');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'REPEATING',
          'CHANGED',
        ]);

        // Make sure changed is the next event is not BLINKING.
        jest.advanceTimersByTime(50);
        expect(typewriter.cursors[0].isBlinking).toBe(false);
        expect(typewriter.cursors[1].isBlinking).toBe(false);
        expect(typewriter.text).toBe('!j');
        assertEvents(subscriber, [
          'CHANGED',
          'CHANGED',
          'REPEATING',
          'CHANGED',
          'CHANGED',
        ]);
      });
    });
  });

  describe('builders', () => {
    describe('typewriterFromSentences', () => {
      it('should know how to build a Typewriter from sentences', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['I love cats', 'I love dogs'],
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I l');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I lo');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I lov');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love c');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love cats');

        // sentenceDelay kicking in
        jest.advanceTimersByTime(2000);
        expect(typewriter.text).toBe('I love cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love c');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love d');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love do');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love dog');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love dogs');
      });

      it('should work when first sentence is larger than second sentence', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['cactus', 'cats'],
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('c');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cac');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cact');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cactu');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cactus');

        // sentenceDelay kicking in
        jest.advanceTimersByTime(2000);
        expect(typewriter.text).toBe('cactu');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cact');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cac');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cats');
      });

      it('should work when first sentence is smaller than second sentence', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['cats', 'cactus'],
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('c');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cats');

        // sentenceDelay kicking in
        jest.advanceTimersByTime(2000);
        expect(typewriter.text).toBe('cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cac');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cact');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cactu');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('cactus');
      });

      it('should work when first sentence has nothing in common with the second sentence', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['aap', 'noot'],
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('a');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('aa');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('aap');

        // sentenceDelay kicking in
        jest.advanceTimersByTime(2000);
        expect(typewriter.text).toBe('aa');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('a');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('n');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('no');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('noo');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('noot');
      });

      it('should be able to set a custom sentence delay', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['I love cats', 'I love dogs'],
          sentenceDelay: 500,
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I l');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I lo');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I lov');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love c');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love cats');

        // custom sentenceDelay kicking in
        jest.advanceTimersByTime(500);
        expect(typewriter.text).toBe('I love cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love c');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love d');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love do');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love dog');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love dogs');
      });

      it('should when sentenceDelay is not set default sentenceDelay, and repeatDelay to 2000 milliseconds', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['a', 'b'],
          repeat: true,
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('a');

        // Push over, this is the sentenceDelay
        jest.advanceTimersByTime(1999);
        expect(typewriter.text).toBe('a');

        jest.advanceTimersByTime(1);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('b');

        jest.advanceTimersByTime(1999);
        expect(typewriter.text).toBe('b');

        // Push over, this is the repeatDelay
        jest.advanceTimersByTime(1);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('a');

        jest.advanceTimersByTime(2000);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('b');
      });

      it('should set repeatDelay to sentenceDelay when no repeatDelay is configured', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['a', 'b'],
          sentenceDelay: 500,
          repeat: true,
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('a');

        // Push over, this is the sentenceDelay
        jest.advanceTimersByTime(499);
        expect(typewriter.text).toBe('a');

        jest.advanceTimersByTime(1);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('b');

        jest.advanceTimersByTime(499);
        expect(typewriter.text).toBe('b');

        // Push over, this is the repeatDelay
        jest.advanceTimersByTime(1);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('a');

        jest.advanceTimersByTime(500);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('b');
      });

      it('should allow repeatDelay to differ from sentenceDelay when repeatDelay is explicitly configured', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['a', 'b'],
          sentenceDelay: 500,
          repeat: true,
          repeatDelay: 5000,
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('a');

        // Push over, this is the sentenceDelay
        jest.advanceTimersByTime(499);
        expect(typewriter.text).toBe('a');

        jest.advanceTimersByTime(1);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('b');

        jest.advanceTimersByTime(4999);
        expect(typewriter.text).toBe('b');

        // Push over, this is the repeatDelay
        jest.advanceTimersByTime(1);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('a');

        jest.advanceTimersByTime(500);
        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('b');
      });

      it('should be able to set a custom delay', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['I love cats', 'I love dogs'],
          delay: 100,
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I ');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I l');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I lo');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I lov');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love ');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love c');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love ca');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love cat');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love cats');

        // sentenceDelay kicking in
        jest.advanceTimersByTime(2000);
        expect(typewriter.text).toBe('I love cat');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love ca');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love c');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love ');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love d');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love do');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love dog');

        jest.advanceTimersByTime(100);
        expect(typewriter.text).toBe('I love dogs');
      });

      it('should know how to build a Typewriter from sentences which include unicode characters such as emoji', () => {
        const typewriter = typewriterFromSentences({
          sentences: ['I 😀 cats', 'I 🥹 dogs'],
        });

        expect(typewriter.text).toBe('');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀 ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀 c');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀 ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀 cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀 cats');

        // sentenceDelay kicking in
        jest.advanceTimersByTime(2000);
        expect(typewriter.text).toBe('I 😀 cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀 ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀 c');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀 ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 😀');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 🥹');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 🥹 ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 🥹 d');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 🥹 do');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 🥹 dog');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I 🥹 dogs');
      });

      it('should work when setting an initial text', () => {
        const typewriter = typewriterFromSentences({
          text: 'I love cats',
          sentences: ['I love dogs'],
        });

        expect(typewriter.text).toBe('I love cats');

        // Notice how it does not delay the sentence.
        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love cat');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ca');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love c');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love ');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love d');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love do');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love dog');

        jest.advanceTimersByTime(50);
        expect(typewriter.text).toBe('I love dogs');
      });
    });
  });

  describe('iterator', () => {
    it('the Typewriter should be iterable and return all positions, selections and cursors', () => {
      const typewriter = new Typewriter<string>({
        text: 'joy',
        cursors: [
          {
            position: 0,
            data: 'owen',
            selection: {
              // joy
              start: 0,
              end: 3,
            },
          },
          {
            position: 1,
            data: 'jane',
            selection: {
              // o
              start: 1,
              end: 2,
            },
          },
          {
            position: 2,
            data: 'tosca',
            selection: {
              // jo
              start: 0,
              end: 2,
            },
          },
          {
            position: 3,
            data: 'maarten',
            selection: {
              // joy
              start: 0,
              end: 3,
            },
          },
        ],
        actions: [],
      });

      const iterator = typewriter[Symbol.iterator]();

      const result0 = iterator.next();
      expect(result0.done).toBe(false);
      expect(result0.value.position).toBe(0);
      expect(result0.value.selected.length).toBe(3);
      expect(result0.value.selected[0].data).toBe('owen');
      expect(result0.value.selected[1].data).toBe('tosca');
      expect(result0.value.selected[2].data).toBe('maarten');
      expect(result0.value.cursors.length).toBe(1);
      expect(result0.value.cursors[0].data).toBe('owen');
      expect(result0.value.character).toBe('j');

      const result1 = iterator.next();
      expect(result1.done).toBe(false);
      expect(result1.value.position).toBe(1);
      expect(result1.value.selected.length).toBe(4);
      expect(result1.value.selected[0].data).toBe('owen');
      expect(result1.value.selected[1].data).toBe('jane');
      expect(result1.value.selected[2].data).toBe('tosca');
      expect(result1.value.selected[3].data).toBe('maarten');
      expect(result1.value.cursors.length).toBe(1);
      expect(result1.value.cursors[0].data).toBe('jane');
      expect(result1.value.character).toBe('o');

      const result2 = iterator.next();
      expect(result2.done).toBe(false);
      expect(result2.value.position).toBe(2);
      expect(result2.value.selected.length).toBe(2);
      expect(result2.value.selected[0].data).toBe('owen');
      expect(result2.value.selected[1].data).toBe('maarten');
      expect(result2.value.cursors.length).toBe(1);
      expect(result2.value.cursors[0].data).toBe('tosca');
      expect(result2.value.character).toBe('y');

      const result3 = iterator.next();
      expect(result3.done).toBe(false);
      expect(result3.value.position).toBe(3);
      expect(result3.value.selected.length).toBe(0);
      expect(result3.value.cursors.length).toBe(1);
      expect(result3.value.cursors[0].data).toBe('maarten');
      expect(result3.value.character).toBe('');

      const result4 = iterator.next();
      expect(result4.done).toBe(true);
      expect(result4.value).toBe(undefined);
    });

    it('it should work when there are multiple cursor on each position', () => {
      const typewriter = new Typewriter<string>({
        text: 'joy',
        cursors: [
          {
            position: 0,
            data: 'owen',
          },
          {
            position: 0,
            data: 'tessa',
          },
          {
            position: 1,
            data: 'jane',
          },
          {
            position: 1,
            data: 'sam',
          },
          {
            position: 2,
            data: 'tosca',
          },
          {
            position: 2,
            data: 'carla',
          },
          {
            position: 3,
            data: 'leen',
          },
          {
            position: 3,
            data: 'maarten',
          },
          {
            position: 3,
            data: 'arie',
          },
        ],
        actions: [],
      });

      const iterator = typewriter[Symbol.iterator]();

      const result0 = iterator.next();
      expect(result0.done).toBe(false);
      expect(result0.value.position).toBe(0);
      expect(result0.value.selected.length).toBe(0);
      expect(result0.value.cursors.length).toBe(2);
      expect(result0.value.cursors[0].data).toBe('owen');
      expect(result0.value.cursors[1].data).toBe('tessa');
      expect(result0.value.character).toBe('j');

      const result1 = iterator.next();
      expect(result1.done).toBe(false);
      expect(result1.value.position).toBe(1);
      expect(result1.value.selected.length).toBe(0);
      expect(result1.value.cursors.length).toBe(2);
      expect(result1.value.cursors[0].data).toBe('jane');
      expect(result1.value.cursors[1].data).toBe('sam');
      expect(result1.value.character).toBe('o');

      const result2 = iterator.next();
      expect(result2.done).toBe(false);
      expect(result2.value.position).toBe(2);
      expect(result2.value.selected.length).toBe(0);
      expect(result2.value.cursors.length).toBe(2);
      expect(result2.value.cursors[0].data).toBe('tosca');
      expect(result2.value.cursors[1].data).toBe('carla');
      expect(result2.value.character).toBe('y');

      const result3 = iterator.next();
      expect(result3.done).toBe(false);
      expect(result3.value.position).toBe(3);
      expect(result3.value.selected.length).toBe(0);
      expect(result3.value.cursors.length).toBe(3);
      expect(result3.value.cursors[0].data).toBe('leen');
      expect(result3.value.cursors[1].data).toBe('maarten');
      expect(result3.value.cursors[2].data).toBe('arie');
      expect(result3.value.character).toBe('');

      const result4 = iterator.next();
      expect(result4.done).toBe(true);
      expect(result4.value).toBe(undefined);
    });

    it('the iterator should work when there is just one cursor at the end', () => {
      const typewriter = new Typewriter<string>({
        text: 'joy',
        actions: [],
      });

      const iterator = typewriter[Symbol.iterator]();

      const result0 = iterator.next();
      expect(result0.done).toBe(false);
      expect(result0.value.position).toBe(0);
      expect(result0.value.selected.length).toBe(0);
      expect(result0.value.cursors.length).toBe(0);
      expect(result0.value.character).toBe('j');

      const result1 = iterator.next();
      expect(result1.done).toBe(false);
      expect(result1.value.position).toBe(1);
      expect(result1.value.selected.length).toBe(0);
      expect(result1.value.cursors.length).toBe(0);
      expect(result1.value.character).toBe('o');

      const result2 = iterator.next();
      expect(result2.done).toBe(false);
      expect(result2.value.position).toBe(2);
      expect(result2.value.selected.length).toBe(0);
      expect(result2.value.cursors.length).toBe(0);
      expect(result2.value.character).toBe('y');

      const result3 = iterator.next();
      expect(result3.done).toBe(false);
      expect(result3.value.position).toBe(3);
      expect(result3.value.selected.length).toBe(0);
      expect(result3.value.cursors.length).toBe(1);
      expect(result3.value.cursors[0].data).toBe(undefined);
      expect(result3.value.character).toBe('');

      const result4 = iterator.next();
      expect(result4.done).toBe(true);
      expect(result4.value).toBe(undefined);
    });

    it('the iterator should work when there is no cursor at the end', () => {
      const typewriter = new Typewriter<string>({
        cursors: [
          {
            position: 2,
            data: 'tosca',
          },
        ],
        text: 'joy',
        actions: [],
      });

      const iterator = typewriter[Symbol.iterator]();

      const result0 = iterator.next();
      expect(result0.done).toBe(false);
      expect(result0.value.position).toBe(0);
      expect(result0.value.selected.length).toBe(0);
      expect(result0.value.cursors.length).toBe(0);
      expect(result0.value.character).toBe('j');

      const result1 = iterator.next();
      expect(result1.done).toBe(false);
      expect(result1.value.position).toBe(1);
      expect(result1.value.selected.length).toBe(0);
      expect(result1.value.cursors.length).toBe(0);
      expect(result1.value.character).toBe('o');

      const result2 = iterator.next();
      expect(result2.done).toBe(false);
      expect(result2.value.position).toBe(2);
      expect(result2.value.selected.length).toBe(0);
      expect(result2.value.cursors.length).toBe(1);
      expect(result2.value.cursors[0].data).toBe('tosca');
      expect(result2.value.character).toBe('y');

      const result3 = iterator.next();
      expect(result3.done).toBe(true);
      expect(result3.value).toBe(undefined);
    });
  });

  describe('history', () => {
    test('that a history is kept for a maximum number of events', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
        ],
        keepHistoryFor: 3,
      });

      expect(typewriter.history).toEqual([
        expect.objectContaining({
          type: 'INITIALIZED',
        }),
      ]);

      typewriter.pause();
      expect(typewriter.history).toEqual([
        expect.objectContaining({
          type: 'INITIALIZED',
        }),

        expect.objectContaining({ type: 'PAUSED' }),
      ]);

      typewriter.play();
      expect(typewriter.history).toEqual([
        expect.objectContaining({
          type: 'INITIALIZED',
        }),

        expect.objectContaining({ type: 'PAUSED' }),

        expect.objectContaining({ type: 'PLAYING' }),
      ]);

      typewriter.pause();
      expect(typewriter.history).toEqual([
        expect.objectContaining({ type: 'PAUSED' }),

        expect.objectContaining({ type: 'PLAYING' }),

        expect.objectContaining({ type: 'PAUSED' }),
      ]);
    });

    test('that initialize resets the history', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 100,
            cursor: 0,
          },
        ],
        keepHistoryFor: 5,
      });

      expect(typewriter.history).toEqual([
        expect.objectContaining({
          type: 'INITIALIZED',
        }),
      ]);

      typewriter.pause();

      expect(typewriter.history).toEqual([
        expect.objectContaining({
          type: 'INITIALIZED',
        }),

        expect.objectContaining({ type: 'PAUSED' }),
      ]);

      // Now reset the history, note that if `keepHistoryFor` is zero
      // the `history` array would be empty
      typewriter.initialize({ keepHistoryFor: 1 });
      expect(typewriter.history).toEqual([
        expect.objectContaining({
          type: 'INITIALIZED',
        }),
      ]);
    });
  });

  describe('subscribers', () => {
    test('multiple subscribers', () => {
      const typewriter = new Typewriter<string>({
        actions: [
          {
            type: 'keyboard',
            text: 'a',
            delay: 10000,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'b',
            delay: 10000,
            cursor: 0,
          },
          {
            type: 'keyboard',
            text: 'c',
            delay: 10000,
            cursor: 0,
          },
        ],
      });
      const subscriber = autoSubscribe(typewriter);

      const secondSubscriber = jest.fn();
      const removeSecondSubscriber = typewriter.subscribe(secondSubscriber);

      const thirdSubscriber = jest.fn();
      typewriter.subscribe(thirdSubscriber);

      typewriter.pause();

      expect(subscriber).toHaveBeenCalledTimes(1);
      expect(secondSubscriber).toHaveBeenCalledTimes(1);
      expect(thirdSubscriber).toHaveBeenCalledTimes(1);

      removeSecondSubscriber();

      typewriter.play();

      expect(subscriber).toHaveBeenCalledTimes(2);
      expect(secondSubscriber).toHaveBeenCalledTimes(1);
      expect(thirdSubscriber).toHaveBeenCalledTimes(2);

      typewriter.unsubscribe(thirdSubscriber);

      typewriter.pause();

      expect(subscriber).toHaveBeenCalledTimes(3);
      expect(secondSubscriber).toHaveBeenCalledTimes(1);
      expect(thirdSubscriber).toHaveBeenCalledTimes(2);
    });
  });
});

type TestCursor = TypewriterCursorConfig<string | undefined> & {
  isBlinking: boolean;
  data: string | undefined;
};

type TestState = Pick<
  Typewriter<string | undefined>,
  | 'text'
  | 'history'
  | 'blinkAfter'
  | 'isPlaying'
  | 'isFinished'
  | 'hasBeenStoppedBefore'
  | 'actions'
  | 'lastPerformedAction'
  | 'repeat'
  | 'repeatDelay'
> & {
  cursors: TestCursor[];
};

function assertState(state: Typewriter<any>, expected: TestState) {
  const callAsTestState: TestState = {
    history: state.history,
    text: state.text,
    blinkAfter: state.blinkAfter,
    isPlaying: state.isPlaying,
    isFinished: state.isFinished,
    repeat: state.repeat,
    repeatDelay: state.repeatDelay,
    hasBeenStoppedBefore: state.hasBeenStoppedBefore,
    lastPerformedAction: state.lastPerformedAction,
    actions: state.actions.map((action) => {
      if (action.type === 'keyboard') {
        const copy: TypewriterAction = {
          type: 'keyboard',
          delay: action.delay,
          cursor: action.cursor,
          text: action.text,
        };

        return copy;
      } else {
        const copy: TypewriterAction = {
          type: 'mouse',
          delay: action.delay,
          cursor: action.cursor,
          position: action.position,
          selection: action.selection,
        };

        return copy;
      }
    }),
    cursors: state.cursors.map((cursor) => {
      const copy: TestCursor = {
        position: cursor.position,
        data: cursor.data,
        isBlinking: cursor.isBlinking,
        selection: cursor.selection
          ? {
              start: cursor.selection.start,
              end: cursor.selection.end,
            }
          : undefined,
      };

      return copy;
    }),
  };

  expect(callAsTestState).toEqual(expected);
}

function assertCursor(cursor: TypewriterCursor<any>, expected: TestCursor) {
  const testState: TestCursor = {
    position: cursor.position,
    data: cursor.data,
    isBlinking: cursor.isBlinking,
  };

  expect(testState).toEqual(expected);
}

function assertLastSubscriber(
  subscriber: jest.Mock,
  expectedState: TestState,
  expectedEvent: TypewriterEvent<string>
) {
  const lastCall = subscriber.mock.calls[subscriber.mock.calls.length - 1];
  const state = lastCall[0] as Typewriter<string | undefined>;
  const event = lastCall[1] as TypewriterEvent<string>;

  assertState(state, expectedState);

  const eventCopy = { ...event };
  // @ts-ignore Just delete it
  delete eventCopy.time;

  const expectedEventCopy = { ...expectedEvent };
  // @ts-ignore Just delete it
  delete expectedEventCopy.time;

  expect(eventCopy).toEqual(expectedEventCopy);
}

function assertEvents(
  subscriber: jest.Mock,
  expectedEvents: TypewriterEventType[]
) {
  const events: TypewriterEventType[] = subscriber.mock.calls.map((call) => {
    const event = call[1] as TypewriterEvent<string> ;
    return event.type;
  });

  expect(events).toEqual(expectedEvents);

  expect(subscriber).toBeCalledTimes(expectedEvents.length);
}
